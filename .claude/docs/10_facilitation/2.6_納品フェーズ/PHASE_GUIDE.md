# 2.6 納品フェーズ実行ガイド

**このファイルの目的**: 納品フェーズの実行手順を1ファイルに統合。What（何をやるか）+ How（どうやるか）を提供。

---

## §1 このフェーズでやること（What）

### 1.1 フェーズの目的

**運用可能な状態でシステムを引き渡す**

- すべてのドキュメントを整備
- 本番環境へデプロイ（dry-run必須）
- 運用担当者への引き継ぎ
- プロジェクトの振り返り

### 1.2 インプット（前フェーズからの成果物）

- 実装済みコード（`src/`, `tests/`, `infra/`）
- テスト結果（テストフェーズの成果物）
- 設計書・要件定義書・企画書

### 1.3 アウトプット（このフェーズで生成）

#### ドキュメント類
- `README.md` - プロジェクト概要、セットアップ、使用方法
- `docs/デプロイ手順書.md` - 本番デプロイ手順（dry-run含む）
- `docs/運用手順書.md` - 日次/週次/月次運用、アラート対応
- `docs/トラブルシューティングガイド.md` - よくあるエラーと対処法

#### デプロイ成果物
- 本番環境へのデプロイ完了
- 動作確認完了

#### 引き継ぎ成果物
- 引き継ぎ資料
- プロジェクト振り返りレポート

---

## §2 技術標準参照

### 2.1 必須参照

- **`.claude/docs/40_standards/49_security.md`** - セキュリティ・運用基準
  - dry-run必須
  - 本番環境保護
  - シークレット管理

### 2.2 参照タイミング

- ドキュメント整備時: セキュリティチェック項目確認
- デプロイ時: dry-run手順、ロールバック手順確認
- 運用手順書作成時: 監視・アラート・バックアップ基準確認

---

## §3 PDCA 1周目（納品物の作成）

### 3.1 実行原則

**読者を意識したドキュメント作成**

- 運用担当者目線で具体的に
- コマンド例を含める
- エラー時の対処法を明記

### 3.2 ステップ1: 納品物チェックリスト確認

**ユーザーに質問**:

> 「納品フェーズに入ります。
>
> まず、納品物の確認をしましょう。
> 以下の項目が揃っているか確認させてください。
>
> **ドキュメント類**:
> - README.md は存在しますか？（ない場合は作成します）
> - デプロイ手順書は必要ですか？
> - 運用手順書は誰が使いますか？（あなた自身 or 別の運用担当者）」

**決定事項の記録**:

`.claude-state/delivery-decisions.json` に記録:

```json
{
  "phase": "delivery",
  "deliverables": {
    "readme": "exists|to_create",
    "deploymentGuide": "required|not_required",
    "operationGuide": "required_for_self|required_for_others|not_required",
    "troubleshootingGuide": "required|not_required"
  },
  "updatedAt": "ISO 8601"
}
```

### 3.3 ステップ2: README.md 作成・更新

**参照**: `2.6.4_製造物_README構成/`

**必須セクション**:
1. プロジェクト概要
2. 主要機能
3. 技術スタック
4. システム構成図（Mermaid）
5. セットアップ手順
6. 使用方法
7. テスト実行方法

**作成方法**:

既存のコードから自動生成:
- `package.json` / `requirements.txt` / `go.mod` から技術スタック抽出
- `infra/` から AWS リソース抽出
- `src/` から主要機能抽出

**ユーザー確認**:

> 「README.md のドラフトを作成しました。
>
> [README.md の内容を提示]
>
> - プロジェクト名・説明は合っていますか？
> - セットアップ手順は漏れていませんか？」

**Good Example**:

```markdown
# プロジェクト名

## 概要
このシステムは○○を実現するためのWebアプリケーションです。

## 主要機能
- ユーザー認証（JWT）
- データ管理（PostgreSQL）
- リアルタイム通知（WebSocket）

## 技術スタック
- **バックエンド**: FastAPI (Python 3.11)
- **フロントエンド**: Next.js (TypeScript)
- **インフラ**: AWS (ECS Fargate, RDS, CloudFront)

## システム構成図
\`\`\`mermaid
graph LR
    A[User] --> B[CloudFront]
    B --> C[ALB]
    C --> D[ECS Fargate]
    D --> E[RDS PostgreSQL]
\`\`\`

## セットアップ手順

### 前提条件
- Docker Desktop インストール済み
- Node.js 18+ インストール済み

### 環境構築
\`\`\`bash
# リポジトリクローン
git clone https://github.com/...

# 環境変数設定
cp .env.example .env
# .env を編集（DATABASE_URL, SECRET_KEY 等）

# 依存関係インストール
npm install

# データベースマイグレーション
npm run migrate

# アプリケーション起動
npm run dev
\`\`\`

### アクセス
http://localhost:3000
```

### 3.4 ステップ3: デプロイ手順書作成

**参照**: `2.6.5_製造物_デプロイ手順書/`

**必須セクション**:
1. 前提条件・準備
2. **dry-run実施手順** ⭐必須
3. デプロイ実行手順
4. 動作確認手順
5. ロールバック手順

**技術標準参照**:
- CloudFormation の場合: `.claude/docs/40_standards/45_cloudformation.md`
- Terraform の場合: `.claude/docs/40_standards/46_terraform.md`

**重要**: dry-run を必ず含める

**CloudFormation の例**:

```markdown
## デプロイ手順

### 1. 前提条件
- AWS CLI インストール済み
- AWS認証情報設定済み（`aws configure`）
- 必要な権限（CloudFormation, ECS, RDS 等）

### 2. dry-run実施（Change Set作成）⭐必須

\`\`\`bash
# Change Set 作成
./scripts/create-changeset.sh production

# Change Set 詳細確認
./scripts/describe-changeset.sh production
\`\`\`

**確認ポイント**:
- [ ] 意図しないリソース削除がないか
- [ ] 既存リソースへの影響範囲を確認
- [ ] データベース削除・再作成がないか（データ損失リスク）

### 3. デプロイ実行

dry-run で問題がなければ実行:

\`\`\`bash
# Change Set 実行
./scripts/execute-changeset.sh production
\`\`\`

### 4. 動作確認

\`\`\`bash
# ヘルスチェック
curl https://api.example.com/health

# 期待レスポンス
{"status": "ok"}
\`\`\`

### 5. ロールバック手順

デプロイに失敗した場合:

\`\`\`bash
./scripts/rollback.sh production
\`\`\`
```

**ユーザー確認**:

> 「デプロイ手順書のドラフトを作成しました。
>
> [デプロイ手順書の内容を提示]
>
> - スクリプトファイル（`scripts/`）は存在しますか？
> - ない場合は作成しますか？」

### 3.5 ステップ4: 運用手順書作成（必要な場合）

**参照**: `2.6.6_製造物_運用手順書構成.md`

**ユーザーに質問**:

> 「運用手順書を作成します。
>
> このシステムは誰が運用しますか？
> - あなた自身
> - 別の運用担当者
> - 外部委託」

**運用担当者が別の場合のみ作成**

**必須セクション**:
1. 日次運用（ログ確認、アラート確認）
2. 週次/月次運用（パフォーマンス確認、コスト確認）
3. アラート対応
4. バックアップ・リストア
5. 障害対応フロー

**技術標準参照**:
- `.claude/docs/40_standards/49_security.md` - 監視・アラート基準

### 3.6 ステップ5: トラブルシューティングガイド作成

**参照**: `2.6.7_製造物_トラブルシューティングガイド構成.md`

**必須セクション**:
1. よくあるエラーと対処法
2. ログ確認方法
3. デバッグ手順
4. FAQ

**Example**:

```markdown
## よくあるエラーと対処法

### エラー: `Database connection failed`

**原因**: データベース接続情報が正しくない、またはデータベースが起動していない

**対処法**:
1. 環境変数 `DATABASE_URL` を確認
2. データベースの起動状態を確認
   \`\`\`bash
   docker ps | grep postgres
   \`\`\`
3. データベース接続テスト
   \`\`\`bash
   psql -h localhost -U postgres -d mydb
   \`\`\`

### エラー: `Port 3000 already in use`

**原因**: ポート3000が既に使用されている

**対処法**:
\`\`\`bash
# ポート使用中のプロセス確認
lsof -i :3000

# プロセス停止
kill -9 <PID>
\`\`\`
```

---

## §4 PDCA 2周目（抜け漏れチェック）

### 4.1 納品物の最終確認

**チェックリスト（`2.6.2_納品物チェックリスト.md` 参照）**:

**ドキュメント類**:
- [ ] README.md
- [ ] デプロイ手順書（dry-run含む）
- [ ] 運用手順書（必要な場合）
- [ ] トラブルシューティングガイド

**コード類**:
- [ ] アプリケーションコード（`src/`）
- [ ] テストコード（`tests/`）
- [ ] IaC（`infra/`）
- [ ] CI/CDパイプライン設定（`.github/workflows/`）

**設定ファイル類**:
- [ ] 環境変数テンプレート（`.env.example`）
- [ ] 依存関係定義（`package.json`, `requirements.txt` 等）
- [ ] `.gitignore`（シークレット除外確認）

**セキュリティチェック**:
- [ ] ハードコードされたシークレットがないか
- [ ] 不要なログ・デバッグコードの削除
- [ ] ライセンス表記確認

### 4.2 ユーザーに確認

> 「納品物のチェックリストを確認しました。
>
> 以下のファイルが揃っています：
> - [ファイルリスト]
>
> 抜け漏れはありませんか？
> 追加で必要なドキュメントはありますか？」

---

## §5 本番デプロイ実施

### 5.1 デプロイ前確認

**必須チェック**:
- [ ] dry-run実施済み
- [ ] Change Set / Plan 内容確認済み
- [ ] ロールバック手順確認済み
- [ ] バックアップ取得済み（データベース等）

### 5.2 デプロイ実行

**ユーザーに確認**:

> 「本番環境へのデプロイを実施します。
>
> dry-run の結果:
> [Change Set / Plan の内容を提示]
>
> 問題なければデプロイを実行しますか？」

**実行**:

デプロイ手順書に従って実行:
- CloudFormation: `./scripts/execute-changeset.sh production`
- Terraform: `terraform apply`

### 5.3 動作確認

**ヘルスチェック**:
- API エンドポイントの疎通確認
- フロントエンドの表示確認
- データベース接続確認

**ユーザーに報告**:

> 「本番デプロイが完了しました。
>
> 動作確認結果:
> - [確認項目と結果]
>
> 問題ありませんか？」

---

## §6 引き継ぎプロセス

### 6.1 引き継ぎが必要な場合

**運用担当者が別の場合のみ実施**

**引き継ぎ内容**:
1. システム概要説明
2. 運用手順説明
3. トラブルシューティング説明
4. 質疑応答
5. サポート体制の明示

**引き継ぎ資料**:
- README.md
- デプロイ手順書
- 運用手順書
- トラブルシューティングガイド
- 設計書・要件定義書（必要に応じて）

### 6.2 ユーザー承認取得

**最終確認**:

> 「すべての納品物が揃いました。
>
> 【納品物一覧】
> - [ファイルリスト]
>
> 【本番デプロイ】
> - URL: https://...
> - 動作確認: OK
>
> 納品を完了してよろしいですか？」

**承認取得後、プロジェクト状態を更新**:

`.claude-state/project-state.json`:

```json
{
  "projectName": "...",
  "currentPhase": "delivery",
  "status": "completed",
  "deliveryCompletedAt": "ISO 8601",
  "updatedAt": "ISO 8601"
}
```

---

## §7 プロジェクト振り返り

### 7.1 振り返りの実施

**参照**: `2.6.9_プロジェクト振り返りプロセス.md`

**KPT形式**:

**ユーザーに質問（一問一答）**:

> 「プロジェクトの振り返りをしましょう。
>
> まず、**Keep（良かったこと、続けたいこと）** を教えてください。
> どんなプロセス・技術・やり方が良かったですか？」

→ ユーザー回答待ち

> 「次に、**Problem（問題だったこと、改善したいこと）** を教えてください。
> どんなことが課題でしたか？」

→ ユーザー回答待ち

> 「最後に、**Try（次回試したいこと）** を教えてください。
> 次のプロジェクトで試してみたいことはありますか？」

→ ユーザー回答待ち

### 7.2 振り返り記録

`.claude-state/retrospective.json`:

```json
{
  "projectName": "...",
  "date": "ISO 8601",
  "kpt": {
    "keep": ["良かったこと1", "良かったこと2"],
    "problem": ["問題だったこと1", "問題だったこと2"],
    "try": ["次回試したいこと1", "次回試したいこと2"]
  },
  "improvements": [
    {
      "category": "process|technical_standard|tools",
      "description": "改善内容",
      "priority": "high|medium|low"
    }
  ]
}
```

### 7.3 改善アクション

**技術標準の拡充**:

振り返りで得た知見を技術標準に反映:
- 新しいベストプラクティス → `.claude/docs/40_standards/` に追加
- プロセス改善 → `.claude/docs/10_facilitation/` に反映

**ユーザーに報告**:

> 「振り返りが完了しました。
>
> 【振り返り内容】
> [KPTの内容を提示]
>
> 【改善アクション】
> - [改善項目1]
> - [改善項目2]
>
> これらを次回プロジェクトに活かします。」

---

## §8 フェーズ完了判定

### 8.1 完了条件（`2.6.8_フェーズ完了基準.md` 参照）

**必須完了条件**:
- [ ] README.md 作成完了
- [ ] デプロイ手順書作成完了
- [ ] 運用手順書作成完了（必要な場合）
- [ ] トラブルシューティングガイド作成完了
- [ ] 本番デプロイ完了
- [ ] 動作確認完了
- [ ] 引き継ぎ完了（必要な場合）
- [ ] ユーザー承認取得
- [ ] プロジェクト振り返り完了

### 8.2 フェーズ完了

すべての条件を満たしたら:

> 「🎉 納品フェーズが完了しました！
>
> プロジェクト「[プロジェクト名]」の開発が完了しました。
> お疲れ様でした！
>
> 【成果物】
> - [納品物リスト]
>
> 【本番環境】
> - URL: https://...
>
> ご利用ありがとうございました！」

`.claude-state/project-state.json` を更新:

```json
{
  "projectName": "...",
  "currentPhase": "delivery",
  "status": "completed",
  "completedAt": "ISO 8601",
  "updatedAt": "ISO 8601"
}
```

---

## §9 参照ファイル一覧

このフェーズで参照するファイル:

### 10_facilitation（プロセス定義）
- `2.6.1_フェーズ概要.md` - フェーズの目的・ゴール
- `2.6.2_納品物チェックリスト.md` - 納品物確認リスト
- `2.6.3_ドキュメント整備プロセス.md` - ドキュメント作成の流れ
- `2.6.4_製造物_README構成/` - README 作成ガイド
- `2.6.5_製造物_デプロイ手順書/` - デプロイ手順書作成ガイド
- `2.6.6_製造物_運用手順書構成.md` - 運用手順書作成ガイド
- `2.6.7_製造物_トラブルシューティングガイド構成.md` - トラブルシューティングガイド作成ガイド
- `2.6.8_フェーズ完了基準.md` - 完了条件
- `2.6.9_プロジェクト振り返りプロセス.md` - 振り返り方法

### 40_standards（技術標準）
- `49_security.md` - セキュリティ・運用基準
- `45_cloudformation.md` - CloudFormation 規約（デプロイ自動化）
- `46_terraform.md` - Terraform 規約（デプロイ自動化）

---

**作成日**: 2025-10-24
**最終更新**: 2025-10-24
**作成者**: Claude（AI開発ファシリテーター）
