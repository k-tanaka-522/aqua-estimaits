# 2.4.7 シークレット管理実装

## 目的

シークレット情報（パスワード、APIキー等）を安全に管理します。

---

## 🔐 シークレット管理の原則

### 1. ハードコード禁止 ⭐⭐⭐最重要

**禁止事項**:
- ❌ コード内にパスワードをハードコード
- ❌ `.env` ファイルをGit管理
- ❌ 平文での保存

---

## ✅ シークレット管理パターン

### 1. AWS Secrets Manager ⭐⭐⭐推奨

**Python例**:

```python
import boto3
import json

def get_secret(secret_name):
    client = boto3.client('secretsmanager', region_name='ap-northeast-1')
    response = client.get_secret_value(SecretId=secret_name)
    return json.loads(response['SecretString'])

# 使用例
db_credentials = get_secret('myapp/database')
db_password = db_credentials['password']
```

**TypeScript例**:

```typescript
import { SecretsManagerClient, GetSecretValueCommand } from "@aws-sdk/client-secrets-manager";

async function getSecret(secretName: string): Promise<string> {
  const client = new SecretsManagerClient({ region: "ap-northeast-1" });
  const response = await client.send(new GetSecretValueCommand({ SecretId: secretName }));
  return response.SecretString!;
}

// 使用例
const dbPassword = await getSecret("myapp/database/password");
```

---

### 2. 環境変数 ⭐⭐

**.env.example**:

```bash
# .env.example（Git管理OK）
DATABASE_URL=postgresql://user:password@localhost/db
API_KEY=your-api-key-here
```

**.gitignore**:

```
.env
.env.local
```

**使用例（Python）**:

```python
import os
from dotenv import load_dotenv

load_dotenv()

DATABASE_URL = os.getenv("DATABASE_URL")
if DATABASE_URL is None:
    raise ValueError("DATABASE_URL is not set")
```

---

### 3. Systems Manager Parameter Store ⭐⭐

**Python例**:

```python
import boto3

def get_parameter(parameter_name):
    ssm = boto3.client('ssm', region_name='ap-northeast-1')
    response = ssm.get_parameter(Name=parameter_name, WithDecryption=True)
    return response['Parameter']['Value']

# 使用例
api_key = get_parameter('/myapp/api-key')
```

---

## ❌ Bad Example: ハードコード

```python
# ❌ パスワードをハードコード
DATABASE_URL = "postgresql://user:my-secret-password@localhost/db"

# ❌ APIキーをハードコード
API_KEY = "sk-1234567890abcdef"
```

**問題点**:
- Gitにコミットされる
- シークレットが漏洩
- 変更が困難

---

## ✅ Good Example: Secrets Manager

```python
# ✅ Secrets Managerから取得
import boto3
import json

def get_db_credentials():
    client = boto3.client('secretsmanager')
    response = client.get_secret_value(SecretId='myapp/database')
    return json.loads(response['SecretString'])

credentials = get_db_credentials()
DATABASE_URL = f"postgresql://{credentials['username']}:{credentials['password']}@{credentials['host']}/myapp"
```

**改善点**:
- ✅ Gitにコミットされない
- ✅ 中央管理
- ✅ ローテーション可能

---

## 📝 シークレット管理チェックリスト

1. [ ] コード内にシークレット情報がないか確認
2. [ ] `.env` ファイルが `.gitignore` に追加されているか
3. [ ] `.env.example` を提供しているか
4. [ ] 本番環境では Secrets Manager または Parameter Store を使用
5. [ ] ログにシークレット情報が出力されていないか確認

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
