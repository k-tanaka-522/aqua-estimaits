# 2.4.5.2.5 TypeScriptテストコード生成（Jest）

## 目的

`.claude/docs/40_standards/42_typescript.md` に準拠したJestテストコードを生成します。

---

## 🧪 Jestの基本

### インストール

```bash
npm install --save-dev jest @types/jest ts-jest
```

### 設定（jest.config.js）

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests'],
  testMatch: ['**/*.test.ts'],
  collectCoverageFrom: [
    'src/**/*.ts',
    '!src/**/*.d.ts',
    '!src/index.ts',
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80,
    },
  },
};
```

### 実行

```bash
# すべてのテスト実行
npm test

# カバレッジ付きで実行
npm test -- --coverage

# 特定のテストファイル実行
npm test -- userService.test.ts
```

---

## 📁 テストファイルの配置

```
tests/
├── api/
│   └── routes.test.ts
├── services/
│   └── userService.test.ts
└── utils/
    └── validators.test.ts
```

**命名規則**:
- ✅ テストファイル: `*.test.ts`
- ✅ テスト関数: `test()` または `it()`
- ✅ テストスイート: `describe()`

---

## ✅ テスト作成の原則

### 1. AAA (Arrange-Act-Assert) パターン ⭐⭐⭐

**原則**:
- ✅ **Arrange**: テストデータの準備
- ✅ **Act**: テスト対象の実行
- ✅ **Assert**: 結果の検証

**例**:

```typescript
import { UserService } from '../src/services/userService';
import { User } from '../src/models/user';

describe('UserService', () => {
  describe('getUser', () => {
    test('should return user when user exists', async () => {
      // Arrange: テストデータの準備
      const userId = 1;
      const expectedUser: User = {
        id: 1,
        name: 'Test User',
        email: 'test@example.com',
        createdAt: new Date(),
      };

      // Act: テスト対象の実行
      const userService = new UserService();
      const result = await userService.getUser(userId);

      // Assert: 結果の検証
      expect(result).toEqual(expectedUser);
    });
  });
});
```

---

### 2. モッキング（jest.mock） ⭐⭐⭐

**原則**:
- ✅ 外部依存をモック
- ✅ データベース、HTTP APIはモック
- ✅ ユニットテストは高速に

**例**:

```typescript
import { UserService } from '../src/services/userService';
import { UserRepository } from '../src/repositories/userRepository';
import { User } from '../src/models/user';

// モックの作成
jest.mock('../src/repositories/userRepository');

describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<UserRepository>;

  beforeEach(() => {
    // モックのリセット
    jest.clearAllMocks();

    // モックの設定
    mockUserRepository = new UserRepository() as jest.Mocked<UserRepository>;
    userService = new UserService(mockUserRepository);
  });

  test('should return user when user exists', async () => {
    // Arrange
    const userId = 1;
    const mockUser: User = {
      id: 1,
      name: 'Test User',
      email: 'test@example.com',
      createdAt: new Date(),
    };
    mockUserRepository.findById.mockResolvedValue(mockUser);

    // Act
    const result = await userService.getUser(userId);

    // Assert
    expect(result).toEqual(mockUser);
    expect(mockUserRepository.findById).toHaveBeenCalledWith(userId);
    expect(mockUserRepository.findById).toHaveBeenCalledTimes(1);
  });
});
```

---

### 3. 非同期テスト ⭐⭐⭐

**原則**:
- ✅ `async/await` を使用
- ✅ Promiseが解決されるまで待つ

**例**:

```typescript
describe('UserService', () => {
  test('should get user asynchronously', async () => {
    // Arrange
    const userId = 1;

    // Act
    const result = await userService.getUser(userId);

    // Assert
    expect(result.id).toBe(userId);
  });

  test('should throw error when user not found', async () => {
    // Arrange
    const userId = 999;
    mockUserRepository.findById.mockResolvedValue(null);

    // Act & Assert
    await expect(userService.getUser(userId)).rejects.toThrow('User 999 not found');
  });
});
```

---

## 📋 テストパターン

### パターン1: 正常系テスト

```typescript
import { UserService } from '../src/services/userService';
import { UserRepository } from '../src/repositories/userRepository';
import { User } from '../src/models/user';

jest.mock('../src/repositories/userRepository');

describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<UserRepository>;

  beforeEach(() => {
    mockUserRepository = new UserRepository() as jest.Mocked<UserRepository>;
    userService = new UserService(mockUserRepository);
  });

  test('should return user when user exists', async () => {
    // Arrange
    const mockUser: User = {
      id: 1,
      name: 'John Doe',
      email: 'john@example.com',
      createdAt: new Date(),
    };
    mockUserRepository.findById.mockResolvedValue(mockUser);

    // Act
    const result = await userService.getUser(1);

    // Assert
    expect(result).toEqual(mockUser);
  });
});
```

---

### パターン2: 異常系テスト（例外）

```typescript
describe('UserService', () => {
  test('should throw UserNotFoundError when user does not exist', async () => {
    // Arrange
    mockUserRepository.findById.mockResolvedValue(null);

    // Act & Assert
    await expect(userService.getUser(999)).rejects.toThrow('User 999 not found');
  });

  test('should throw DatabaseError when database fails', async () => {
    // Arrange
    mockUserRepository.findById.mockRejectedValue(new Error('DB Error'));

    // Act & Assert
    await expect(userService.getUser(1)).rejects.toThrow('DB Error');
  });
});
```

---

### パターン3: HTTP APIテスト（Express）

```typescript
import request from 'supertest';
import express from 'express';
import router from '../src/api/routes';

const app = express();
app.use(express.json());
app.use('/api', router);

describe('GET /api/users/:id', () => {
  test('should return user when user exists', async () => {
    // Act
    const response = await request(app).get('/api/users/1');

    // Assert
    expect(response.status).toBe(200);
    expect(response.body).toHaveProperty('id', 1);
    expect(response.body).toHaveProperty('name');
  });

  test('should return 404 when user not found', async () => {
    // Act
    const response = await request(app).get('/api/users/999');

    // Assert
    expect(response.status).toBe(404);
  });
});
```

---

### パターン4: パラメータ化テスト

```typescript
import { validateEmail } from '../src/utils/validators';

describe('validateEmail', () => {
  test.each([
    ['test@example.com', true],
    ['user+tag@example.co.jp', true],
    ['invalid@', false],
    ['@example.com', false],
    ['noatsign.com', false],
  ])('validateEmail(%s) should return %s', (email, expected) => {
    expect(validateEmail(email)).toBe(expected);
  });
});
```

---

## ❌ Bad Example: テストが不適切

```typescript
// ❌ AAAパターンなし
test('get user', async () => {
  const result = await service.getUser(1);
  expect(result.name).toBe('Test');
});

// ❌ モックなし（実際のDBにアクセス）
test('get user from db', async () => {
  const result = await userService.getUser(1);  // ❌ 実DB
  expect(result).toBeTruthy();
});

// ❌ アサーションなし
test('something', async () => {
  await service.doSomething();
  // ❌ アサーションがない
});
```

**問題点**:
- 可読性が低い
- テストが遅い（実DBアクセス）
- 何を検証しているか不明

---

## ✅ Good Example: 適切なテスト

```typescript
import { UserService } from '../src/services/userService';
import { UserRepository } from '../src/repositories/userRepository';
import { User } from '../src/models/user';
import { UserNotFoundError } from '../src/utils/errors';

jest.mock('../src/repositories/userRepository');

describe('UserService', () => {
  let userService: UserService;
  let mockUserRepository: jest.Mocked<UserRepository>;

  beforeEach(() => {
    mockUserRepository = new UserRepository() as jest.Mocked<UserRepository>;
    userService = new UserService(mockUserRepository);
  });

  describe('getUser', () => {
    test('should return user when user exists', async () => {
      // Arrange
      const mockUser: User = {
        id: 1,
        name: 'Test User',
        email: 'test@example.com',
        createdAt: new Date(),
      };
      mockUserRepository.findById.mockResolvedValue(mockUser);

      // Act
      const result = await userService.getUser(1);

      // Assert
      expect(result).toEqual(mockUser);
      expect(mockUserRepository.findById).toHaveBeenCalledWith(1);
    });

    test('should throw UserNotFoundError when user not found', async () => {
      // Arrange
      mockUserRepository.findById.mockResolvedValue(null);

      // Act & Assert
      await expect(userService.getUser(999)).rejects.toThrow(UserNotFoundError);
    });
  });
});
```

**改善点**:
- ✅ AAAパターン
- ✅ モック使用（高速）
- ✅ 正常系・異常系の両方テスト
- ✅ モックの呼び出し検証

---

## 🔍 テストカバレッジ

### カバレッジ測定

```bash
npm test -- --coverage
```

### 目標

- ✅ **カバレッジ80%以上** ⭐⭐⭐

---

## 📝 テスト作成チェックリスト

コード生成時に確認：

1. [ ] AAAパターンで記述
2. [ ] 外部依存をモック
3. [ ] 正常系・異常系の両方テスト
4. [ ] `beforeEach` でモックをリセット
5. [ ] テストカバレッジ80%以上
6. [ ] テストが高速（モック使用）

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
