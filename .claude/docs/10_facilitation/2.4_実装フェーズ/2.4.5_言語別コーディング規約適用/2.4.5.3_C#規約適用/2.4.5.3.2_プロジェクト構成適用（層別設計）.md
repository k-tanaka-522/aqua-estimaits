# 2.4.5.3.2 C#プロジェクト構成適用（層別設計）

## 目的

`.claude/docs/40_standards/43_csharp.md` に準拠したC# .NET Coreプロジェクト構成（Clean Architecture）を実装します。

---

## 📁 標準プロジェクト構成

```
MySolution/
├── MySolution.sln
├── src/
│   ├── MyApp.API/              # Web API層
│   │   ├── Controllers/
│   │   ├── Program.cs
│   │   └── appsettings.json
│   ├── MyApp.Application/      # アプリケーション層
│   │   ├── Services/
│   │   ├── Interfaces/
│   │   └── DTOs/
│   ├── MyApp.Domain/           # ドメイン層
│   │   ├── Entities/
│   │   ├── Interfaces/
│   │   └── Exceptions/
│   └── MyApp.Infrastructure/   # インフラ層
│       ├── Data/
│       ├── Repositories/
│       └── ExternalServices/
└── tests/
    ├── MyApp.UnitTests/
    └── MyApp.IntegrationTests/
```

---

## ✅ 各層の役割

### 1. API層（Web API） ⭐⭐⭐

**責務**:
- HTTPリクエストの受付
- Application層の呼び出し
- レスポンスの返却

**例**:

```csharp
// Controllers/UserController.cs
using Microsoft.AspNetCore.Mvc;
using MyApp.Application.Interfaces;
using MyApp.Application.DTOs;

namespace MyApp.API.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class UserController : ControllerBase
    {
        private readonly IUserService _userService;

        public UserController(IUserService userService)
        {
            _userService = userService;
        }

        [HttpGet("{id}")]
        public async Task<ActionResult<UserDto>> GetUser(int id)
        {
            var user = await _userService.GetUserAsync(id);
            if (user == null)
            {
                return NotFound();
            }
            return Ok(user);
        }
    }
}
```

---

### 2. Application層（Use Cases） ⭐⭐⭐

**責務**:
- ビジネスロジックの実装
- Domain層とInfrastructure層の調整
- DTOの変換

**例**:

```csharp
// Services/UserService.cs
using MyApp.Application.Interfaces;
using MyApp.Application.DTOs;
using MyApp.Domain.Interfaces;

namespace MyApp.Application.Services
{
    public class UserService : IUserService
    {
        private readonly IUserRepository _userRepository;

        public UserService(IUserRepository userRepository)
        {
            _userRepository = userRepository;
        }

        public async Task<UserDto?> GetUserAsync(int id)
        {
            var user = await _userRepository.GetByIdAsync(id);
            if (user == null) return null;

            return new UserDto
            {
                Id = user.Id,
                Name = user.Name,
                Email = user.Email
            };
        }
    }
}
```

---

### 3. Domain層（エンティティ、ビジネスルール） ⭐⭐⭐

**責務**:
- エンティティの定義
- ビジネスルール
- インターフェースの定義

**例**:

```csharp
// Entities/User.cs
namespace MyApp.Domain.Entities
{
    public class User
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public DateTime CreatedAt { get; set; }

        // ビジネスロジック
        public bool IsEmailValid()
        {
            return Email.Contains("@");
        }
    }
}

// Interfaces/IUserRepository.cs
namespace MyApp.Domain.Interfaces
{
    public interface IUserRepository
    {
        Task<User?> GetByIdAsync(int id);
        Task<User> CreateAsync(User user);
    }
}
```

---

### 4. Infrastructure層（DB、外部API） ⭐⭐⭐

**責務**:
- データベースアクセス
- 外部APIアクセス
- Repositoryの実装

**例**:

```csharp
// Repositories/UserRepository.cs
using MyApp.Domain.Entities;
using MyApp.Domain.Interfaces;
using Microsoft.EntityFrameworkCore;

namespace MyApp.Infrastructure.Repositories
{
    public class UserRepository : IUserRepository
    {
        private readonly AppDbContext _context;

        public UserRepository(AppDbContext context)
        {
            _context = context;
        }

        public async Task<User?> GetByIdAsync(int id)
        {
            return await _context.Users.FindAsync(id);
        }

        public async Task<User> CreateAsync(User user)
        {
            _context.Users.Add(user);
            await _context.SaveChangesAsync();
            return user;
        }
    }
}
```

---

## 📦 DI登録（Program.cs）

```csharp
// Program.cs
using MyApp.Application.Interfaces;
using MyApp.Application.Services;
using MyApp.Domain.Interfaces;
using MyApp.Infrastructure.Data;
using MyApp.Infrastructure.Repositories;
using Microsoft.EntityFrameworkCore;

var builder = WebApplication.CreateBuilder(args);

// Add services to the container
builder.Services.AddControllers();

// DI登録
builder.Services.AddDbContext<AppDbContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddScoped<IUserRepository, UserRepository>();
builder.Services.AddScoped<IUserService, UserService>();

var app = builder.Build();

app.MapControllers();
app.Run();
```

---

## ❌ Bad Example: 層別設計なし

```
MyApp/
├── Controllers/
├── Models/
└── Database/
```

**問題点**:
- 層別設計がない
- テストが困難
- 保守性が低い

---

## ✅ Good Example: Clean Architecture

```
MySolution/
├── MyApp.API/          # ✅ Web API層
├── MyApp.Application/  # ✅ Use Cases層
├── MyApp.Domain/       # ✅ ドメイン層
└── MyApp.Infrastructure/ # ✅ インフラ層
```

**改善点**:
- ✅ 層別設計
- ✅ 依存関係が明確
- ✅ テストが容易

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
