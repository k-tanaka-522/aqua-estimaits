# 2.4.5.3.6 C# Good_Bad_Example集

## 目的

C# .NET Core実装のよくある間違いパターンと推奨パターンを示します。

---

## 🔄 実例パターン集

### 1. DI（依存性注入）

#### ❌ Bad Example

```csharp
// ❌ new でインスタンス化
public class UserController : ControllerBase
{
    private readonly UserService _userService = new UserService(new UserRepository());

    [HttpGet("{id}")]
    public async Task<ActionResult<UserDto>> GetUser(int id)
    {
        return Ok(await _userService.GetUserAsync(id));
    }
}
```

**問題点**:
- テストが困難
- モックできない

#### ✅ Good Example

```csharp
// ✅ DIで注入
public class UserController : ControllerBase
{
    private readonly IUserService _userService;

    public UserController(IUserService userService)
    {
        _userService = userService;
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<UserDto>> GetUser(int id)
    {
        var user = await _userService.GetUserAsync(id);
        return user != null ? Ok(user) : NotFound();
    }
}
```

**改善点**:
- ✅ テスト容易
- ✅ モック可能

---

### 2. 非同期処理

#### ❌ Bad Example

```csharp
// ❌ .Result で同期的に待つ（デッドロックのリスク）
public UserDto GetUser(int id)
{
    var user = _userRepository.GetByIdAsync(id).Result;  // ❌ 危険
    return MapToDto(user);
}

// ❌ async voidを使用（コントローラー以外）
public async void ProcessUser(int id)  // ❌ 避ける
{
    await _userRepository.GetByIdAsync(id);
}
```

**問題点**:
- デッドロックのリスク
- 例外処理が困難

#### ✅ Good Example

```csharp
// ✅ async/await を使用
public async Task<UserDto> GetUserAsync(int id)
{
    var user = await _userRepository.GetByIdAsync(id);
    return MapToDto(user);
}

// ✅ async Task を使用
public async Task ProcessUserAsync(int id)
{
    await _userRepository.GetByIdAsync(id);
}
```

**改善点**:
- ✅ デッドロックなし
- ✅ 例外処理が容易

---

### 3. 例外処理

#### ❌ Bad Example

```csharp
// ❌ try-catchなし
public async Task<UserDto> GetUserAsync(int id)
{
    var user = await _userRepository.GetByIdAsync(id);
    return MapToDto(user);
}

// ❌ 汎用的なException
if (user == null)
{
    throw new Exception("Error");  // ❌ 不明瞭
}
```

**問題点**:
- エラー処理がない
- エラーメッセージが不明瞭

#### ✅ Good Example

```csharp
// ✅ カスタム例外 + try-catch
public async Task<UserDto> GetUserAsync(int id)
{
    try
    {
        var user = await _userRepository.GetByIdAsync(id);
        if (user == null)
        {
            _logger.LogWarning("User {UserId} not found", id);
            throw new UserNotFoundException(id);
        }
        return MapToDto(user);
    }
    catch (UserNotFoundException)
    {
        throw;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to get user {UserId}", id);
        throw;
    }
}
```

**改善点**:
- ✅ カスタム例外
- ✅ ログ出力

---

### 4. Null安全性

#### ❌ Bad Example

```csharp
// ❌ nullチェックなし
public string GetUserName(User user)
{
    return user.Name;  // ❌ NullReferenceException
}
```

**問題点**:
- Null参照エラー

#### ✅ Good Example

```csharp
// ✅ nullチェック + Nullable Reference Types
public string? GetUserName(User? user)
{
    return user?.Name;
}

// ✅ Null合体演算子
public string GetUserNameOrDefault(User? user)
{
    return user?.Name ?? "Unknown";
}
```

**改善点**:
- ✅ Null安全

---

### 5. 環境変数・設定管理

#### ❌ Bad Example

```csharp
// ❌ ハードコード
var connectionString = "Server=localhost;Database=mydb;User=admin;Password=secret";
```

**問題点**:
- シークレット漏洩

#### ✅ Good Example

```csharp
// ✅ appsettings.json + 環境変数
// appsettings.json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=mydb"
  }
}

// Program.cs
var connectionString = builder.Configuration.GetConnectionString("DefaultConnection");
```

**改善点**:
- ✅ 環境変数使用
- ✅ シークレット分離

---

### 6. テスト

#### ❌ Bad Example

```csharp
// ❌ モックなし
[Fact]
public async Task TestGetUser()
{
    var service = new UserService(new UserRepository());  // ❌ 実DB
    var result = await service.GetUserAsync(1);
    Assert.NotNull(result);
}
```

**問題点**:
- テストが遅い

#### ✅ Good Example

```csharp
// ✅ モック使用
[Fact]
public async Task GetUserAsync_WhenUserExists_ReturnsUserDto()
{
    // Arrange
    var mockRepo = new Mock<IUserRepository>();
    mockRepo.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(new User { Id = 1, Name = "Test" });
    var service = new UserService(mockRepo.Object);

    // Act
    var result = await service.GetUserAsync(1);

    // Assert
    result.Should().NotBeNull();
}
```

**改善点**:
- ✅ モック使用
- ✅ 高速

---

## 📝 まとめ

### 必ず守るべきこと ⭐⭐⭐

1. **DI**: コンストラクタインジェクション
2. **async/await**: 非同期処理
3. **例外処理**: カスタム例外 + try-catch
4. **Null安全性**: Nullable Reference Types
5. **環境変数**: appsettings.json
6. **テスト**: Moq + xUnit

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
