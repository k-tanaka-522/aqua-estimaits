# 2.4.5.3.4 C#例外処理パターン適用

## 目的

C# .NET Coreで適切な例外処理を実装します。

---

## 🎯 例外処理の原則

### 1. カスタム例外を使用 ⭐⭐⭐

**原則**:
- ✅ ビジネスロジックのエラーはカスタム例外
- ✅ `Exception` を継承
- ✅ 階層構造を持たせる

**例**:

```csharp
// Domain/Exceptions/AppException.cs
namespace MyApp.Domain.Exceptions
{
    public class AppException : Exception
    {
        public AppException(string message) : base(message) { }
    }

    public class UserNotFoundException : AppException
    {
        public int UserId { get; }

        public UserNotFoundException(int userId)
            : base($"User {userId} not found")
        {
            UserId = userId;
        }
    }

    public class InvalidEmailException : AppException
    {
        public InvalidEmailException(string email)
            : base($"Invalid email: {email}")
        {
        }
    }
}
```

---

### 2. try-catch を適切に使用 ⭐⭐⭐

**原則**:
- ✅ 具体的な例外をキャッチ
- ✅ `catch (Exception)` は最後の手段
- ✅ ログを出力
- ✅ 再スロー（re-throw）を検討

**例**:

```csharp
using MyApp.Domain.Exceptions;
using Microsoft.Extensions.Logging;

public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;
    private readonly ILogger<UserService> _logger;

    public UserService(IUserRepository userRepository, ILogger<UserService> logger)
    {
        _userRepository = userRepository;
        _logger = logger;
    }

    public async Task<UserDto> GetUserAsync(int id)
    {
        try
        {
            var user = await _userRepository.GetByIdAsync(id);
            if (user == null)
            {
                _logger.LogWarning("User {UserId} not found", id);
                throw new UserNotFoundException(id);
            }
            return MapToDto(user);
        }
        catch (UserNotFoundException)
        {
            throw;  // ✅ 再スロー
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Failed to get user {UserId}", id);
            throw;
        }
    }
}
```

---

### 3. グローバルエラーハンドリング ⭐⭐⭐

**原則**:
- ✅ ミドルウェアでグローバルにエラー処理
- ✅ ユーザーに適切なレスポンスを返す

**例**:

```csharp
// Middleware/ErrorHandlingMiddleware.cs
using MyApp.Domain.Exceptions;
using System.Net;
using System.Text.Json;

public class ErrorHandlingMiddleware
{
    private readonly RequestDelegate _next;
    private readonly ILogger<ErrorHandlingMiddleware> _logger;

    public ErrorHandlingMiddleware(RequestDelegate next, ILogger<ErrorHandlingMiddleware> logger)
    {
        _next = next;
        _logger = logger;
    }

    public async Task InvokeAsync(HttpContext context)
    {
        try
        {
            await _next(context);
        }
        catch (UserNotFoundException ex)
        {
            _logger.LogWarning(ex, "User not found");
            await HandleExceptionAsync(context, ex, HttpStatusCode.NotFound);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Unhandled exception");
            await HandleExceptionAsync(context, ex, HttpStatusCode.InternalServerError);
        }
    }

    private static async Task HandleExceptionAsync(HttpContext context, Exception exception, HttpStatusCode statusCode)
    {
        context.Response.ContentType = "application/json";
        context.Response.StatusCode = (int)statusCode;

        var response = new
        {
            error = exception.Message,
            statusCode = (int)statusCode
        };

        await context.Response.WriteAsync(JsonSerializer.Serialize(response));
    }
}

// Program.cs
app.UseMiddleware<ErrorHandlingMiddleware>();
```

---

## ❌ Bad Example: 例外処理が不適切

```csharp
// ❌ try-catchなし
public async Task<UserDto> GetUser(int id)
{
    var user = await _userRepository.GetByIdAsync(id);  // ❌ エラー処理なし
    return MapToDto(user);
}

// ❌ 汎用的なException
if (user == null)
{
    throw new Exception("Error");  // ❌ 何のエラーか不明
}

// ❌ 例外を握りつぶす
try
{
    var user = await _userRepository.GetByIdAsync(id);
}
catch (Exception)
{
    // ❌ 何もしない
}
```

**問題点**:
- エラー処理がない
- エラーメッセージが不明瞭
- エラーが握りつぶされる

---

## ✅ Good Example: 適切な例外処理

```csharp
public async Task<UserDto> GetUserAsync(int id)
{
    try
    {
        var user = await _userRepository.GetByIdAsync(id);
        if (user == null)
        {
            _logger.LogWarning("User {UserId} not found", id);
            throw new UserNotFoundException(id);
        }
        return MapToDto(user);
    }
    catch (UserNotFoundException)
    {
        throw;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to get user {UserId}", id);
        throw;
    }
}
```

**改善点**:
- ✅ カスタム例外
- ✅ ログ出力
- ✅ try-catch

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
