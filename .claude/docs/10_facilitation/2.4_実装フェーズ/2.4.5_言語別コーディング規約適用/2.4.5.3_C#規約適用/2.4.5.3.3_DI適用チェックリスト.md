# 2.4.5.3.3 C# DI（依存性注入）適用チェックリスト

## 目的

C# .NET CoreでDI（依存性注入）を正しく適用します。

---

## ✅ DI適用チェックリスト

### 1. インターフェース定義 ⭐⭐⭐

- [ ] すべてのサービスにインターフェースを定義
- [ ] Domain層にインターフェースを配置
- [ ] `I` プレフィックスを使用

**例**:

```csharp
// Domain/Interfaces/IUserRepository.cs
namespace MyApp.Domain.Interfaces
{
    public interface IUserRepository
    {
        Task<User?> GetByIdAsync(int id);
        Task<User> CreateAsync(User user);
    }
}

// Application/Interfaces/IUserService.cs
namespace MyApp.Application.Interfaces
{
    public interface IUserService
    {
        Task<UserDto?> GetUserAsync(int id);
    }
}
```

---

### 2. コンストラクタインジェクション ⭐⭐⭐

- [ ] コンストラクタで依存関係を注入
- [ ] `readonly` フィールドに格納
- [ ] `new` で直接インスタンス化しない

**例**:

```csharp
// ✅ Good Example
public class UserService : IUserService
{
    private readonly IUserRepository _userRepository;

    public UserService(IUserRepository userRepository)
    {
        _userRepository = userRepository;
    }

    public async Task<UserDto?> GetUserAsync(int id)
    {
        var user = await _userRepository.GetByIdAsync(id);
        return user != null ? new UserDto { Id = user.Id, Name = user.Name } : null;
    }
}

// ❌ Bad Example
public class UserService
{
    private readonly UserRepository _userRepository = new UserRepository();  // ❌ new禁止
}
```

---

### 3. サービス登録（Program.cs） ⭐⭐⭐

- [ ] `AddScoped`, `AddTransient`, `AddSingleton` で登録
- [ ] インターフェースと実装をペアで登録

**例**:

```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// ✅ DIコンテナに登録
builder.Services.AddScoped<IUserRepository, UserRepository>();
builder.Services.AddScoped<IUserService, UserService>();
builder.Services.AddSingleton<ILogger, Logger>();  // シングルトン

var app = builder.Build();
```

**ライフタイムの選択**:
- `AddScoped`: HTTPリクエストごとに1インスタンス（推奨）
- `AddTransient`: 毎回新しいインスタンス
- `AddSingleton`: アプリケーション全体で1インスタンス（注意して使用）

---

### 4. Controllerでの使用 ⭐⭐⭐

- [ ] コンストラクタで注入
- [ ] `readonly` フィールドに格納

**例**:

```csharp
[ApiController]
[Route("api/[controller]")]
public class UserController : ControllerBase
{
    private readonly IUserService _userService;

    public UserController(IUserService userService)
    {
        _userService = userService;
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<UserDto>> GetUser(int id)
    {
        var user = await _userService.GetUserAsync(id);
        return user != null ? Ok(user) : NotFound();
    }
}
```

---

## ❌ Bad Example: DIを使わない

```csharp
// ❌ new でインスタンス化
public class UserController : ControllerBase
{
    private readonly UserService _userService = new UserService(new UserRepository());

    [HttpGet("{id}")]
    public async Task<ActionResult<UserDto>> GetUser(int id)
    {
        var user = await _userService.GetUserAsync(id);
        return Ok(user);
    }
}
```

**問題点**:
- テストが困難
- モックできない
- 柔軟性がない

---

## ✅ Good Example: DIを使用

```csharp
// ✅ DIで注入
public class UserController : ControllerBase
{
    private readonly IUserService _userService;

    public UserController(IUserService userService)
    {
        _userService = userService;
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<UserDto>> GetUser(int id)
    {
        var user = await _userService.GetUserAsync(id);
        return user != null ? Ok(user) : NotFound();
    }
}
```

**改善点**:
- ✅ テスト容易（モック可能）
- ✅ 柔軟性向上
- ✅ 依存関係が明確

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
