# 2.4.5.3.5 C#テストコード生成（xUnit）

## 目的

`.claude/docs/40_standards/43_csharp.md` に準拠したxUnitテストコードを生成します。

---

## 🧪 xUnitの基本

### インストール

```bash
dotnet add package xunit
dotnet add package xunit.runner.visualstudio
dotnet add package Moq
dotnet add package FluentAssertions
```

### テストプロジェクト構成

```
tests/
└── MyApp.UnitTests/
    ├── Services/
    │   └── UserServiceTests.cs
    └── Controllers/
        └── UserControllerTests.cs
```

### 実行

```bash
dotnet test
dotnet test /p:CollectCoverage=true
```

---

## ✅ テスト作成の原則

### 1. AAA (Arrange-Act-Assert) パターン ⭐⭐⭐

**例**:

```csharp
using Xunit;
using Moq;
using MyApp.Application.Services;
using MyApp.Domain.Interfaces;
using MyApp.Domain.Entities;

public class UserServiceTests
{
    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUser()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        mockRepo.Setup(repo => repo.GetByIdAsync(1))
            .ReturnsAsync(new User { Id = 1, Name = "Test User", Email = "test@example.com" });

        var service = new UserService(mockRepo.Object);

        // Act
        var result = await service.GetUserAsync(1);

        // Assert
        Assert.NotNull(result);
        Assert.Equal(1, result.Id);
        Assert.Equal("Test User", result.Name);
    }
}
```

---

### 2. Moqによるモッキング ⭐⭐⭐

**例**:

```csharp
using Moq;

public class UserServiceTests
{
    private readonly Mock<IUserRepository> _mockUserRepository;
    private readonly UserService _userService;

    public UserServiceTests()
    {
        _mockUserRepository = new Mock<IUserRepository>();
        _userService = new UserService(_mockUserRepository.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUser()
    {
        // Arrange
        var expectedUser = new User { Id = 1, Name = "Test", Email = "test@example.com" };
        _mockUserRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(expectedUser);

        // Act
        var result = await _userService.GetUserAsync(1);

        // Assert
        Assert.NotNull(result);
        _mockUserRepository.Verify(x => x.GetByIdAsync(1), Times.Once);
    }
}
```

---

### 3. FluentAssertions ⭐⭐

**例**:

```csharp
using FluentAssertions;

[Fact]
public async Task GetUserAsync_WhenUserExists_ReturnsUser()
{
    // Arrange
    var expectedUser = new User { Id = 1, Name = "Test", Email = "test@example.com" };
    _mockUserRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(expectedUser);

    // Act
    var result = await _userService.GetUserAsync(1);

    // Assert
    result.Should().NotBeNull();
    result.Id.Should().Be(1);
    result.Name.Should().Be("Test");
}
```

---

### 4. Theory（パラメータ化テスト）⭐⭐

**例**:

```csharp
[Theory]
[InlineData("test@example.com", true)]
[InlineData("user+tag@example.co.jp", true)]
[InlineData("invalid@", false)]
[InlineData("@example.com", false)]
public void ValidateEmail_ShouldReturnExpectedResult(string email, bool expected)
{
    // Act
    var result = EmailValidator.Validate(email);

    // Assert
    result.Should().Be(expected);
}
```

---

## 📋 テストパターン

### パターン1: 正常系テスト

```csharp
public class UserServiceTests
{
    private readonly Mock<IUserRepository> _mockRepository;
    private readonly UserService _service;

    public UserServiceTests()
    {
        _mockRepository = new Mock<IUserRepository>();
        _service = new UserService(_mockRepository.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUserDto()
    {
        // Arrange
        var user = new User { Id = 1, Name = "John Doe", Email = "john@example.com" };
        _mockRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(user);

        // Act
        var result = await _service.GetUserAsync(1);

        // Assert
        result.Should().NotBeNull();
        result!.Id.Should().Be(1);
        result.Name.Should().Be("John Doe");
    }
}
```

---

### パターン2: 異常系テスト（例外）

```csharp
[Fact]
public async Task GetUserAsync_WhenUserNotFound_ThrowsUserNotFoundException()
{
    // Arrange
    _mockRepository.Setup(x => x.GetByIdAsync(999)).ReturnsAsync((User?)null);

    // Act
    Func<Task> act = async () => await _service.GetUserAsync(999);

    // Assert
    await act.Should().ThrowAsync<UserNotFoundException>();
}
```

---

## ❌ Bad Example: テストが不適切

```csharp
// ❌ AAAパターンなし
[Fact]
public async Task TestGetUser()
{
    var result = await _service.GetUserAsync(1);
    Assert.NotNull(result);
}

// ❌ モックなし
[Fact]
public async Task TestGetUser()
{
    var service = new UserService(new UserRepository());  // ❌ 実DB
    var result = await service.GetUserAsync(1);
    Assert.NotNull(result);
}
```

**問題点**:
- 可読性が低い
- テストが遅い

---

## ✅ Good Example: 適切なテスト

```csharp
public class UserServiceTests
{
    private readonly Mock<IUserRepository> _mockRepository;
    private readonly UserService _service;

    public UserServiceTests()
    {
        _mockRepository = new Mock<IUserRepository>();
        _service = new UserService(_mockRepository.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUserDto()
    {
        // Arrange
        var user = new User { Id = 1, Name = "Test", Email = "test@example.com" };
        _mockRepository.Setup(x => x.GetByIdAsync(1)).ReturnsAsync(user);

        // Act
        var result = await _service.GetUserAsync(1);

        // Assert
        result.Should().NotBeNull();
        result!.Id.Should().Be(1);
        _mockRepository.Verify(x => x.GetByIdAsync(1), Times.Once);
    }
}
```

**改善点**:
- ✅ AAAパターン
- ✅ モック使用
- ✅ Verify で呼び出し検証

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
