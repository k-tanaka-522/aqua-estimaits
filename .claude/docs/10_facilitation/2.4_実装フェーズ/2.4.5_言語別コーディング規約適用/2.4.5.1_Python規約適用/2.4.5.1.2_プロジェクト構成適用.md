# 2.4.5.1.2 Pythonプロジェクト構成適用

## 目的

`.claude/docs/40_standards/41_python.md` に準拠したプロジェクト構成を実装します。

---

## 📁 標準プロジェクト構成

```
myproject/
├── src/
│   ├── __init__.py
│   ├── main.py           # エントリーポイント
│   ├── api/              # APIエンドポイント（FastAPI等）
│   │   ├── __init__.py
│   │   ├── routes.py
│   │   └── dependencies.py
│   ├── models/           # データモデル（Pydantic, SQLAlchemy等）
│   │   ├── __init__.py
│   │   ├── user.py
│   │   └── product.py
│   ├── services/         # ビジネスロジック
│   │   ├── __init__.py
│   │   ├── user_service.py
│   │   └── product_service.py
│   ├── repositories/     # データアクセス層（optional）
│   │   ├── __init__.py
│   │   └── user_repository.py
│   └── utils/            # ユーティリティ
│       ├── __init__.py
│       ├── logger.py
│       └── validators.py
├── tests/
│   ├── __init__.py
│   ├── conftest.py       # pytest共通設定
│   ├── test_api/
│   │   └── test_routes.py
│   └── test_services/
│       └── test_user_service.py
├── infra/                # インフラコード（IaC）
│   ├── cloudformation/
│   └── terraform/
├── .env.example          # 環境変数テンプレート
├── .gitignore
├── pyproject.toml        # パッケージ管理（推奨）
├── requirements.txt      # または requirements.txt
└── README.md
```

---

## ✅ 各ディレクトリの役割

### 1. `src/` - アプリケーションコード

**目的**: すべてのアプリケーションコードをここに集約

**ルール**:
- ✅ 各ディレクトリに `__init__.py` を配置
- ✅ 層別設計を徹底（api, models, services, repositories, utils）
- ✅ ビジネスロジックは `services/` に配置
- ✅ データモデルは `models/` に配置

---

### 2. `src/api/` - APIエンドポイント

**目的**: HTTP APIのエンドポイントを定義

**例**: FastAPI

```python
# src/api/routes.py
from fastapi import APIRouter, Depends
from src.services.user_service import UserService
from src.api.dependencies import get_user_service

router = APIRouter()

@router.get("/users/{user_id}")
async def get_user(
    user_id: int,
    user_service: UserService = Depends(get_user_service)
):
    """ユーザー情報を取得"""
    return await user_service.get_user(user_id)
```

---

### 3. `src/models/` - データモデル

**目的**: データ構造を定義（Pydantic, SQLAlchemy等）

**例**: Pydantic

```python
# src/models/user.py
from pydantic import BaseModel, EmailStr
from typing import Optional

class User(BaseModel):
    """ユーザーモデル"""
    id: int
    name: str
    email: EmailStr
    age: Optional[int] = None
```

---

### 4. `src/services/` - ビジネスロジック ⭐重要

**目的**: ビジネスルールを実装

**原則**:
- ✅ APIエンドポイントから呼び出される
- ✅ データアクセス層（repositories）を使用
- ✅ ビジネスロジックのテストが容易

**例**:

```python
# src/services/user_service.py
from typing import Optional
from src.models.user import User
from src.repositories.user_repository import UserRepository
from src.utils.exceptions import UserNotFoundError
import logging

logger = logging.getLogger(__name__)

class UserService:
    """ユーザー関連のビジネスロジック"""

    def __init__(self, user_repository: UserRepository):
        self.user_repository = user_repository

    async def get_user(self, user_id: int) -> User:
        """
        ユーザー情報を取得する。

        Args:
            user_id (int): ユーザーID

        Returns:
            User: ユーザー情報

        Raises:
            UserNotFoundError: ユーザーが見つからない場合
        """
        user = await self.user_repository.find_by_id(user_id)
        if user is None:
            logger.warning(f"User {user_id} not found")
            raise UserNotFoundError(f"User {user_id} not found")
        return user
```

---

### 5. `src/repositories/` - データアクセス層（optional）

**目的**: データベースアクセスを抽象化

**原則**:
- ✅ SQLAlchemyや他のORMを使用
- ✅ サービス層から呼び出される
- ✅ テスト時にモック可能

**例**:

```python
# src/repositories/user_repository.py
from typing import Optional
from src.models.user import User
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

class UserRepository:
    """ユーザーのデータアクセス層"""

    def __init__(self, session: AsyncSession):
        self.session = session

    async def find_by_id(self, user_id: int) -> Optional[User]:
        """ユーザーIDからユーザーを取得"""
        result = await self.session.execute(
            select(User).where(User.id == user_id)
        )
        return result.scalars().first()
```

---

### 6. `src/utils/` - ユーティリティ

**目的**: 共通機能を提供

**例**:

```python
# src/utils/logger.py
import logging
import sys

def setup_logger(name: str) -> logging.Logger:
    """ロガーを設定する"""
    logger = logging.getLogger(name)
    logger.setLevel(logging.INFO)

    handler = logging.StreamHandler(sys.stdout)
    handler.setLevel(logging.INFO)

    formatter = logging.Formatter(
        '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
    )
    handler.setFormatter(formatter)

    logger.addHandler(handler)
    return logger
```

---

### 7. `tests/` - テストコード

**目的**: ユニットテスト、統合テストを配置

**原則**:
- ✅ `src/` の構造を反映
- ✅ `conftest.py` にpytest共通設定
- ✅ カバレッジ80%以上を目標

**例**:

```python
# tests/test_services/test_user_service.py
import pytest
from unittest.mock import AsyncMock
from src.services.user_service import UserService
from src.models.user import User
from src.utils.exceptions import UserNotFoundError

@pytest.mark.asyncio
async def test_get_user_success():
    """ユーザー取得成功のテスト"""
    # Mock
    mock_repo = AsyncMock()
    mock_repo.find_by_id.return_value = User(
        id=1, name="Test User", email="test@example.com"
    )

    # Execute
    service = UserService(mock_repo)
    user = await service.get_user(1)

    # Assert
    assert user.id == 1
    assert user.name == "Test User"

@pytest.mark.asyncio
async def test_get_user_not_found():
    """ユーザーが見つからない場合のテスト"""
    # Mock
    mock_repo = AsyncMock()
    mock_repo.find_by_id.return_value = None

    # Execute & Assert
    service = UserService(mock_repo)
    with pytest.raises(UserNotFoundError):
        await service.get_user(999)
```

---

## ❌ Bad Example: 構成が不適切

```
myproject/
├── api.py            # ❌ すべて1ファイルに
├── models.py         # ❌ 層別設計なし
├── utils.py
└── test.py           # ❌ テストが1ファイル
```

**問題点**:
- 層別設計がない → 保守性が低い
- ファイルが肥大化 → 可読性が低い
- テストが不十分

---

## ✅ Good Example: 技術標準に準拠

```
myproject/
├── src/
│   ├── api/
│   ├── models/
│   ├── services/      # ✅ ビジネスロジック分離
│   ├── repositories/  # ✅ データアクセス層分離
│   └── utils/
└── tests/
    ├── test_api/
    ├── test_services/  # ✅ サービス層のテスト
    └── test_repositories/
```

**改善点**:
- ✅ 層別設計
- ✅ 責務が明確
- ✅ テストが容易

---

## 📦 パッケージ管理

### pyproject.toml（推奨） ⭐

```toml
[tool.poetry]
name = "myproject"
version = "0.1.0"
description = "プロジェクト説明"
authors = ["Your Name <you@example.com>"]

[tool.poetry.dependencies]
python = "^3.11"
fastapi = "^0.104.0"
pydantic = "^2.4.0"
sqlalchemy = "^2.0.0"

[tool.poetry.dev-dependencies]
pytest = "^7.4.0"
pytest-asyncio = "^0.21.0"
pytest-cov = "^4.1.0"

[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
