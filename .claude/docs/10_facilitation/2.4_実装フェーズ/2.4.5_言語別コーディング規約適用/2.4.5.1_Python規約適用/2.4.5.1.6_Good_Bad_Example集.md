# 2.4.5.1.6 Python Good_Bad_Example集

## 目的

Python実装のよくある間違いパターンと推奨パターンを示します。

---

## 🔄 実例パターン集

### 1. 型ヒント

#### ❌ Bad Example

```python
# ❌ 型ヒントなし
def get_user(user_id):
    return db.query(user_id)

# ❌ 戻り値の型が不明
def process_data(data):
    result = do_something(data)
    return result
```

**問題点**:
- エディタの補完が効かない
- 型チェックができない
- 可読性が低い

#### ✅ Good Example

```python
from typing import Optional
from src.models.user import User

# ✅ 型ヒント完備
def get_user(user_id: int) -> Optional[User]:
    """ユーザーIDからユーザーを取得"""
    return db.query(User).filter(User.id == user_id).first()

# ✅ 戻り値の型が明確
def process_data(data: list[dict]) -> dict[str, int]:
    """データを処理して集計結果を返す"""
    result = {key: count_values(data, key) for key in data[0].keys()}
    return result
```

**改善点**:
- ✅ 型ヒントにより可読性向上
- ✅ エディタの補完が効く
- ✅ mypyで型チェック可能

---

### 2. エラーハンドリング

#### ❌ Bad Example

```python
# ❌ 汎用的なExceptionをキャッチ
try:
    user = db.query(User).first()
except Exception:
    pass  # ❌ 何もしない

# ❌ ログなし
def get_user(user_id):
    try:
        return db.query(User).get(user_id)
    except:  # ❌ bare except
        return None

# ❌ エラーメッセージが不明瞭
if user is None:
    raise Exception("Error")  # ❌ 何のエラーか不明
```

**問題点**:
- エラーが握りつぶされる
- デバッグが困難
- エラーの原因が不明

#### ✅ Good Example

```python
from src.utils.exceptions import UserNotFoundError, DatabaseError
import logging

logger = logging.getLogger(__name__)

# ✅ カスタム例外を使用
async def get_user(user_id: int) -> User:
    """
    ユーザーを取得。

    Raises:
        UserNotFoundError: ユーザーが見つからない場合
        DatabaseError: データベースエラーの場合
    """
    try:
        user = await db.query(User).filter(User.id == user_id).first()
        if user is None:
            logger.warning(f"User {user_id} not found")
            raise UserNotFoundError(f"User {user_id} not found")
        return user
    except SQLAlchemyError as e:
        logger.error(f"Database error: {e}")
        raise DatabaseError(f"Failed to get user {user_id}") from e
```

**改善点**:
- ✅ カスタム例外で意図が明確
- ✅ ログ出力
- ✅ 具体的な例外をキャッチ

---

### 3. docstring

#### ❌ Bad Example

```python
# ❌ docstringなし
def get_user(user_id):
    return db.query(User).get(user_id)

# ❌ 不十分なdocstring
def process_data(data):
    """データを処理"""
    # 何をどう処理するのか不明
    pass
```

**問題点**:
- 関数の目的が不明
- 引数・戻り値の説明がない
- エラーパターンが不明

#### ✅ Good Example

```python
from typing import Optional
from src.models.user import User

def get_user(user_id: int) -> Optional[User]:
    """
    ユーザーIDからユーザー情報を取得する。

    Args:
        user_id (int): ユーザーID

    Returns:
        Optional[User]: ユーザー情報。存在しない場合はNone

    Raises:
        DatabaseError: データベースエラーの場合

    Example:
        >>> user = get_user(1)
        >>> print(user.name)
        "John Doe"
    """
    return db.query(User).filter(User.id == user_id).first()
```

**改善点**:
- ✅ Google Style docstring
- ✅ Args, Returns, Raisesが明確
- ✅ 使用例を記載

---

### 4. プロジェクト構成

#### ❌ Bad Example

```
myproject/
├── api.py            # ❌ すべて1ファイル
├── models.py
└── test.py
```

**問題点**:
- ファイルが肥大化
- 層別設計がない
- 保守性が低い

#### ✅ Good Example

```
myproject/
├── src/
│   ├── api/          # ✅ APIエンドポイント分離
│   │   └── routes.py
│   ├── models/       # ✅ データモデル分離
│   │   └── user.py
│   ├── services/     # ✅ ビジネスロジック分離
│   │   └── user_service.py
│   └── repositories/ # ✅ データアクセス層分離
│       └── user_repository.py
└── tests/
    ├── test_api/
    └── test_services/
```

**改善点**:
- ✅ 層別設計
- ✅ 責務が明確
- ✅ テストが容易

---

### 5. 非同期処理

#### ❌ Bad Example

```python
# ❌ 同期処理を非同期関数で呼び出し
async def get_user(user_id):
    user = db.query(User).get(user_id)  # ❌ 同期処理
    return user

# ❌ awaitし忘れ
async def process_users():
    users = get_all_users()  # ❌ awaitがない
    for user in users:
        print(user.name)
```

**問題点**:
- 非同期の恩恵を受けられない
- awaitし忘れでバグ

#### ✅ Good Example

```python
# ✅ 非同期処理を正しく使用
async def get_user(user_id: int) -> Optional[User]:
    """非同期でユーザーを取得"""
    async with async_session() as session:
        result = await session.execute(
            select(User).where(User.id == user_id)
        )
        return result.scalars().first()

# ✅ awaitを使用
async def process_users():
    users = await get_all_users()  # ✅ awaitを使用
    for user in users:
        print(user.name)
```

**改善点**:
- ✅ 非同期ライブラリを使用
- ✅ awaitを忘れずに使用

---

### 6. 依存性注入

#### ❌ Bad Example

```python
# ❌ ハードコードされた依存関係
class UserService:
    def __init__(self):
        self.repository = UserRepository()  # ❌ ハードコード

    async def get_user(self, user_id: int):
        return await self.repository.find_by_id(user_id)
```

**問題点**:
- テストが困難
- モックできない
- 柔軟性がない

#### ✅ Good Example

```python
# ✅ 依存性注入を使用
class UserService:
    def __init__(self, repository: UserRepository):
        self.repository = repository  # ✅ 外部から注入

    async def get_user(self, user_id: int) -> Optional[User]:
        return await self.repository.find_by_id(user_id)

# テスト時にモックを注入可能
mock_repo = AsyncMock(spec=UserRepository)
service = UserService(mock_repo)
```

**改善点**:
- ✅ テスト容易
- ✅ モック可能
- ✅ 柔軟性向上

---

### 7. 環境変数・シークレット管理

#### ❌ Bad Example

```python
# ❌ ハードコード
DATABASE_URL = "postgresql://user:password@localhost/db"

# ❌ .envファイルをコミット
# .env
DATABASE_URL=postgresql://user:password@localhost/db  # ❌ Git管理
```

**問題点**:
- シークレットが漏洩
- 環境ごとに変更が必要

#### ✅ Good Example

```python
# ✅ 環境変数を使用
import os
from dotenv import load_dotenv

load_dotenv()

DATABASE_URL = os.getenv("DATABASE_URL")
if DATABASE_URL is None:
    raise ValueError("DATABASE_URL is not set")

# ✅ .gitignore に .env を追加
# .gitignore
.env          # ✅ Git管理しない
.env.local

# ✅ .env.example を提供
# .env.example
DATABASE_URL=postgresql://user:password@localhost/db
```

**改善点**:
- ✅ 環境変数を使用
- ✅ .envをGit管理しない
- ✅ .env.exampleで雛形提供

---

### 8. テスト

#### ❌ Bad Example

```python
# ❌ AAAパターンなし
def test_get_user():
    result = service.get_user(1)
    assert result.name == "Test"

# ❌ モックなし（実際のDBにアクセス）
def test_get_user_from_db():
    result = UserService().get_user(1)  # ❌ 実DB
    assert result is not None
```

**問題点**:
- 可読性が低い
- テストが遅い

#### ✅ Good Example

```python
import pytest
from unittest.mock import AsyncMock

@pytest.mark.asyncio
async def test_get_user_success():
    """ユーザー取得成功のテスト"""
    # Arrange: モックの準備
    mock_repo = AsyncMock()
    mock_repo.find_by_id.return_value = User(
        id=1, name="Test User", email="test@example.com"
    )

    # Act: サービスの実行
    service = UserService(mock_repo)
    result = await service.get_user(1)

    # Assert: 結果の検証
    assert result.id == 1
    assert result.name == "Test User"
```

**改善点**:
- ✅ AAAパターン
- ✅ モック使用（高速）

---

## 📝 まとめ

### 必ず守るべきこと ⭐⭐⭐

1. **型ヒント**: すべての関数に型ヒント
2. **カスタム例外**: ビジネスロジックのエラーはカスタム例外
3. **docstring**: Google Style docstring
4. **層別設計**: api, models, services, repositories
5. **環境変数**: シークレットはハードコードしない
6. **テスト**: AAAパターン、モック使用、カバレッジ80%以上

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
