# 2.4.5.1.5 Pythonテストコード生成（pytest）

## 目的

`.claude/docs/40_standards/41_python.md` に準拠したpytestテストコードを生成します。

---

## 🧪 pytestの基本

### インストール

```bash
pip install pytest pytest-asyncio pytest-cov
```

### 実行

```bash
# すべてのテスト実行
pytest

# カバレッジ付きで実行
pytest --cov=src --cov-report=html

# 特定のテストファイル実行
pytest tests/test_services/test_user_service.py
```

---

## 📁 テストファイルの配置

```
tests/
├── __init__.py
├── conftest.py           # pytest共通設定
├── test_api/
│   ├── __init__.py
│   └── test_routes.py
├── test_services/
│   ├── __init__.py
│   └── test_user_service.py
└── test_repositories/
    ├── __init__.py
    └── test_user_repository.py
```

**命名規則**:
- ✅ テストファイル: `test_*.py` または `*_test.py`
- ✅ テスト関数: `test_*`
- ✅ テストクラス: `Test*`

---

## ✅ テスト作成の原則

### 1. AAA (Arrange-Act-Assert) パターン ⭐⭐⭐

**原則**:
- ✅ **Arrange**: テストデータの準備
- ✅ **Act**: テスト対象の実行
- ✅ **Assert**: 結果の検証

**例**:

```python
import pytest
from src.services.user_service import UserService
from src.models.user import User

@pytest.mark.asyncio
async def test_get_user_success():
    """ユーザー取得成功のテスト"""
    # Arrange: テストデータの準備
    user_id = 1
    expected_user = User(id=1, name="Test User", email="test@example.com")

    # Act: テスト対象の実行
    service = UserService()
    result = await service.get_user(user_id)

    # Assert: 結果の検証
    assert result.id == expected_user.id
    assert result.name == expected_user.name
```

---

### 2. モッキング（unittest.mock） ⭐⭐⭐

**原則**:
- ✅ 外部依存をモック
- ✅ データベース、HTTP APIはモック
- ✅ ユニットテストは高速に

**例**:

```python
import pytest
from unittest.mock import AsyncMock, MagicMock
from src.services.user_service import UserService
from src.repositories.user_repository import UserRepository
from src.models.user import User

@pytest.mark.asyncio
async def test_get_user_with_mock():
    """モックを使ったユーザー取得テスト"""
    # Arrange: Mockの作成
    mock_repo = AsyncMock(spec=UserRepository)
    mock_repo.find_by_id.return_value = User(
        id=1, name="Mock User", email="mock@example.com"
    )

    # Act
    service = UserService(mock_repo)
    result = await service.get_user(1)

    # Assert
    assert result.name == "Mock User"
    mock_repo.find_by_id.assert_called_once_with(1)
```

---

### 3. フィクスチャ（conftest.py） ⭐⭐

**原則**:
- ✅ 共通のテストデータはフィクスチャで定義
- ✅ `conftest.py` に記述

**例**:

```python
# tests/conftest.py
import pytest
from unittest.mock import AsyncMock
from src.repositories.user_repository import UserRepository
from src.models.user import User

@pytest.fixture
def mock_user_repo():
    """UserRepositoryのモック"""
    mock = AsyncMock(spec=UserRepository)
    return mock

@pytest.fixture
def sample_user():
    """サンプルユーザー"""
    return User(id=1, name="Test User", email="test@example.com")

# tests/test_services/test_user_service.py
import pytest
from src.services.user_service import UserService

@pytest.mark.asyncio
async def test_get_user(mock_user_repo, sample_user):
    """フィクスチャを使ったテスト"""
    # Arrange
    mock_user_repo.find_by_id.return_value = sample_user

    # Act
    service = UserService(mock_user_repo)
    result = await service.get_user(1)

    # Assert
    assert result == sample_user
```

---

### 4. パラメータ化テスト ⭐⭐

**原則**:
- ✅ 複数の入力パターンを1つのテストで検証
- ✅ `@pytest.mark.parametrize` を使用

**例**:

```python
import pytest
from src.utils.validators import validate_email

@pytest.mark.parametrize("email,expected", [
    ("test@example.com", True),
    ("user+tag@example.co.jp", True),
    ("invalid@", False),
    ("@example.com", False),
    ("noatsign.com", False),
])
def test_validate_email(email, expected):
    """メールアドレス検証のパラメータ化テスト"""
    assert validate_email(email) == expected
```

---

## 📋 テストパターン

### パターン1: 正常系テスト

```python
import pytest
from src.services.user_service import UserService
from src.models.user import User

@pytest.mark.asyncio
async def test_get_user_success(mock_user_repo, sample_user):
    """ユーザー取得成功のテスト"""
    # Arrange
    mock_user_repo.find_by_id.return_value = sample_user

    # Act
    service = UserService(mock_user_repo)
    result = await service.get_user(1)

    # Assert
    assert result.id == 1
    assert result.name == "Test User"
    assert result.email == "test@example.com"
```

---

### パターン2: 異常系テスト（例外）

```python
import pytest
from src.services.user_service import UserService
from src.utils.exceptions import UserNotFoundError

@pytest.mark.asyncio
async def test_get_user_not_found(mock_user_repo):
    """ユーザーが見つからない場合のテスト"""
    # Arrange
    mock_user_repo.find_by_id.return_value = None

    # Act & Assert
    service = UserService(mock_user_repo)
    with pytest.raises(UserNotFoundError):
        await service.get_user(999)
```

---

### パターン3: HTTP APIテスト（FastAPI）

```python
import pytest
from httpx import AsyncClient
from src.main import app

@pytest.mark.asyncio
async def test_get_user_api_success():
    """ユーザー取得API成功のテスト"""
    # Arrange
    async with AsyncClient(app=app, base_url="http://test") as client:
        # Act
        response = await client.get("/users/1")

        # Assert
        assert response.status_code == 200
        data = response.json()
        assert data["id"] == 1
        assert "name" in data

@pytest.mark.asyncio
async def test_get_user_api_not_found():
    """ユーザー取得API失敗のテスト"""
    async with AsyncClient(app=app, base_url="http://test") as client:
        response = await client.get("/users/999")
        assert response.status_code == 404
```

---

### パターン4: データベーステスト（統合テスト）

```python
import pytest
from sqlalchemy.ext.asyncio import create_async_engine, AsyncSession
from src.repositories.user_repository import UserRepository
from src.models.user import User

@pytest.fixture
async def test_db():
    """テスト用データベース"""
    engine = create_async_engine("sqlite+aiosqlite:///:memory:")
    # テーブル作成
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
    yield engine
    await engine.dispose()

@pytest.mark.asyncio
async def test_user_repository_find_by_id(test_db):
    """UserRepository統合テスト"""
    # Arrange
    async with AsyncSession(test_db) as session:
        user = User(id=1, name="Test", email="test@example.com")
        session.add(user)
        await session.commit()

        # Act
        repo = UserRepository(session)
        result = await repo.find_by_id(1)

        # Assert
        assert result.id == 1
        assert result.name == "Test"
```

---

## ❌ Bad Example: テストが不適切

```python
# ❌ AAAパターンなし
def test_get_user():
    result = service.get_user(1)
    assert result.name == "Test"

# ❌ モックなし（実際のDBにアクセス）
def test_get_user_from_db():
    result = UserService().get_user(1)  # ❌ 実DB
    assert result is not None

# ❌ アサーションなし
def test_something():
    result = service.do_something()
    # ❌ アサーションがない
```

**問題点**:
- 可読性が低い
- テストが遅い（実DBアクセス）
- 何を検証しているか不明

---

## ✅ Good Example: 適切なテスト

```python
import pytest
from unittest.mock import AsyncMock
from src.services.user_service import UserService
from src.repositories.user_repository import UserRepository
from src.models.user import User
from src.utils.exceptions import UserNotFoundError

@pytest.mark.asyncio
async def test_get_user_success():
    """ユーザー取得成功のテスト"""
    # Arrange: モックの準備
    mock_repo = AsyncMock(spec=UserRepository)
    mock_repo.find_by_id.return_value = User(
        id=1, name="Test User", email="test@example.com"
    )

    # Act: サービスの実行
    service = UserService(mock_repo)
    result = await service.get_user(1)

    # Assert: 結果の検証
    assert result.id == 1
    assert result.name == "Test User"
    assert result.email == "test@example.com"
    mock_repo.find_by_id.assert_called_once_with(1)

@pytest.mark.asyncio
async def test_get_user_not_found():
    """ユーザーが見つからない場合のテスト"""
    # Arrange
    mock_repo = AsyncMock(spec=UserRepository)
    mock_repo.find_by_id.return_value = None

    # Act & Assert
    service = UserService(mock_repo)
    with pytest.raises(UserNotFoundError):
        await service.get_user(999)
```

**改善点**:
- ✅ AAAパターン
- ✅ モック使用（高速）
- ✅ 正常系・異常系の両方テスト
- ✅ モックの呼び出し検証

---

## 🔍 テストカバレッジ

### カバレッジ測定

```bash
pytest --cov=src --cov-report=html
```

### カバレッジレポート確認

```bash
open htmlcov/index.html
```

### 目標

- ✅ **カバレッジ80%以上** ⭐⭐⭐

---

## 📝 テスト作成チェックリスト

コード生成時に確認：

1. [ ] AAAパターンで記述
2. [ ] 外部依存をモック
3. [ ] 正常系・異常系の両方テスト
4. [ ] フィクスチャを活用
5. [ ] テストカバレッジ80%以上
6. [ ] テストが高速（モック使用）

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
