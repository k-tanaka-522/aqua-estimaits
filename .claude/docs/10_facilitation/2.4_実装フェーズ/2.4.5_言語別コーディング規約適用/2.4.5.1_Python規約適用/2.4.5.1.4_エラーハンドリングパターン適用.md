# 2.4.5.1.4 Pythonエラーハンドリングパターン適用

## 目的

`.claude/docs/40_standards/41_python.md` に準拠したエラーハンドリングを実装します。

---

## 🎯 エラーハンドリングの原則

### 1. カスタム例外を使用 ⭐⭐⭐最重要

**原則**:
- ✅ ビジネスロジックのエラーはカスタム例外
- ✅ 汎用的な `Exception` は使わない
- ✅ 階層構造を持たせる

**例**:

```python
# src/utils/exceptions.py
class AppException(Exception):
    """アプリケーション全体の基底例外"""
    pass

class UserNotFoundError(AppException):
    """ユーザーが見つからない"""
    pass

class InvalidEmailError(AppException):
    """メールアドレスが無効"""
    pass

class DatabaseError(AppException):
    """データベースエラー"""
    pass
```

---

### 2. try-except を適切に使用 ⭐⭐⭐

**原則**:
- ✅ 具体的な例外をキャッチ
- ✅ `except Exception` は最後の手段
- ✅ ログを出力
- ✅ 再送出（re-raise）を検討

**例**:

```python
from src.utils.exceptions import UserNotFoundError, DatabaseError
import logging

logger = logging.getLogger(__name__)

async def get_user(user_id: int) -> User:
    """
    ユーザーを取得。

    Args:
        user_id (int): ユーザーID

    Returns:
        User: ユーザー情報

    Raises:
        UserNotFoundError: ユーザーが見つからない場合
        DatabaseError: データベースエラーの場合
    """
    try:
        user = await db.query(User).filter(User.id == user_id).first()
        if user is None:
            raise UserNotFoundError(f"User {user_id} not found")
        return user
    except SQLAlchemyError as e:
        logger.error(f"Database error: {e}")
        raise DatabaseError(f"Failed to get user {user_id}") from e
    except Exception as e:
        logger.error(f"Unexpected error: {e}")
        raise
```

---

### 3. ログ出力 ⭐⭐⭐必須

**原則**:
- ✅ エラー発生時は必ずログ出力
- ✅ `logger.error()` または `logger.exception()`
- ✅ スタックトレースを含める

**例**:

```python
import logging

logger = logging.getLogger(__name__)

try:
    result = risky_operation()
except ValueError as e:
    logger.error(f"Value error occurred: {e}")
    raise
except Exception as e:
    logger.exception("Unexpected error occurred")  # ✅ スタックトレース含む
    raise
```

---

### 4. エラーメッセージの明確化 ⭐⭐

**原則**:
- ✅ エラーメッセージに文脈情報を含める
- ✅ ユーザーに見せるメッセージと内部ログを分ける

**例**:

```python
class UserNotFoundError(AppException):
    """ユーザーが見つからない"""

    def __init__(self, user_id: int):
        self.user_id = user_id
        # ✅ 詳細な内部メッセージ
        super().__init__(f"User with ID {user_id} not found in database")

    def user_message(self) -> str:
        """ユーザー向けメッセージ"""
        # ✅ ユーザーに見せる簡潔なメッセージ
        return "ユーザーが見つかりません"
```

---

## 📋 エラーハンドリングパターン

### パターン1: 基本的なtry-except

```python
from typing import Optional
from src.utils.exceptions import UserNotFoundError
import logging

logger = logging.getLogger(__name__)

def get_user(user_id: int) -> Optional[User]:
    """ユーザーを取得"""
    try:
        user = db.query(User).filter(User.id == user_id).first()
        if user is None:
            raise UserNotFoundError(user_id)
        return user
    except UserNotFoundError:
        logger.warning(f"User {user_id} not found")
        raise
    except Exception as e:
        logger.exception(f"Unexpected error: {e}")
        raise
```

---

### パターン2: リトライ付きエラーハンドリング

```python
import asyncio
from typing import Optional
import logging

logger = logging.getLogger(__name__)

async def fetch_data_with_retry(
    url: str,
    max_retries: int = 3
) -> Optional[dict]:
    """リトライ付きでデータ取得"""
    for attempt in range(max_retries):
        try:
            response = await http_client.get(url)
            return response.json()
        except TimeoutError as e:
            logger.warning(f"Timeout (attempt {attempt + 1}/{max_retries}): {e}")
            if attempt == max_retries - 1:
                raise
            await asyncio.sleep(2 ** attempt)  # Exponential backoff
        except Exception as e:
            logger.error(f"Unexpected error: {e}")
            raise
```

---

### パターン3: コンテキストマネージャでのエラーハンドリング

```python
from contextlib import asynccontextmanager
from typing import AsyncGenerator
import logging

logger = logging.getLogger(__name__)

@asynccontextmanager
async def database_session() -> AsyncGenerator[AsyncSession, None]:
    """データベースセッションを管理"""
    session = AsyncSession()
    try:
        yield session
        await session.commit()
    except Exception as e:
        logger.error(f"Database error, rolling back: {e}")
        await session.rollback()
        raise
    finally:
        await session.close()

# 使用例
async with database_session() as session:
    user = await session.query(User).first()
```

---

### パターン4: FastAPIでのエラーハンドリング

```python
from fastapi import FastAPI, HTTPException
from src.utils.exceptions import UserNotFoundError

app = FastAPI()

@app.exception_handler(UserNotFoundError)
async def user_not_found_handler(request, exc: UserNotFoundError):
    """ユーザーが見つからない場合のハンドラー"""
    logger.warning(f"User not found: {exc.user_id}")
    raise HTTPException(
        status_code=404,
        detail=exc.user_message()
    )

@app.get("/users/{user_id}")
async def get_user(user_id: int):
    """ユーザー取得API"""
    # UserNotFoundErrorが発生すると自動的に404を返す
    return await user_service.get_user(user_id)
```

---

## ❌ Bad Example: エラーハンドリング不適切

```python
# ❌ 汎用的なExceptionをキャッチ
try:
    user = db.query(User).first()
except Exception:
    pass  # ❌ 何もしない

# ❌ ログなし
try:
    user = db.query(User).first()
except ValueError:
    return None  # ❌ ログがない

# ❌ エラーメッセージが不明瞭
raise Exception("Error")  # ❌ 何のエラーか不明
```

**問題点**:
- エラーが握りつぶされる
- デバッグが困難
- エラーの原因が不明

---

## ✅ Good Example: 適切なエラーハンドリング

```python
from src.utils.exceptions import UserNotFoundError, DatabaseError
import logging

logger = logging.getLogger(__name__)

async def get_user(user_id: int) -> User:
    """
    ユーザーを取得。

    Args:
        user_id (int): ユーザーID

    Returns:
        User: ユーザー情報

    Raises:
        UserNotFoundError: ユーザーが見つからない場合
        DatabaseError: データベースエラーの場合
    """
    try:
        user = await db.query(User).filter(User.id == user_id).first()
        if user is None:
            logger.warning(f"User {user_id} not found")
            raise UserNotFoundError(user_id)
        return user
    except SQLAlchemyError as e:
        logger.error(f"Database error when getting user {user_id}: {e}")
        raise DatabaseError(f"Failed to get user {user_id}") from e
    except Exception as e:
        logger.exception(f"Unexpected error when getting user {user_id}")
        raise
```

**改善点**:
- ✅ カスタム例外を使用
- ✅ 具体的な例外をキャッチ
- ✅ ログ出力
- ✅ エラーメッセージが明確
- ✅ docstringにRaisesセクション

---

## 🔍 エラーハンドリングチェックリスト

コード生成前に確認：

1. [ ] カスタム例外クラスを定義
2. [ ] 具体的な例外をキャッチ（`except Exception` は最後の手段）
3. [ ] エラー発生時にログ出力
4. [ ] エラーメッセージに文脈情報を含める
5. [ ] docstringにRaisesセクションを記載
6. [ ] 必要に応じてリトライロジックを実装

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
