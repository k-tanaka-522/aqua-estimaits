# 2.4.6.1.2 CloudFormationスタック設計パターン選定

## 目的

CloudFormation のファイル分割パターンを選定します。

**重要**: 機械的なパターン適用ではなく、**3原則に基づいて判断**します。

---

## 📏 ファイル分割の3原則

CloudFormation のファイル分割は、以下の3原則に基づいて判断します：

### 原則1: AWS コンソールの分け方（基本）

**AWS コンソールで別メニュー → 別ファイル**

| AWS コンソールの操作 | ファイル分割 |
|------------------|-----------|
| VPC と Subnets | 別ファイル（別メニュー） |
| VPC と Internet Gateway | 同じファイル（VPC作成時に一緒に作る） |
| ALB と Target Group | 同じファイル（ALB配下で一緒に操作） |
| ECS Cluster と ECS Service | 別ファイル（別メニュー） |

### 原則2: ライフサイクル（変更頻度）

**初回のみ作成 vs 頻繁に変更 → 分ける**

| 更新頻度 | リソース例 | 分離推奨 |
|---------|----------|--------|
| 年単位 | VPC, Subnet | network/ |
| 月単位 | RDS, DynamoDB | database/ |
| 週単位 | ECS Service, ALB | compute/ |
| 日単位 | Task Definition | compute/ecs-task-*.yaml |

### 原則3: 設定数（増減の可能性）

**1個で固定 vs 継続的に増える → 分ける**

| リソース | 設定数 | 分離推奨 |
|---------|-------|--------|
| VPC | 1個 | IGW と同じファイルOK |
| Security Groups | 激増 | ディレクトリで分割 |
| CloudWatch Alarms | 激増 | サービス別にファイル分割 |

---

## 🔍 判断フロー

```
1. AWS コンソールで別メニュー？
   ├─ Yes → 分割候補
   └─ No → 同じファイル候補

2. ライフサイクルが異なる？
   ├─ Yes → 分割推奨
   └─ No → 次へ

3. 設定が継続的に増える？
   ├─ Yes → 分割推奨（ディレクトリ化も検討）
   └─ No → 同じファイルでOK
```

---

## 📁 推奨ディレクトリ構成

### ネスト構成 + README インデックス

```
infra/cloudformation/service/
├── README.md  ← ★ インデックス（3原則の説明、よくある変更の対応表）
├── stack.yaml (親スタック)
├── parameters/
│   ├── dev.json
│   └── prod.json
└── nested/
    ├── network/
    │   ├── README.md
    │   ├── vpc-and-igw.yaml             # VPC+IGW（密結合）
    │   ├── subnets.yaml                 # Subnets（増える）
    │   ├── route-tables.yaml            # Route Tables
    │   ├── nat-gateways.yaml            # NAT GW
    │   └── security-groups/             # ★ ディレクトリ（激増）
    │       ├── alb-sg.yaml
    │       ├── ecs-sg.yaml
    │       └── rds-sg.yaml
    ├── database/
    │   ├── README.md
    │   ├── rds-instance.yaml
    │   └── rds-security-group.yaml
    ├── compute/
    │   ├── README.md
    │   ├── ecr-repositories.yaml
    │   ├── ecs-cluster.yaml
    │   ├── ecs-task-public-web.yaml     # サービス別
    │   ├── ecs-service-public-web.yaml
    │   ├── ecs-task-admin-api.yaml
    │   ├── ecs-service-admin-api.yaml
    │   └── alb.yaml                     # ALB+TG+Listener
    └── monitoring/
        ├── README.md
        ├── cloudwatch-log-groups.yaml
        ├── cloudwatch-alarms-ecs.yaml   # サービス別
        ├── cloudwatch-alarms-rds.yaml
        ├── cloudwatch-alarms-alb.yaml
        └── eventbridge-rules.yaml
```

---

## 📋 判断例

### network/ の判断

| ファイル | コンソール | ライフサイクル | 設定数 | 判定 |
|---------|-----------|--------------|--------|------|
| vpc-and-igw.yaml | VPCとIGWは密結合 | 初回のみ | 1個 | 同じファイル |
| subnets.yaml | 別メニュー | たまに追加 | 4個→増える | 別ファイル |
| route-tables.yaml | 別メニュー | たまに変更 | 2個 | 別ファイル |
| nat-gateways.yaml | 別メニュー | 初回のみ | 1-2個 | 別ファイル（高額リソース） |
| security-groups/ | 別メニュー | 継続的に追加 | 3個→激増 | ディレクトリ |

### compute/ の判断

| ファイル | コンソール | ライフサイクル | 設定数 | 判定 |
|---------|-----------|--------------|--------|------|
| ecr-repositories.yaml | 別メニュー | たまに追加 | 2個→増える | 別ファイル |
| ecs-cluster.yaml | 別メニュー | 初回のみ | 1個 | 別ファイル |
| ecs-task-*.yaml | 同じメニュー | 頻繁に変更 | 増える | サービス別 |
| ecs-service-*.yaml | 同じメニュー | たまに変更 | 増える | サービス別 |
| alb.yaml | ALB配下 | たまに変更 | 1個 | 同じファイル |

### monitoring/ の判断

| ファイル | コンソール | ライフサイクル | 設定数 | 判定 |
|---------|-----------|--------------|--------|------|
| cloudwatch-log-groups.yaml | 別メニュー | たまに追加 | 5個→増える | 別ファイル |
| cloudwatch-alarms-*.yaml | 別メニュー | 継続的に追加 | 10個→激増 | サービス別 |
| eventbridge-rules.yaml | 別メニュー | たまに追加 | 3個→増える | 別ファイル |

---

## 🎯 コメント見出しレベルでの判断

### 判断基準

**行数ではなく、コメント見出しの数で判断します。**

```yaml
# ==============================================================================
# Resources  ← 大見出し（セクション）
# ==============================================================================

# ------------------------------------------------------------------------------
# VPC  ← 中見出し（リソースの論理的なまとまり）
# ------------------------------------------------------------------------------

# ------------------------------------------------------------------------------
# Internet Gateway  ← 中見出し
# ------------------------------------------------------------------------------
```

**判断フロー**:
```
中見出し (`# ----`) が何個ある？
  ↓
├─ 1〜2個 → そのまま（分割不要）
├─ 3〜5個 → 分割を検討（3原則で判断）
└─ 6個以上 → 分割推奨
```

---

## ✅ Good Example

### 例1: VPC + IGW（中見出し2個、密結合）

```yaml
# 設計書に記載:
# 「VPC と IGW は密結合のため、1ファイルで管理。
#  必ず一緒に変更するため分割しない。」

# vpc-and-igw.yaml

# ------------------------------------------------------------------------------
# VPC
# ------------------------------------------------------------------------------
ServiceVPC: ...

# ------------------------------------------------------------------------------
# Internet Gateway
# ------------------------------------------------------------------------------
InternetGateway: ...
AttachGateway: ...
```

**判定**: ✅ 同じファイル（密結合、3原則の原則1）

### 例2: compute.yaml（中見出し5個） → 分割

```yaml
# 設計書に記載:
# 「compute.yaml は中見出しが5個あり、3原則で判断した結果、
#  ネスト構成に分割:
#  - ecr-repositories.yaml（別メニュー）
#  - ecs-cluster.yaml（初回のみ）
#  - ecs-task-public-web.yaml（頻繁に変更）
#  - ecs-service-public-web.yaml（たまに変更）
#  - alb.yaml（ALB+TG+Listener、密結合）」
```

**判定**: ✅ 分割推奨（中見出し5個、3原則で判断）

---

## ❌ Bad Example

### 例: 中見出し5個、752行で1ファイル（理由なし）

```yaml
# 設計書に記載なし
# → 実装時に「とりあえず全部入れた」
# → なぜこの構成か説明できない
# → メンテナンス時にどこを変更すればいいかわからない
```

**問題**:
- ファイル名が `03-compute.yaml` で抽象的 → 何が入っているかわからない
- 中見出しが5個あるのに分割していない → メンテナンス性が低い
- 設計書に理由がない → 判断基準が不明

---

## 📝 設計書への記載例

詳細設計書の「実装方針」に以下を記載してください：

```markdown
### 12. 実装方針

#### 12.1 ファイル分割方針

**CloudFormation ファイル分割の3原則に基づいて判断:**

1. **AWS コンソールの分け方**: 別メニュー → 別ファイル
2. **ライフサイクル**: 変更頻度が異なる → 分ける
3. **設定数**: 継続的に増える → 早めに分割

**各ファイルの判断根拠:**

| ファイル | コンソール | ライフサイクル | 設定数 | 判定 |
|---------|-----------|--------------|--------|------|
| vpc-and-igw.yaml | 密結合 | 初回のみ | 1個 | 同じファイル |
| subnets.yaml | 別メニュー | たまに追加 | 増える | 別ファイル |
| security-groups/ | 別メニュー | 継続的に追加 | 激増 | ディレクトリ |

**参照**: `.claude/docs/40_standards/45_cloudformation.md`
```

---

**作成日**: 2025-10-19
**更新日**: 2025-10-23（3原則ベースに全面改訂）
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
