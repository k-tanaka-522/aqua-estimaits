# 2.4.6.1.5 CloudFormation dry-run必須手順

## 目的

本番環境への変更前に必ずdry-run（Change Sets）を実行します。

---

## ⚠️ dry-run必須ルール

### 1. 本番環境への直接デプロイ禁止 ⭐⭐⭐

```bash
# ❌ Bad Example: 直接デプロイ
aws cloudformation deploy \
  --stack-name myapp-prod \
  --template-file template.yaml

# ✅ Good Example: Change Setsで事前確認
aws cloudformation create-change-set \
  --stack-name myapp-prod \
  --template-body file://template.yaml \
  --change-set-name pre-deploy-check
```

---

### 2. Change Sets レビュープロセス ⭐⭐⭐

**手順**:
1. Change Sets 作成
2. 変更内容をユーザーに提示
3. ユーザー承認を得る
4. 承認後に実行

```bash
# 1. Change Sets 作成
aws cloudformation create-change-set ...

# 2. 変更内容を確認
aws cloudformation describe-change-set ...

# 3. ユーザーに提示して承認を得る
echo "以下の変更を行います。承認してください："
echo "- ECSタスク定義の更新"
echo "- ALBリスナールールの追加"

# 4. 承認後に実行
aws cloudformation execute-change-set ...
```

---

### 3. 削除リソースの確認 ⭐⭐⭐

Change Setsで以下を確認：
- ✅ `Action: Remove` がないか
- ✅ `Replacement: True` がないか（置換=削除+作成）
- ✅ データ損失のリスクはないか

---

**作成日**: 2025-10-19
**対象フェーズ**: 実装
**重要度**: ⭐⭐⭐ 必須
