# 2.3.12 運用設計ガイド

## 目的

**運用設計（監視・ログ・バックアップ・リストア）の具体的な設計方法**を提供します。

---

## 📋 運用設計の全体像

運用設計は、システムを**安定稼働させ、障害時に迅速に復旧する**ために不可欠です。

### 基本設計書での記載（方針レベル）

- **8.1 監視設計**: 何を監視するか（方針）
- **8.2 ログ設計**: ログの種類・レベル（方針）
- **8.3 バックアップ設計**: バックアップ対象・頻度（方針）
- **8.4 障害復旧設計**: RTO/RPO（目標値）

### 詳細設計書での記載（実装レベル）

- **9. ログ設計**: ログレベル、フォーマット、保持期間
- **10. 監視設計**: メトリクス定義、アラート設計、ダッシュボード設計
- **11. バックアップ・リストア設計**: バックアップ戦略、リストア手順、テスト計画
- **12. 実装方針**: CloudFormation リソース一覧（CloudWatch Alarms、EventBridge、AWS Backup等）

---

## 1. 監視設計

### 1.1 監視メトリクス定義

#### AWS リソースごとの推奨メトリクス

**ECS (Fargate/EC2)**
```markdown
| メトリクス | 閾値 | アラート条件 | 重要度 |
|----------|------|------------|--------|
| CPUUtilization | 80% | 5分間継続 | High |
| MemoryUtilization | 80% | 5分間継続 | High |
| TargetResponseTime | 1秒 | 5分間平均 | Medium |
| HealthyHostCount | 1未満 | 1分間 | Critical |
| UnHealthyHostCount | 1以上 | 1分間 | Critical |
```

**RDS**
```markdown
| メトリクス | 閾値 | アラート条件 | 重要度 |
|----------|------|------------|--------|
| CPUUtilization | 80% | 5分間継続 | High |
| FreeableMemory | 1GB未満 | 5分間継続 | High |
| DatabaseConnections | 最大接続数の80% | 5分間平均 | Medium |
| ReadLatency | 100ms | 5分間平均 | Medium |
| WriteLatency | 100ms | 5分間平均 | Medium |
| FreeStorageSpace | 10GB未満 | 1回 | Critical |
```

**ALB**
```markdown
| メトリクス | 閾値 | アラート条件 | 重要度 |
|----------|------|------------|--------|
| TargetResponseTime | 1秒 | 5分間平均 | Medium |
| HTTPCode_Target_5XX_Count | 10件 | 5分間合計 | High |
| UnHealthyHostCount | 1以上 | 1分間 | Critical |
| RequestCount | - | 監視のみ | Info |
```

**Lambda**
```markdown
| メトリクス | 閾値 | アラート条件 | 重要度 |
|----------|------|------------|--------|
| Errors | 5件 | 5分間合計 | High |
| Duration | タイムアウト値の80% | 5分間平均 | Medium |
| Throttles | 1件 | 5分間合計 | High |
| ConcurrentExecutions | 予約済み同時実行数の80% | 1分間 | Medium |
```

### 1.2 アラート設計

#### アラート通知先の設計

```markdown
## アラート通知先

| 重要度 | 通知先 | 通知手段 | 対応時間 |
|--------|--------|---------|---------|
| Critical | オンコールエンジニア | SNS → Slack, Email, SMS | 即時（5分以内） |
| High | 開発チーム | SNS → Slack, Email | 30分以内 |
| Medium | 開発チーム | SNS → Slack | 営業時間内 |
| Info | ダッシュボードのみ | - | - |
```

#### SNS Topic 設計

```markdown
## SNS Topic 構成

### critical-alerts
- 用途: Critical レベルのアラート
- サブスクリプション:
  - Slack Webhook (oncall チャンネル)
  - Email (oncall@example.com)
  - SMS (オンコールエンジニア)

### high-alerts
- 用途: High レベルのアラート
- サブスクリプション:
  - Slack Webhook (dev-alerts チャンネル)
  - Email (dev-team@example.com)

### medium-alerts
- 用途: Medium レベルのアラート
- サブスクリプション:
  - Slack Webhook (dev-alerts チャンネル)
```

### 1.3 ダッシュボード設計

#### CloudWatch Dashboard 構成

```markdown
## ダッシュボード構成

### 1. システム全体ダッシュボード
- ALB リクエスト数、エラー率
- ECS CPU/Memory 使用率
- RDS 接続数、クエリ性能
- Lambda エラー数、実行時間

### 2. インフラダッシュボード
- VPC フローログ
- NAT Gateway データ転送量
- ECS サービスのタスク数推移

### 3. アプリケーションダッシュボード
- API エンドポイント別レスポンスタイム
- ビジネスメトリクス（ユーザー登録数、売上等）
```

### 1.4 実装方針への記載例

```markdown
## 12. 実装方針

### 12.2 ディレクトリ構成

infra/cloudformation/
├── stacks/
│   ├── network/
│   ├── storage/
│   ├── compute/
│   └── monitoring/           # 監視リソース
│       ├── alarms.yaml       # CloudWatch Alarms（推定180行）
│       ├── dashboard.yaml    # CloudWatch Dashboard（推定120行）
│       └── sns-topics.yaml   # SNS Topics（推定80行）

### 12.6 推定行数と分割理由

#### monitoring/alarms.yaml (推定180行)
**含まれるリソース:**
- ECS Alarms (CPU, Memory, HealthyHost)
- RDS Alarms (CPU, Memory, Storage, Connections)
- ALB Alarms (5XX errors, ResponseTime)
- Lambda Alarms (Errors, Throttles)

**分割理由:**
- アラート定義は頻繁に変更される
- 監視対象ごとに独立して管理可能
- CloudFormation の更新影響を最小化
```

---

## 2. ログ設計

### 2.1 ログレベル定義

```markdown
| レベル | 用途 | 例 |
|--------|------|-----|
| ERROR | エラー発生時 | 例外、API呼び出し失敗 |
| WARN | 警告（処理は継続） | リトライ実行、タイムアウト寸前 |
| INFO | 重要な処理 | ユーザー登録、決済処理 |
| DEBUG | デバッグ情報 | 変数の値、処理の流れ |
```

### 2.2 ログフォーマット

#### JSON 構造化ログ（推奨）

```json
{
  "timestamp": "2025-10-22T10:30:45.123Z",
  "level": "ERROR",
  "message": "Database connection failed",
  "service": "user-service",
  "requestId": "abc123",
  "userId": "user-456",
  "error": {
    "type": "DatabaseError",
    "message": "Connection timeout",
    "stack": "..."
  }
}
```

**メリット:**
- CloudWatch Logs Insights でクエリしやすい
- 機械可読性が高い
- フィルターしやすい

### 2.3 ログ保持期間

```markdown
| ログ種別 | 保持期間 | 理由 |
|---------|---------|------|
| アプリケーションログ（ERROR/WARN） | 90日 | トラブルシューティング |
| アプリケーションログ（INFO） | 30日 | 通常運用 |
| アプリケーションログ（DEBUG） | 7日 | 開発時のみ |
| アクセスログ（ALB） | 90日 | セキュリティ監査 |
| VPC フローログ | 30日 | ネットワーク調査 |
| CloudTrail ログ | 1年 | セキュリティ監査、コンプライアンス |
```

### 2.4 ログ分析設計

```markdown
## CloudWatch Logs Insights クエリ例

### エラーログの集計
fields @timestamp, level, message, service
| filter level = "ERROR"
| stats count() by service
| sort count desc

### API レスポンスタイムの分析
fields @timestamp, requestId, duration
| filter service = "api-gateway"
| stats avg(duration), max(duration), min(duration) by bin(5m)
```

---

## 3. バックアップ・リストア設計

バックアップ・リストアは**データ層**と**インフラ構成**の2種類に分けて設計します。

### 3.1 バックアップの種類

#### データ層のバックアップ・リストア

**対象:**
- RDS データベース（ユーザーデータ、トランザクションデータ）
- S3 ユーザーアップロードファイル
- DynamoDB データ
- EBS ボリューム（アプリケーションデータ）

**手段:**
- AWS Backup
- RDS 自動バックアップ
- S3 バージョニング
- EBS スナップショット

**リストア方法:**
- RDS: ポイントインタイムリカバリ
- S3: バージョン復元
- EBS: スナップショットから復元

#### インフラ構成のバックアップ・リストア

**対象:**
- CloudFormation テンプレート（`.yaml`）
- パラメータファイル（`parameters/*.json`）
- アプリケーション設定（環境変数定義）
- Secrets Manager/Parameter Store の設定

**手段:**
- **Git リポジトリ（最重要）**
- CloudFormation スタックのエクスポート（補助）

**リストア方法（IaC のメリット）:**
```bash
# 1. Git から最新の構成を取得
git checkout main

# 2. CloudFormation でインフラを再作成
aws cloudformation create-stack \
  --stack-name production-network \
  --template-body file://infra/cloudformation/stacks/network/vpc.yaml \
  --parameters file://infra/cloudformation/parameters/prod.json
```

**IaC化のメリット:**
- ✅ Git がバックアップとして機能
- ✅ 任意のコミット時点の構成に戻せる（`git checkout <commit-hash>`）
- ✅ インフラ構成の変更履歴がすべて記録されている
- ✅ リストア手順がシンプル（`git checkout` + `aws cloudformation create-stack`）
- ✅ 手動バックアップ不要

### 3.2 バックアップ戦略（データ層）

#### RTO/RPO の定義

```markdown
| リソース | RPO | RTO | バックアップ頻度 | 世代管理 |
|---------|-----|-----|--------------|---------|
| RDS (本番DB) | 5分 | 30分 | 自動バックアップ（日次） + トランザクションログ | 7日間 |
| RDS (ステージング) | 1時間 | 2時間 | 自動バックアップ（日次） | 3日間 |
| S3 (ユーザーアップロード) | 24時間 | 1時間 | バージョニング有効化 | 30日間 |
| EBS (アプリケーション設定) | 24時間 | 1時間 | スナップショット（日次） | 7日間 |
```

**RPO (Recovery Point Objective)**: データ損失の許容範囲（どこまで戻せるか）
**RTO (Recovery Time Objective)**: 復旧時間の目標（どれくらいで戻せるか）

#### AWS Backup による自動バックアップ

```markdown
## バックアップ計画

### Production Backup Plan
- **対象リソース**: タグ `Environment=production` のすべてのリソース
- **バックアップルール**:
  - 日次バックアップ: 毎日 03:00 JST
  - 週次バックアップ: 毎週日曜 03:00 JST
  - 月次バックアップ: 毎月1日 03:00 JST
- **保持期間**:
  - 日次: 7日間
  - 週次: 4週間
  - 月次: 12ヶ月

### Staging Backup Plan
- **対象リソース**: タグ `Environment=staging` のすべてのリソース
- **バックアップルール**:
  - 日次バックアップ: 毎日 03:00 JST
- **保持期間**:
  - 日次: 3日間
```

### 3.3 リストア手順（データ層）

#### RDS のリストア手順

```markdown
## RDS リストア手順（ポイントインタイムリカバリ）

### 1. 事前確認
- [ ] 復旧対象時刻を特定
- [ ] 現在の RDS インスタンスの状態を確認
- [ ] リストア先のセキュリティグループを確認

### 2. リストア実行
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier production-db \
  --target-db-instance-identifier production-db-restored-20251022 \
  --restore-time 2025-10-22T10:30:00Z

### 3. 検証
- [ ] リストアされたDBインスタンスが起動完了
- [ ] データ整合性を確認（レコード数、最新更新日時）
- [ ] アプリケーションから接続可能か確認

### 4. CloudFormation スタックへのインポート

**問題**: PITR で復元した RDS インスタンスは CloudFormation 管理外

**解決方法 A: リソースインポート**

aws cloudformation create-change-set \
  --stack-name production-storage \
  --change-set-name import-restored-db \
  --change-set-type IMPORT \
  --resources-to-import \
    ResourceType=AWS::RDS::DBInstance,LogicalResourceId=ProductionDB,ResourceIdentifier={DBInstanceIdentifier=production-db-restored-20251022} \
  --template-body file://infra/cloudformation/stacks/storage/rds.yaml \
  --parameters file://infra/cloudformation/parameters/prod.json

aws cloudformation execute-change-set \
  --stack-name production-storage \
  --change-set-name import-restored-db

**解決方法 B: CloudFormation テンプレート更新**

# 1. rds.yaml の DBInstanceIdentifier を更新
sed -i 's/production-db/production-db-restored-20251022/g' \
  infra/cloudformation/stacks/storage/rds.yaml

# 2. スタックを更新
aws cloudformation update-stack \
  --stack-name production-storage \
  --template-body file://infra/cloudformation/stacks/storage/rds.yaml \
  --parameters file://infra/cloudformation/parameters/prod.json

# 3. Git にコミット（インフラ構成の変更を記録）
git add infra/cloudformation/stacks/storage/rds.yaml
git commit -m "Update RDS instance identifier after PITR restore"

### 5. 切り替え
- [ ] CloudFormation スタックが UPDATE_COMPLETE
- [ ] アプリケーションを停止
- [ ] 接続文字列を確認（restored インスタンスへ）
- [ ] アプリケーションを起動
- [ ] 動作確認

### 6. 後処理
- [ ] 旧 RDS インスタンスをスナップショット作成後削除
- [ ] rds.yaml を元の名前に戻す（または restored を正式名称にする）
- [ ] Git にコミット（インフラ構成の最終状態を記録）
```

### 3.4 リストア手順（インフラ構成）

#### CloudFormation スタックのリストア手順

```markdown
## インフラ全体のリストア手順（災害復旧）

### 1. Git リポジトリから構成を取得

# 最新の構成を使う場合
git checkout main

# 特定時点の構成に戻す場合
git checkout <commit-hash>  # 例: git checkout a1b2c3d

### 2. スタックを順番に再作成

# ネットワーク層（最初）
aws cloudformation create-stack \
  --stack-name production-network \
  --template-body file://infra/cloudformation/stacks/network/vpc.yaml \
  --parameters file://infra/cloudformation/parameters/prod.json

# ストレージ層（ネットワーク層完了後）
aws cloudformation create-stack \
  --stack-name production-storage \
  --template-body file://infra/cloudformation/stacks/storage/rds.yaml \
  --parameters file://infra/cloudformation/parameters/prod.json

# コンピューティング層（ストレージ層完了後）
aws cloudformation create-stack \
  --stack-name production-compute \
  --template-body file://infra/cloudformation/stacks/compute/ecs.yaml \
  --parameters file://infra/cloudformation/parameters/prod.json

### 3. データをリストア（データ層のバックアップから）

# RDS をバックアップから復元
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier production-db \
  --db-snapshot-identifier production-db-snapshot-20251022

### 4. 動作確認

- [ ] すべてのスタックが CREATE_COMPLETE
- [ ] アプリケーションが起動
- [ ] ヘルスチェックが正常
```

#### Secrets Manager/Parameter Store のリストア

```markdown
## シークレット・パラメータのリストア

### 前提
- Secrets Manager/Parameter Store の値は Git に含めない（セキュリティ）
- 別途バックアップが必要

### バックアップ方法
# 定期的にエクスポート（暗号化して保存）
aws secretsmanager list-secrets > secrets-backup.json
aws ssm get-parameters-by-path --path /production/ > parameters-backup.json

### リストア方法
# JSON から復元
aws secretsmanager create-secret \
  --name production/db/password \
  --secret-string "$(jq -r '.SecretString' secrets-backup.json)"
```

### 3.5 テスト計画

```markdown
## バックアップ・リストアテスト計画

### 月次テスト（必須）
- **テスト内容**: RDS スナップショットからのリストア
- **実施タイミング**: 毎月第1土曜日
- **手順**:
  1. 本番DBのスナップショットから新しいインスタンスを作成
  2. データ整合性を確認（レコード数、最新データ）
  3. アプリケーションから接続確認
  4. テスト用インスタンスを削除

### 四半期テスト（推奨）
- **テスト内容**: フルリストア訓練
- **実施タイミング**: 四半期ごと
- **手順**:
  1. ステージング環境で本番バックアップからリストア
  2. アプリケーション全体の動作確認
  3. リストア時間の計測（RTO達成確認）
```

### 3.6 実装方針への記載例

```markdown
## 12. 実装方針

### 12.2 ディレクトリ構成

infra/cloudformation/
├── stacks/
│   ├── storage/
│   │   └── rds.yaml                    # RDS（バックアップ設定含む）
│   └── backup/                         # バックアップ専用
│       ├── backup-plan.yaml            # AWS Backup Plan（推定150行）
│       └── backup-vault.yaml           # AWS Backup Vault（推定60行）

### 12.6 推定行数と分割理由

#### backup/backup-plan.yaml (推定150行)
**含まれるリソース:**
- Backup Plan (Production, Staging)
- Backup Selection (タグベース)
- Backup Rule (日次、週次、月次)

**分割理由:**
- バックアップポリシーは独立して変更される
- 環境ごとの差異を管理しやすい
```

---

## 4. EventBridge 活用例

### 4.1 定期バックアップのトリガー

```markdown
## EventBridge Rule 設計

### Rule: daily-backup-trigger
- **スケジュール**: cron(0 18 * * ? *)  # 毎日 03:00 JST
- **ターゲット**: Lambda (バックアップ実行関数)
- **用途**: RDS手動スナップショット作成

### Rule: weekly-report
- **スケジュール**: cron(0 9 ? * MON *)  # 毎週月曜 18:00 JST
- **ターゲット**: Lambda (週次レポート生成)
- **用途**: 先週のシステム稼働レポート生成・送信

### Rule: auto-scaling-schedule
- **スケジュール**: cron(0 0 * * ? *)  # 毎日 09:00 JST
- **ターゲット**: ECS Service (UpdateService)
- **用途**: 営業時間開始前にタスク数を増やす
```

### 4.2 イベント駆動型アーキテクチャ

```markdown
## EventBridge Rule（イベント駆動）

### Rule: rds-backup-failed
- **イベントパターン**: RDS バックアップ失敗
- **ターゲット**: SNS Topic (critical-alerts)
- **用途**: バックアップ失敗時の即時通知

### Rule: ecs-task-stopped
- **イベントパターン**: ECS タスク停止（異常終了）
- **ターゲット**: Lambda (障害調査・復旧)
- **用途**: 自動復旧または通知
```

---

## 5. 技術標準への準拠

### 5.1 セキュリティ・運用基準の参照

運用設計時は `.claude/docs/40_standards/49_security.md` を必ず参照してください。

**チェック項目:**
- [ ] ログにシークレット情報（パスワード、APIキー）が含まれていないか
- [ ] バックアップデータは暗号化されているか
- [ ] CloudWatch Logs の保持期間は適切か（コスト vs セキュリティ）
- [ ] アラート通知先は適切か（機密情報が外部に漏れないか）

---

## 6. 実装方針への統合

詳細設計書「12. 実装方針」に、以下を**必ず記載**してください：

### 記載すべき内容

```markdown
## 12. 実装方針

### 12.2 ディレクトリ構成

infra/cloudformation/
├── stacks/
│   ├── network/
│   ├── storage/
│   │   └── rds.yaml                    # バックアップ設定含む
│   ├── compute/
│   ├── monitoring/                     # 監視リソース
│   │   ├── alarms.yaml
│   │   ├── dashboard.yaml
│   │   └── sns-topics.yaml
│   └── backup/                         # バックアップリソース
│       ├── backup-plan.yaml
│       └── backup-vault.yaml

### 12.6 推定行数と分割理由

各ファイルの推定行数と、なぜそのファイル分割にしたかの理由を記載。

**理由の例:**
- 「監視設定は頻繁に変更されるため、compute スタックから分離」
- 「バックアップポリシーは環境ごとに異なるため、独立したスタックとして管理」
```

---

## 7. チェックリスト

詳細設計書を作成する際、以下を確認してください：

### 監視設計
- [ ] 監視メトリクスが定義されているか
- [ ] アラート閾値が設定されているか
- [ ] 通知先（SNS Topic）が設計されているか
- [ ] ダッシュボード構成が設計されているか

### ログ設計
- [ ] ログレベルが定義されているか
- [ ] ログフォーマット（JSON推奨）が定義されているか
- [ ] ログ保持期間が設定されているか
- [ ] ログ分析方法が設計されているか

### バックアップ・リストア設計
- [ ] RTO/RPO が定義されているか
- [ ] バックアップ対象リソースが明確か
- [ ] バックアップ頻度・世代管理が設計されているか
- [ ] リストア手順が記載されているか
- [ ] リストアテスト計画があるか

### 実装方針
- [ ] CloudFormation ディレクトリ構成に `monitoring/`、`backup/` が含まれているか
- [ ] 各ファイルの推定行数が記載されているか
- [ ] ファイル分割の理由が記載されているか

---

## 8. Good Example

```markdown
## 10. 監視設計

### 10.1 監視メトリクス定義

#### ECS Service

| メトリクス | 閾値 | アラート条件 | 重要度 | 通知先 |
|----------|------|------------|--------|--------|
| CPUUtilization | 80% | 5分間継続 | High | high-alerts |
| MemoryUtilization | 80% | 5分間継続 | High | high-alerts |
| UnHealthyHostCount | 1以上 | 1分間 | Critical | critical-alerts |

#### RDS

| メトリクス | 閾値 | アラート条件 | 重要度 | 通知先 |
|----------|------|------------|--------|--------|
| CPUUtilization | 80% | 5分間継続 | High | high-alerts |
| FreeStorageSpace | 10GB未満 | 1回 | Critical | critical-alerts |

### 10.2 アラート設計

#### SNS Topic 構成

**critical-alerts**
- Slack Webhook (oncall チャンネル)
- Email (oncall@example.com)
- SMS (オンコールエンジニア: +81-90-xxxx-xxxx)

**high-alerts**
- Slack Webhook (dev-alerts チャンネル)
- Email (dev-team@example.com)

### 10.3 ダッシュボード設計

**システム全体ダッシュボード**
- ALB リクエスト数（5分間隔）
- ECS CPU/Memory 使用率（1分間隔）
- RDS 接続数・クエリ性能（1分間隔）

## 11. バックアップ・リストア設計

### 11.1 バックアップ戦略

| リソース | RPO | RTO | バックアップ頻度 | 世代管理 |
|---------|-----|-----|--------------|---------|
| RDS | 5分 | 30分 | 自動バックアップ（日次） | 7日間 |

### 11.2 リストア手順

[RDS リストア手順を記載]

### 11.3 RTO/RPO の実装方針

- **RDS**: ポイントインタイムリカバリ有効化（5分間隔のトランザクションログ）
- **S3**: バージョニング有効化（削除から30日間復元可能）

### 11.4 テスト計画

- **月次テスト**: RDS スナップショットからのリストア（毎月第1土曜日）
- **四半期テスト**: フルリストア訓練（四半期ごと）

## 12. 実装方針

### 12.2 ディレクトリ構成

infra/cloudformation/
├── stacks/
│   ├── monitoring/
│   │   ├── alarms.yaml       # 推定180行
│   │   ├── dashboard.yaml    # 推定120行
│   │   └── sns-topics.yaml   # 推定80行
│   └── backup/
│       ├── backup-plan.yaml  # 推定150行
│       └── backup-vault.yaml # 推定60行

### 12.6 推定行数と分割理由

**monitoring/alarms.yaml (推定180行)**
- ECS、RDS、ALB のアラート定義
- 監視設定は頻繁に変更されるため、compute スタックから分離
- アラートごとに独立して更新可能
```

---

## 9. Bad Example

```markdown
## 10. 監視設計

CloudWatch で監視します。

## 11. バックアップ設計

バックアップは毎日取ります。
```

**問題点:**
- ❌ 具体的なメトリクスが定義されていない
- ❌ アラート閾値が設定されていない
- ❌ 通知先が設計されていない
- ❌ バックアップ対象、頻度、世代管理が不明確
- ❌ RTO/RPO が定義されていない
- ❌ 実装方針に CloudFormation リソースが含まれていない

**結果:**
→ 実装時に CloudWatch Alarms、EventBridge、AWS Backup の CloudFormation が生成されない

---

**作成日**: 2025-10-22
**対象フェーズ**: 設計
**重要度**: ⭐⭐⭐ 必須
