# 2.3.7 実装方針設計

## 目的

**設計から実装への橋渡し**を行います。

設計書は「何を作るか」を決めるだけでなく、**「どう作るか」の方針**も示す必要があります。
この実装方針が欠けていると、実装フェーズで技術標準が忘れられ、メンテナンス性の低いコードが生成されます。

---

## ⚠️ なぜ必要か？

### 問題: 実装方針がないと...

```
設計書: 「ECSクラスター、ALB、RDSを構築する」
   ↓
実装者: 「どうファイル分割すればいいの？」
   ↓
結果: とりあえず全部1ファイルに書く → 752行の巨大ファイル ❌
```

### 解決: 実装方針があれば...

```
設計書:
「ECSクラスター、ALB、RDSを構築する

 【実装方針】
 - compute.yaml は300行超えるため、ネスト構成に分割
   - compute.yaml (親スタック、200行)
   - nested/ecs.yaml (250行)
   - nested/alb.yaml (200行)
 - ライフサイクル別に分割: persistent.yaml (VPC, RDS) / ephemeral.yaml (ECS, ALB)
 」
   ↓
実装者: 「設計書通りに作ればいいんだな！」
   ↓
結果: メンテナンス性の高いコード ✅
```

---

## 📋 実装方針の記載項目

詳細設計書に以下のセクションを**必ず追加**してください：

### 1. ファイル分割方針

```markdown
## 10. 実装方針

### 10.1 ファイル分割方針

#### CloudFormation ファイル分割の3原則

**CloudFormation のファイル分割は、以下の3原則に基づいて判断します：**

##### 原則1: AWS コンソールの分け方（基本）
- AWS コンソールで別メニューになっているリソース → 別ファイル
- 同じメニューで一緒に操作するリソース → 同じファイル

**例**:
- ✅ VPC と Subnets → 別ファイル（別メニュー）
- ✅ VPC と Internet Gateway → 同じファイル（VPC作成時に一緒に作る、密結合）
- ✅ ALB と Target Group と Listener → 同じファイル（ALB配下で一緒に操作）

##### 原則2: ライフサイクル（変更頻度）
- 初回のみ作成・ほぼ変更なし vs 頻繁に変更 → 分ける
- 必ず一緒に変更するリソース → 同じファイル

**例**:
- ✅ ECS Cluster（変更少） vs Task Definition（変更多） → 別ファイル
- ✅ VPC（初回のみ） vs Security Groups（継続的に追加） → 別ファイル
- ✅ Route53 Hosted Zone（初回のみ） vs Route53 Records（継続的に追加） → 別ファイル

##### 原則3: 設定数（増減の可能性）
- 1個で固定 vs 継続的に増える → 分ける
- 増えやすいリソース → 早めにディレクトリで分割

**例**:
- ✅ VPC（1個） + IGW（1個） → 同じファイルOK
- ✅ Security Groups（激増） → ディレクトリで分割
- ✅ CloudWatch Alarms（激増） → サービス別にファイル分割

##### 判断フロー

```
1. AWS コンソールで別メニュー？
   ├─ Yes → 分割候補
   └─ No → 同じファイル候補

2. ライフサイクルが異なる？
   ├─ Yes → 分割推奨
   └─ No → 次へ

3. 設定が継続的に増える？
   ├─ Yes → 分割推奨（ディレクトリ化も検討）
   └─ No → 同じファイルでOK
```

##### スタック構成例

```
infra/cloudformation/service/
├── README.md  ← ★ インデックス（3原則の説明、よくある変更の対応表）
├── stack.yaml (親スタック)
└── nested/
    ├── network/
    │   ├── README.md                    # ネットワーク層のインデックス
    │   ├── vpc-and-igw.yaml             # VPC+IGW（密結合、初回のみ、1個）
    │   ├── subnets.yaml                 # Subnets（別メニュー、たまに追加、増える）
    │   ├── route-tables.yaml            # Route Tables（別メニュー、たまに変更）
    │   ├── nat-gateways.yaml            # NAT GW（別メニュー、初回のみ、高額）
    │   └── security-groups/             # ★ ディレクトリ（激増する）
    │       ├── alb-sg.yaml
    │       ├── ecs-sg.yaml
    │       └── rds-sg.yaml
    ├── database/
    │   ├── README.md
    │   ├── rds-instance.yaml            # RDS（別メニュー、たまに変更、1個）
    │   └── rds-security-group.yaml      # RDS SG（設定複雑なので分離）
    ├── compute/
    │   ├── README.md                    # コンピュート層のインデックス
    │   ├── ecr-repositories.yaml        # ECR（別メニュー、たまに追加、増える）
    │   ├── ecs-cluster.yaml             # Cluster（別メニュー、初回のみ、1個）
    │   ├── ecs-task-public-web.yaml     # Task（頻繁に変更、サービス別）
    │   ├── ecs-service-public-web.yaml  # Service（たまに変更、サービス別）
    │   ├── ecs-task-admin-api.yaml
    │   ├── ecs-service-admin-api.yaml
    │   └── alb.yaml                     # ALB+TG+Listener（密結合、1個）
    └── monitoring/
        ├── README.md
        ├── cloudwatch-log-groups.yaml      # Log Groups（別メニュー、増える）
        ├── cloudwatch-alarms-ecs.yaml      # Alarms（激増、サービス別）
        ├── cloudwatch-alarms-rds.yaml
        ├── cloudwatch-alarms-alb.yaml
        └── eventbridge-rules.yaml          # EventBridge（別メニュー、増える）
```

**各ファイルの判断根拠**:

| ファイル | コンソール | ライフサイクル | 設定数 | 判定 |
|---------|-----------|--------------|--------|------|
| vpc-and-igw.yaml | VPCとIGWは密結合 | 初回のみ | 1個 | 同じファイル |
| subnets.yaml | 別メニュー | たまに追加 | 4個→増える | 別ファイル |
| security-groups/ | 別メニュー | 継続的に追加 | 3個→激増 | ディレクトリ |
| ecs-cluster.yaml | 別メニュー | 初回のみ | 1個 | 別ファイル |
| ecs-task-*.yaml | 同じメニュー | 頻繁に変更 | 増える | サービス別 |
| alb.yaml | ALB配下で一緒 | たまに変更 | 1個 | 同じファイル |

**技術標準参照**: `.claude/docs/40_standards/45_cloudformation.md`
```

### 2. ディレクトリ構成

```markdown
### 10.2 ディレクトリ構成

```
project-root/
├── src/                    # アプリケーションコード
│   ├── api/               # API層 (推定5ファイル、各200行)
│   ├── domain/            # ビジネスロジック (推定8ファイル、各150行)
│   └── infrastructure/    # インフラ層 (推定6ファイル、各180行)
├── tests/
│   ├── unit/              # 単体テスト
│   └── integration/       # 結合テスト
└── infra/
    └── cloudformation/    # 上記参照
```

**命名規則**: `.claude/docs/40_standards/42_typescript.md` に準拠
```

### 3. モジュール分割

```markdown
### 10.3 モジュール分割

#### API層

**方針**: 1リソース = 1ファイル

- `users.controller.ts` (推定180行)
- `users.service.ts` (推定220行)
- `users.repository.ts` (推定150行)

**理由**:
- ユーザー管理は複雑な業務ロジックを含むため、責務ごとに分離
- 各ファイルは300行以内を目標

#### Domain層

**方針**: 1エンティティ = 1ファイル

- `user.entity.ts` (推定100行)
- `user.value-objects.ts` (推定150行)

**技術標準参照**: `.claude/docs/40_standards/42_typescript.md`
```

### 4. 命名規則

```markdown
### 10.4 命名規則

**CloudFormation リソース**:
- スタック名: `${ProjectName}-${Environment}-${Layer}`
- リソース名: `${ProjectName}${Environment}${ResourceType}`

**TypeScript**:
- ファイル名: kebab-case (`user-service.ts`)
- クラス名: PascalCase (`UserService`)
- 関数名: camelCase (`getUserById`)

**技術標準参照**: `.claude/docs/40_standards/`
```

### 5. 技術標準の適用

```markdown
### 10.5 技術標準の適用

**参照する技術標準**:
- `.claude/docs/40_standards/42_typescript.md` - TypeScript コーディング規約
- `.claude/docs/40_standards/45_cloudformation.md` - CloudFormation 規約
- `.claude/docs/40_standards/49_security.md` - セキュリティ基準

**プロジェクト固有の例外**:
- 【例】`database-schema.yaml` は400行だが、スキーマの密結合性を考慮し1ファイルとする
- 【理由】テーブル間の参照整合性を保つため、分割するとかえって複雑になる
```

---

## ✅ Good Example（実装方針がある設計書）

### 詳細設計書の実装方針セクション

```markdown
# 詳細設計書

（中略）

## 10. 実装方針

### 10.1 ファイル分割方針

**基本方針**: CloudFormation はライフサイクル別 + ネスト構成

```
infra/cloudformation/
├── persistent/
│   ├── network.yaml    # VPC, Subnet (推定245行)
│   └── database.yaml   # RDS (推定352行)
└── ephemeral/
    ├── compute.yaml    # 親スタック (推定180行)
    └── nested/
        ├── ecs.yaml    # ECS Cluster (推定280行)
        ├── alb.yaml    # ALB (推定220行)
        └── task-def.yaml # タスク定義 (推定150行)
```

**database.yaml が300行超える理由**:
- RDSの詳細設定（バックアップ、暗号化、モニタリング）を含む
- 設計上、RDS関連リソースは密結合のため1ファイル管理が適切
- レビューしやすさ・変更影響範囲の観点で問題なしと判断

### 10.2 技術標準の適用

**参照**: `.claude/docs/40_standards/45_cloudformation.md`

**例外事項**:
- `database.yaml` は352行（300行超え）だが、上記理由により許容

### 10.3 実装時の注意事項

- 各ファイル作成前に、推定行数と分割方針を再確認
- 300行を超える場合は、設計書の方針と整合しているか確認
- 不明点があれば設計者に確認
```

---

## ❌ Bad Example（実装方針がない設計書）

```markdown
# 詳細設計書

（中略）

## 10. インフラ構成

CloudFormationで以下を構築する：
- VPC
- RDS
- ECS
- ALB

（終わり）
```

**問題点**:
- ファイルをどう分割するか不明
- 推定行数の記載なし
- 技術標準との関係が不明
- 実装者が独自判断で作成 → 752行の巨大ファイルが生成される

---

## 🔄 実装フェーズとの連携

### 実装フェーズでの確認事項

実装フェーズに入る前に、以下を**必ず確認**してください：

1. **設計書に実装方針セクションがあるか？**
   - ない場合 → 設計フェーズに戻って追記

2. **ファイル分割方針が明記されているか？**
   - ない場合 → 設計者に確認

3. **推定行数が記載されているか？**
   - ない場合 → 設計者と実装者で見積もり

4. **技術標準との整合性が取れているか？**
   - 例外がある場合、理由が明記されているか？

**参照**: `.claude/helpers/implementation-checker.md`（次に作成予定）

---

## 📊 推定行数の算出方法

### 目安

| リソース種別 | 推定行数 |
|------------|---------|
| VPC + Subnet (3つ) | 100-150行 |
| SecurityGroup (1つ) | 30-50行 |
| RDS (詳細設定あり) | 200-300行 |
| ECS Cluster | 80-120行 |
| ECS Service | 150-200行 |
| ALB + TargetGroup | 180-220行 |
| IAM Role | 50-80行 |

### 計算例

```
compute.yaml に含まれるリソース:
- ECS Cluster: 100行
- ECS Service: 180行
- ALB: 200行
- TargetGroup: 100行
- IAM Role: 70行
- SecurityGroup: 50行
--------------------------
合計: 700行

→ 300行超えるため、ネスト構成に分割が必要
```

---

## 🎯 まとめ

### 実装方針設計の3原則

1. **具体的に書く**
   - 「適切に分割する」ではなく「compute.yaml は800行超えるため、ネスト構成に分割」

2. **理由を書く**
   - 「なぜこの構成にしたのか」を説明

3. **技術標準を参照する**
   - `.claude/docs/40_standards/` へのリンクを明記

### チェックリスト

設計書に以下が含まれているか確認：

- [ ] ファイル分割方針（ディレクトリ構成図あり）
- [ ] 各ファイルの推定行数
- [ ] 300行超える場合の理由
- [ ] 技術標準の参照
- [ ] プロジェクト固有の例外事項（あれば）

---

**作成日**: 2025-10-21
**対象フェーズ**: 設計
**重要度**: ⭐⭐⭐ 必須
**関連ドキュメント**:
- `.claude/docs/40_standards/45_cloudformation.md` - CloudFormation 規約
- `.claude/docs/10_facilitation/2.3_設計フェーズ/2.3.6_製造物_詳細設計書構成.md` - 詳細設計書構成
- `.claude/docs/10_facilitation/2.4_実装フェーズ/` - 実装フェーズ（次のステップ）
