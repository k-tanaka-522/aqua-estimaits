# 設計フェーズ実行ガイド（PHASE_GUIDE）

## このドキュメントの目的

**Claude（あなた）が設計フェーズを実行するための唯一のエントリーポイント**

- ユーザーとの一問一答で設計フェーズを進める
- PDCA 2周で決定事項を収集し、抜け漏れチェック
- 設計書を生成して次フェーズへ遷移

**重要**: このファイルを読めば、設計フェーズで何をすべきか全てわかります。他のファイルは参照用です。

---

## §1 このフェーズでやること（What）

### 1.1 設計フェーズの目的

**要件定義書を受けて、システムの設計を決定する**

- **Input**: 要件定義書（`docs/02_要件定義書.md` または `docs/02_要件定義書/`）
- **Output**: 基本設計書（`docs/03_基本設計書.md` または `docs/03_基本設計書/`）
- **成果物の品質**: 受託開発納品レベル（開発者が実装できるレベル）

### 1.2 設計フェーズで決定すること

以下の項目を**すべて**決定します（省略禁止）:

#### A. アーキテクチャ設計
- [ ] アーキテクチャパターン選定（マイクロサービス、モノリス、サーバーレス等）
- [ ] 選定理由（要件定義書との紐付け）
- [ ] 検討した代替案（3つ以上）
- [ ] トレードオフ（メリット・デメリット）

#### B. システム構成設計
- [ ] インフラ構成（AWS、GCP、オンプレ等）
- [ ] ネットワーク構成（VPC、サブネット、セキュリティグループ等）
- [ ] 可用性設計（Multi-AZ、リージョン冗長等）
- [ ] スケーラビリティ設計（Auto Scaling、負荷分散等）

#### C. データ設計
- [ ] データベース選定（RDS、DynamoDB、NoSQL等）
- [ ] テーブル設計（ER図、リレーション）
- [ ] データモデル設計（正規化、非正規化）
- [ ] データ移行方針（既存データがある場合）

#### D. API設計
- [ ] API仕様（REST、GraphQL、gRPC等）
- [ ] エンドポイント設計
- [ ] リクエスト・レスポンス形式
- [ ] 認証・認可方式（OAuth、JWT等）

#### E. セキュリティ設計
- [ ] 認証・認可設計
- [ ] データ暗号化方式
- [ ] ネットワークセキュリティ
- [ ] 監査ログ設計

#### F. 運用設計
- [ ] 監視・アラート設計（CloudWatch、DataDog等）
- [ ] ログ設計（CloudWatch Logs、S3等）
- [ ] バックアップ・リストア設計
- [ ] デプロイ方式（Blue/Green、カナリア等）

#### G. 実装方針設計
- [ ] 技術スタック選定（言語、フレームワーク、ライブラリ）
- [ ] ディレクトリ構成
- [ ] コーディング規約適用方針
- [ ] IaC方針（CloudFormation、Terraform等）

### 1.3 設計フェーズの制約

- **要件定義書との整合性**: すべての決定は要件定義書に基づく
- **技術標準の参照**: `.claude/docs/40_standards/` の技術標準を必ず参照
- **設計根拠の明記**: すべての決定に「なぜそうしたか」を記載

---

## §2 技術標準参照

### 2.1 参照すべき技術標準

設計時には、以下の技術標準を**必ず参照**してください:

| 技術標準ファイル | 参照タイミング | 必須度 |
|----------------|--------------|--------|
| `.claude/docs/40_standards/41_python.md` | Python採用時 | ⭐⭐⭐ 必須 |
| `.claude/docs/40_standards/42_typescript.md` | TypeScript採用時 | ⭐⭐⭐ 必須 |
| `.claude/docs/40_standards/43_csharp.md` | C#採用時 | ⭐⭐⭐ 必須 |
| `.claude/docs/40_standards/44_go.md` | Go採用時 | ⭐⭐⭐ 必須 |
| `.claude/docs/40_standards/45_cloudformation.md` | CloudFormation採用時 | ⭐⭐⭐ 必須 |
| `.claude/docs/40_standards/46_terraform.md` | Terraform採用時 | ⭐⭐⭐ 必須 |
| `.claude/docs/40_standards/49_security.md` | すべてのプロジェクト | ⭐⭐⭐ 必須 |

### 2.2 技術標準の適用方針

**設計で判断**（技術標準は推奨であり、プロジェクト要件に応じて調整可能）

- ✅ 技術標準を基本とする
- ✅ プロジェクト要件に応じて調整
- ✅ 調整理由を設計書に明記

---

## §3 PDCA 1周目（決定事項の収集）

### 3.1 Plan（計画）

**ユーザーとの対話で、設計方針を決定する**

#### ステップ1: 要件定義書の読み込み

```bash
# 要件定義書を読み込む
docs/02_要件定義書.md または docs/02_要件定義書/
```

**確認すべき項目:**
- [ ] 機能要件（どんな機能が必要か）
- [ ] 非機能要件（性能、セキュリティ、可用性等）
- [ ] 制約条件（予算、納期、技術スタック制約等）

#### ステップ2: アーキテクチャパターンの提案

**ユーザーへの質問例:**

> 「要件定義書を確認しました。以下のアーキテクチャパターンを検討しています:
>
> 1. **マイクロサービス** - サービスごとに独立してスケール可能
> 2. **モノリス** - シンプルな構成、開発速度優先
> 3. **サーバーレス** - インフラ管理不要、従量課金
>
> どのパターンが良さそうですか？または、他に希望はありますか？」

**重要**: 一度に複数の質問をしない。1つずつ確認する。

#### ステップ3: 技術スタックの提案

**ユーザーへの質問例:**

> 「アーキテクチャが決まったので、技術スタックを決めましょう。
>
> バックエンドは、要件定義書の『○○』を考慮すると、以下が候補です:
>
> - **Python (FastAPI)** - 開発速度が速い、AI/MLライブラリが豊富
> - **TypeScript (NestJS)** - 型安全、フロントエンドと統一
> - **Go** - 高速、並行処理が得意
>
> どれが良さそうですか？」

### 3.2 Do（実行）

**ユーザーの回答を受けて、決定事項を記録する**

**記録場所**: `.claude-state/design-decisions.json`

```json
{
  "phase": "design",
  "decisions": {
    "architecture": {
      "pattern": "microservices",
      "reason": "要件定義書 3.2.1節『サービスごとに独立してスケール』に対応",
      "alternatives": ["monolith", "serverless"],
      "tradeoffs": "運用複雑化するが、スケーラビリティ優先"
    },
    "techStack": {
      "backend": "Python (FastAPI)",
      "reason": "要件定義書 3.3.1節『AI/ML機能』に対応",
      "alternatives": ["TypeScript (NestJS)", "Go"],
      "tradeoffs": "Goより遅いが、AI/MLライブラリが豊富"
    }
  },
  "updatedAt": "2025-10-24T12:00:00Z"
}
```

### 3.3 Check（確認）

**決定事項を振り返る**

**確認すべき項目:**
- [ ] 要件定義書との整合性（すべての要件をカバーしているか）
- [ ] 技術標準の参照（技術標準を参照したか）
- [ ] 設計根拠の明記（すべての決定に理由があるか）

### 3.4 Act（改善）

**不足している項目を追加質問**

**例:**

> 「アーキテクチャと技術スタックが決まりました。
>
> 次に、データベース設計について決めましょう。
> 要件定義書の『○○』を考慮すると、以下が候補です:
>
> - **RDS (PostgreSQL)** - ACID保証、リレーショナル
> - **DynamoDB** - サーバーレス、スケーラビリティ高
>
> どちらが良さそうですか？」

---

## §4 PDCA 2周目（抜け漏れチェック）

### 4.1 Plan（計画）

**1周目で収集した決定事項を振り返る**

**確認すべき項目:**
- [ ] §1.2 の決定事項がすべて揃っているか
- [ ] 各決定事項に「選定理由」「代替案」「トレードオフ」があるか

### 4.2 Do（実行）

**不足している項目をユーザーに確認**

**例:**

> 「設計がほぼ固まってきました。最後に確認させてください。
>
> **運用設計**について、以下を決めたいです:
>
> 1. 監視・アラート設計
>    - CloudWatch Alarms で CPU使用率、メモリ使用率を監視
>    - アラート通知先: Slack
>
> 2. バックアップ・リストア設計
>    - RDSの自動バックアップ（7日間保持）
>    - S3のバックアップ（30日間保持）
>
> この方針で問題ないですか？または、追加で必要なものはありますか？」

### 4.3 Check（確認）

**設計書生成前の最終チェック**

#### チェックリスト

**A. 決定事項の網羅性**
- [ ] §1.2 の決定事項がすべて揃っている
- [ ] 各決定事項に「選定理由」「代替案」「トレードオフ」がある

**B. 要件定義書との整合性**
- [ ] すべての機能要件をカバーしている
- [ ] すべての非機能要件をカバーしている
- [ ] 制約条件を満たしている

**C. 技術標準の参照**
- [ ] 技術標準を参照している
- [ ] 技術標準から逸脱する場合、理由を明記している

### 4.4 Act（改善）

**「もっといい提案」を準備**

**ユーザーへの提案例:**

> 「設計がほぼ固まりました。ここまでの内容を振り返ると、以下のような改善案があります:
>
> 1. **コスト最適化**: RDSをReserved Instanceにすると年間30%削減
> 2. **可用性向上**: Multi-AZ構成にすると、可用性99.99%達成
> 3. **セキュリティ強化**: VPC Endpointを使うと、S3へのアクセスがインターネット経由にならない
>
> これらを採用しますか？または、現在の設計で進めますか？」

---

## §5 設計書生成

### 5.1 設計書生成の手順

**参照ドキュメント**: `2.3.13_基本設計書生成手順.md`

#### ステップ1: テンプレート読み込み

```bash
# 基本設計書テンプレートを読み込む
.claude/docs/10_facilitation/2.3_設計フェーズ/2.3.5_製造物_基本設計書構成.md
```

#### ステップ2: ドキュメント構造決定

**単一ファイル vs ディレクトリ構成**

| 条件 | 推奨構成 |
|------|---------|
| システム規模が小さい（ページ数50以下） | `docs/03_基本設計書.md` |
| システム規模が大きい（ページ数51以上） | `docs/03_基本設計書/` |

#### ステップ3: セクションごとに生成

**必須セクション（省略禁止）:**

##### 4章 アーキテクチャ設計

- [ ] 4.1.1 選定したパターン
- [ ] 4.1.2 選定理由 ⭐
- [ ] 4.1.3 検討した代替案 ⭐⭐ **省略禁止**
- [ ] 4.1.4 トレードオフ ⭐⭐ **省略禁止**

##### 5章 システム構成設計

- [ ] 5.1.1 インフラ構成
- [ ] 5.1.2 選定理由 ⭐
- [ ] 5.1.3 検討した代替案 ⭐⭐ **省略禁止**
- [ ] 5.1.4 トレードオフ ⭐⭐ **省略禁止**

##### 12章 実装方針設計

- [ ] 12.1.1 技術スタック選定
- [ ] 12.1.2 選定理由 ⭐
- [ ] 12.1.3 検討した代替案 ⭐⭐ **省略禁止**
- [ ] 12.1.4 トレードオフ ⭐⭐ **省略禁止**

#### ステップ4: 生成後チェック

**必須セクションチェック:**

```bash
# 設計書を読み込んで、必須セクションがあるか確認
docs/03_基本設計書.md または docs/03_基本設計書/
```

**確認項目:**
- [ ] すべての章に「選定理由」がある
- [ ] すべての章に「検討した代替案」がある（3つ以上）
- [ ] すべての章に「トレードオフ」がある

**よくある省略ミス:**
- ❌ 選定理由だけ書いて、代替案・トレードオフを省略
- ❌ 「検討した代替案」が1-2個しかない（3つ以上必要）
- ❌ 「トレードオフ」がメリットだけ（デメリットも必須）

### 5.2 設計書生成の流れ

**ユーザーへの確認:**

> 「設計がすべて決まりました。最後に振り返りをさせてください。
>
> **決定事項:**
> 1. アーキテクチャ: マイクロサービス
> 2. 技術スタック: Python (FastAPI)
> 3. データベース: RDS (PostgreSQL)
> 4. インフラ: AWS ECS Fargate
> 5. IaC: CloudFormation
>
> **設計根拠:**
> - すべて要件定義書の○○節に基づいています
> - 代替案も検討しました（詳細は設計書に記載）
>
> この内容で設計書を生成しても良いですか？
> または、追加で検討したいことはありますか？」

**ユーザーの承認後:**

> 「了解しました。基本設計書を生成します。
>
> **生成する設計書:**
> - `docs/03_基本設計書/` （ディレクトリ構成）
>
> 生成には5-10分かかります。少々お待ちください...」

---

## §6 次フェーズへの遷移判定

### 6.1 設計フェーズ完了条件

以下がすべて満たされたら、実装フェーズへ遷移できます:

#### A. 設計書の生成完了
- [ ] `docs/03_基本設計書.md` または `docs/03_基本設計書/` が存在する

#### B. 必須セクションの存在
- [ ] すべての章に「選定理由」がある
- [ ] すべての章に「検討した代替案」がある（3つ以上）
- [ ] すべての章に「トレードオフ」がある

#### C. 要件定義書との整合性
- [ ] すべての機能要件をカバーしている
- [ ] すべての非機能要件をカバーしている
- [ ] 制約条件を満たしている

#### D. 技術標準の参照
- [ ] 技術標準を参照している
- [ ] 技術標準から逸脱する場合、理由を明記している

### 6.2 次フェーズへの遷移

**ユーザーへの確認:**

> 「基本設計書の生成が完了しました。
>
> **生成した設計書:**
> - `docs/03_基本設計書/README.md` - 目次
> - `docs/03_基本設計書/01_システム概要.md`
> - `docs/03_基本設計書/02_アーキテクチャ設計.md`
> - ...
>
> 設計書をレビューして、問題なければ実装フェーズに進みます。
> 設計書を確認しますか？または、すぐに実装フェーズに進みますか？」

**プロジェクト状態の更新:**

```json
{
  "projectName": "プロジェクト名",
  "currentPhase": "implementation",
  "status": "ongoing",
  "completedPhases": ["planning", "requirements", "design"],
  "updatedAt": "2025-10-24T12:00:00Z"
}
```

---

## 📚 参考資料

### 設計フェーズの詳細プロセス

以下のファイルは、必要に応じて参照してください（必須ではありません）:

| ファイル | 内容 | 参照タイミング |
|---------|------|---------------|
| `2.3.1_要件レビュー.md` | 要件定義書のレビュー方法 | 要件定義書を読み込む時 |
| `2.3.2_アーキテクチャ設計手順.md` | アーキテクチャパターン選定 | アーキテクチャを決める時 |
| `2.3.3_システム構成設計手順.md` | インフラ構成設計 | インフラを決める時 |
| `2.3.4_データ設計手順.md` | データベース設計 | データベースを決める時 |
| `2.3.5_製造物_基本設計書構成.md` | 設計書テンプレート | 設計書を生成する時 |
| `2.3.7_実装方針設計.md` | 技術スタック選定 | 技術スタックを決める時 |
| `2.3.13_基本設計書生成手順.md` | 設計書生成手順 | 設計書を生成する時 |

### 技術標準

`.claude/docs/40_standards/` の技術標準を参照してください。

---

## 🚨 重要な注意事項

### 1. 一問一答の原則

**複数の質問を同時にしない**

❌ Bad:
> 「アーキテクチャはどれが良いですか？あと、データベースはどれにしますか？インフラはどこにしますか？」

✅ Good:
> 「アーキテクチャはどれが良いですか？」
> （ユーザーの回答を待つ）
> 「ありがとうございます。次に、データベースを決めましょう...」

### 2. 確認前の振り返り

**設計書生成前に必ず振り返る**

✅ Good:
> 「設計がすべて決まりました。最後に振り返りをさせてください。
>
> **決定事項:**
> 1. アーキテクチャ: ○○
> 2. 技術スタック: ○○
> ...
>
> この内容で設計書を生成しても良いですか？」

### 3. 設計根拠の明記

**すべての決定に「なぜそうしたか」を記載**

✅ Good:
```markdown
#### 4.1.2 選定理由

要件定義書 3.2.1節『サービスごとに独立してスケール』に対応するため、
マイクロサービスアーキテクチャを選定しました。
```

### 4. 代替案とトレードオフは省略禁止

**設計書の必須セクション**

✅ Good:
```markdown
#### 4.1.3 検討した代替案

| 方式 | メリット | デメリット | 不採用理由 |
|------|---------|-----------|-----------|
| モノリス | シンプル | スケールしにくい | 要件3.2.1節の要求を満たせない |
| サーバーレス | インフラ管理不要 | コールドスタート遅延 | 要件3.3.1節のレスポンスタイム要求を満たせない |

#### 4.1.4 トレードオフ

**メリット:**
- ✅ サービスごとに独立してスケール可能
- ✅ 技術スタックの選択肢が広い

**デメリット:**
- ❌ 運用が複雑化（サービス数増加）
- ❌ 分散トレーシングが必要

**判断:**
要件定義書 3.2.1節の要求を満たすため、運用複雑化を許容してマイクロサービスを採用。
```

---

**作成日**: 2025-10-24
**対象フェーズ**: 設計
**重要度**: ⭐⭐⭐ 最重要
