# 2.3.2 アーキテクチャ選定プロセス

## 目的

要件定義書をもとに、**技術スタック・アーキテクチャを選定する方法**を定義します。

---

## 🔄 選定フロー全体像

```mermaid
flowchart TB
    A[要件定義書確認] --> B[非機能要件抽出]
    B --> C[アーキテクチャパターン選定]
    C --> D[言語・FW選定]
    D --> E[データベース選定]
    E --> F[インフラ選定]
    F --> G[技術標準（`.claude/docs/40_standards/`）参照]
    G --> H{規約準拠可能?}
    H -->|Yes| I[選定決定]
    H -->|No| J[代替技術検討]
    J --> D
    I --> K[選定理由ドキュメント化]

    style G fill:#fff3cd
    style I fill:#c8e6c9
```

---

## 📋 要件から技術選定へのマッピング

### 非機能要件 → インフラ選定

| 非機能要件 | 推奨インフラ | 理由 |
|-----------|-------------|------|
| 同時アクセス < 100 | 小規模構成（EC2 1台） | コスト効率 |
| 同時アクセス 100～1000 | 中規模構成（ALB + EC2複数台） | スケーラビリティ |
| 同時アクセス > 1000 | 大規模構成（ECS/EKS） | 高スケーラビリティ |
| 稼働率 99.9%以上 | マルチAZ構成 | 高可用性 |
| グローバル展開 | CloudFront + マルチリージョン | 低レイテンシ |

### データ要件 → データベース選定

| データ要件 | 推奨データベース | 理由 |
|-----------|----------------|------|
| トランザクション必須 | PostgreSQL/MySQL（RDS） | ACID特性 |
| 大量データ・高速読み取り | DynamoDB | スケーラビリティ |
| 全文検索 | Elasticsearch | 検索性能 |
| キャッシュ | Redis（ElastiCache） | 高速アクセス |

### 外部連携要件 → API設計方針

| 外部連携要件 | 推奨API設計 | 理由 |
|-------------|------------|------|
| RESTful API | REST | 標準的・シンプル |
| リアルタイム通信 | WebSocket | 双方向通信 |
| 複雑なクエリ | GraphQL | 柔軟なデータ取得 |
| マイクロサービス間通信 | gRPC | 高性能・型安全 |

---

## 🏗️ アーキテクチャパターン選定

### モノリス vs マイクロサービス

```mermaid
flowchart TB
    A{チーム規模は?}
    A -->|小規模<5人| B[モノリス推奨]
    A -->|中～大規模>5人| C{システム複雑度は?}

    C -->|低～中| B
    C -->|高| D[マイクロサービス検討]

    D --> E{独立デプロイ必要?}
    E -->|Yes| F[マイクロサービス]
    E -->|No| B

    style B fill:#c8e6c9
    style F fill:#fff9c4
```

**判断基準:**
- **モノリス推奨**:
  - チーム規模: 小規模（5人以下）
  - システム複雑度: 低～中
  - 独立デプロイ不要
  - 開発速度重視

- **マイクロサービス推奨**:
  - チーム規模: 大規模（5人以上）
  - システム複雑度: 高
  - 独立デプロイ必要
  - スケーラビリティ重視

---

### サーバーレス vs コンテナ vs 仮想マシン

```mermaid
flowchart TB
    A{トラフィックパターンは?}
    A -->|変動大| B[サーバーレス<br/>Lambda]
    A -->|安定| C{運用負荷は?}

    C -->|最小化したい| D[コンテナ<br/>ECS Fargate]
    C -->|許容できる| E[仮想マシン<br/>EC2]

    style B fill:#d1ecf1
    style D fill:#fff9c4
    style E fill:#f5f5f5
```

**判断基準:**
- **Lambda（サーバーレス）**:
  - トラフィック変動大
  - コールドスタート許容
  - イベント駆動処理

- **ECS Fargate（コンテナ）**:
  - トラフィック安定
  - 運用負荷最小化
  - Docker経験あり

- **EC2（仮想マシン）**:
  - カスタマイズ必要
  - 既存資産あり
  - 運用ノウハウあり

---

## 💻 言語・フレームワーク選定基準

### 選定基準の優先順位

1. **技術標準（`.claude/docs/40_standards/`）への準拠** ⭐⭐⭐
2. チーム習熟度
3. エコシステム
4. 性能要件
5. 保守性

### 言語選定マトリクス

| 言語 | 得意分野 | 技術標準 | 推奨FW |
|------|---------|-----------|--------|
| Python | API、データ処理、AI/ML | 4.5 Python規約 | FastAPI, Django |
| TypeScript | フロントエンド、API | 4.6 TypeScript規約 | Express, NestJS |
| C# | エンタープライズ、Windows | 4.7 C# .NET Core規約 | ASP.NET Core |
| Go | マイクロサービス、高性能 | 4.8 Go言語規約 | Gin, Echo |

---

## 🗄️ データベース選定基準

### RDB vs NoSQL

```mermaid
flowchart TB
    A{トランザクション必要?}
    A -->|Yes| B[RDB]
    A -->|No| C{データ構造は?}

    C -->|固定| B
    C -->|柔軟| D[NoSQL]

    B --> E{スケール方法は?}
    E -->|垂直<br/>スケール| F[PostgreSQL/MySQL]
    E -->|水平<br/>スケール| G[Aurora]

    D --> H{アクセスパターンは?}
    H -->|Key-Value| I[DynamoDB]
    H -->|ドキュメント| J[MongoDB]
    H -->|グラフ| K[Neptune]

    style F fill:#c8e6c9
    style I fill:#d1ecf1
```

### 選定マトリクス

| データベース | 用途 | トランザクション | スケーラビリティ |
|------------|------|----------------|----------------|
| PostgreSQL | 汎用RDB | ✅ | 中 |
| MySQL | 汎用RDB | ✅ | 中 |
| Aurora | 高性能RDB | ✅ | 高 |
| DynamoDB | NoSQL | ❌ | 高 |
| ElastiCache（Redis） | キャッシュ | ❌ | 高 |

---

## ☁️ インフラ選定（AWS/GCP/Azure）

### クラウドベンダー選定基準

```mermaid
flowchart TB
    A{既存システムは?}
    A -->|AWS| B[AWS継続]
    A -->|GCP| C[GCP継続]
    A -->|Azure| D[Azure継続]
    A -->|なし| E{チーム習熟度は?}

    E -->|AWS得意| B
    E -->|GCP得意| C
    E -->|Azure得意| D
    E -->|どれも同じ| F{企業向け?}

    F -->|Yes| D
    F -->|No| B

    style B fill:#ff9900
    style C fill:#4285f4
    style D fill:#00a4ef
```

### CloudFormation vs Terraform

| 項目 | CloudFormation | Terraform |
|------|---------------|-----------|
| 技術標準 | 4.3 CloudFormation規約 | 4.4 Terraform規約 |
| 対応クラウド | AWS専用 | マルチクラウド |
| 学習コスト | 低 | 中 |
| 状態管理 | AWS管理 | 自己管理 |
| 推奨ケース | AWS専用 | マルチクラウド |

---

## 📝 選定結果の記録方法

### テンプレート

```markdown
# 技術選定ドキュメント

## 選定日
2025-10-19

## 選定した技術スタック

### バックエンド
- **選定技術**: TypeScript + Express
- **選定理由**:
  1. 技術標準（`.claude/docs/40_standards/`）に準拠（4.6 TypeScript規約）
  2. チーム習熟度が高い
  3. エコシステムが充実（npm）
  4. 非機能要件（レスポンスタイム 3秒以内）を満たせる
- **代替案**: Python（FastAPI）
- **代替案を選ばなかった理由**: チーム習熟度がTypeScriptのほうが高い

### データベース
- **選定技術**: PostgreSQL（AWS RDS）
- **選定理由**:
  1. トランザクション要件を満たせる
  2. 信頼性が高い
  3. AWSマネージドサービスで運用負荷削減
- **代替案**: MySQL
- **代替案を選ばなかった理由**: PostgreSQLのほうが機能豊富

### インフラ
- **選定技術**: AWS + CloudFormation
- **選定理由**:
  1. AWS専用のため、CloudFormationが最適
  2. 技術標準（`.claude/docs/40_standards/`）に準拠（4.3 CloudFormation規約）
  3. Infrastructure as Code で再現性確保
- **代替案**: Terraform
- **代替案を選ばなかった理由**: AWS専用なのでCloudFormationで十分

## 参照した技術標準（`.claude/docs/40_standards/`） ⭐

- 4.6 Node.js/TypeScript規約
- 4.3 CloudFormation規約
- 4.9 セキュリティ・運用基準（必須）

## 非機能要件への対応

| 非機能要件 | 対応方針 |
|-----------|---------|
| レスポンスタイム 3秒以内 | Redis（ElastiCache）でキャッシュ |
| 同時アクセス 100ユーザー | ALB + EC2 x2（オートスケーリング） |
| 稼働率 99.9% | マルチAZ構成 |
```

---

## 🎯 Good/Bad Example

### ❌ Bad Example

```markdown
## 選定した技術スタック
- バックエンド: TypeScript
- データベース: PostgreSQL
- インフラ: AWS
```

**問題点:**
- 選定理由がない
- 技術標準（`.claude/docs/40_standards/`）への言及がない
- 非機能要件への対応が不明

---

### ✅ Good Example

```markdown
## 選定した技術スタック

### バックエンド
- **選定技術**: TypeScript + Express
- **選定理由**:
  1. **技術標準（`.claude/docs/40_standards/`）に準拠（4.6 TypeScript規約）** ⭐
  2. チーム習熟度が高い
  3. 非機能要件を満たせる

### 参照した技術標準（`.claude/docs/40_standards/`）
- 4.6 Node.js/TypeScript規約
- 4.9 セキュリティ・運用基準
```

**改善点:**
- 選定理由を明記
- 技術標準（`.claude/docs/40_standards/`）への準拠を確認
- 非機能要件への対応を考慮

---

## 📚 関連ドキュメント

- [2.3.1 フェーズ概要](./2.3.1_フェーズ概要.md)
- [2.3.3 技術標準参照ガイド](./2.3.3_技術標準参照ガイド.md)
- [2.3.7 インフラ設計パターン選定](./2.3.7_インフラ設計パターン選定.md)

---

**作成日**: 2025-10-19
**対象フェーズ**: 設計
**重要度**: ⭐⭐⭐ 必須（技術選定の方法論）
