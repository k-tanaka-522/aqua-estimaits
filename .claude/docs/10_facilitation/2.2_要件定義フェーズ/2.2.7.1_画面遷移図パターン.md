# 2.2.7.1 画面遷移図パターン（Mermaid）

## 目的

要件定義フェーズで、**画面遷移を視覚的に表現**するためのMermaid図パターンを提供します。

### このドキュメントで得られること

1. すぐに使えるMermaid画面遷移図のテンプレート
2. ドメインごとの具体例
3. よくある失敗パターンと改善方法

---

## 📊 基本パターン

### シンプルな画面遷移

```mermaid
flowchart TB
    A[ログイン画面] -->|ログイン成功| B[ホーム画面]
    A -->|ログイン失敗| A
    B -->|商品検索| C[商品一覧]
    C -->|商品選択| D[商品詳細]
    D -->|カートに追加| E[カート画面]
    E -->|購入| F[注文確認]
    F -->|確定| G[完了画面]

    style A fill:#e1f5ff
    style G fill:#c8e6c9
```

**使い方**:
- 矩形 `[画面名]` で画面を表現
- 矢印 `-->` で遷移を表現
- `|アクション|` で遷移条件を記述

---

## 🎯 ドメイン別パターン

### 1. ECサイト

```mermaid
flowchart TB
    Start([ユーザー訪問])

    subgraph 認証系
        Login[ログイン画面]
        Signup[新規登録画面]
    end

    subgraph 商品系
        Top[トップページ]
        Search[商品検索]
        List[商品一覧]
        Detail[商品詳細]
    end

    subgraph 購入系
        Cart[カート]
        Checkout[注文確認]
        Payment[決済画面]
        Complete[完了画面]
    end

    subgraph マイページ
        MyPage[マイページ]
        Orders[注文履歴]
        Profile[プロフィール編集]
    end

    Start -->|初回訪問| Login
    Start -->|会員| Top
    Login -->|新規登録| Signup
    Signup -->|登録完了| Top
    Login -->|ログイン成功| Top

    Top -->|検索| Search
    Search -->|検索実行| List
    List -->|商品選択| Detail
    Detail -->|カートに追加| Cart

    Cart -->|購入手続き| Checkout
    Checkout -->|決済| Payment
    Payment -->|決済完了| Complete

    Top -->|マイページ| MyPage
    MyPage -->|注文履歴| Orders
    MyPage -->|プロフィール| Profile

    style Login fill:#e1f5ff
    style Complete fill:#c8e6c9
    style Payment fill:#fff9c4
```

**ポイント**:
- `subgraph` で機能をグルーピング
- 色分けで重要な画面を強調
- 開始/終了を明確に

---

### 2. 予約システム

```mermaid
stateDiagram-v2
    [*] --> トップページ

    トップページ --> 施設選択
    施設選択 --> カレンダー表示
    カレンダー表示 --> 時間選択
    時間選択 --> 予約者情報入力
    予約者情報入力 --> 確認画面
    確認画面 --> 予約完了
    予約完了 --> [*]

    確認画面 --> 時間選択: 戻る
    時間選択 --> カレンダー表示: 戻る
    カレンダー表示 --> 施設選択: 戻る

    トップページ --> ログイン
    ログイン --> マイページ
    マイページ --> 予約履歴
    予約履歴 --> 予約詳細
    予約詳細 --> キャンセル確認
    キャンセル確認 --> キャンセル完了
    キャンセル完了 --> 予約履歴
```

**ポイント**:
- `stateDiagram-v2` で状態遷移を表現
- 戻るボタンの動線も明記
- キャンセルフローを含める

---

### 3. 業務システム（商談管理）

```mermaid
flowchart TB
    subgraph 認証
        A1[ログイン画面]
        A2[パスワード再設定]
    end

    subgraph メイン画面
        B1[ダッシュボード]
        B2[商談一覧]
        B3[商談詳細]
        B4[商談登録]
        B5[商談編集]
    end

    subgraph 顧客管理
        C1[顧客一覧]
        C2[顧客詳細]
        C3[顧客登録]
    end

    subgraph レポート
        D1[売上レポート]
        D2[営業活動レポート]
    end

    subgraph 設定
        E1[マスタ管理]
        E2[ユーザー管理]
    end

    A1 -->|ログイン成功| B1
    A1 -->|パスワード忘れ| A2
    A2 -->|再設定完了| A1

    B1 -->|商談一覧| B2
    B1 -->|レポート| D1
    B1 -->|設定| E1

    B2 -->|詳細| B3
    B2 -->|新規登録| B4
    B3 -->|編集| B5
    B3 -->|顧客詳細| C2
    B4 -->|保存| B2
    B5 -->|保存| B3

    B2 -->|顧客管理| C1
    C1 -->|詳細| C2
    C1 -->|新規登録| C3
    C3 -->|保存| C1

    D1 -->|営業活動| D2
    D1 -->|ダッシュボード| B1

    E1 -->|ユーザー管理| E2

    style A1 fill:#e1f5ff
    style B1 fill:#fff9c4
    style B4 fill:#c8e6c9
```

**ポイント**:
- 業務の役割ごとにsubgraphで整理
- CRUD操作の流れを明確に
- マスタ管理・設定画面も含める

---

### 4. SNS・コミュニティサイト

```mermaid
flowchart TB
    subgraph 公開エリア
        A1[トップページ]
        A2[投稿一覧]
        A3[投稿詳細]
    end

    subgraph 認証
        B1[ログイン]
        B2[新規登録]
    end

    subgraph 投稿系
        C1[投稿作成]
        C2[投稿編集]
        C3[コメント入力]
    end

    subgraph マイページ
        D1[マイページ]
        D2[プロフィール編集]
        D3[フォロー一覧]
        D4[フォロワー一覧]
        D5[通知一覧]
    end

    A1 -->|投稿一覧| A2
    A2 -->|投稿選択| A3
    A1 -->|ログイン| B1
    A1 -->|新規登録| B2

    B1 -->|ログイン成功| A1
    B2 -->|登録完了| A1

    A3 -->|いいね| A3
    A3 -->|コメント| C3
    A3 -->|投稿者| D1

    A1 -->|投稿作成<br/>※要ログイン| C1
    C1 -->|投稿| A2
    A3 -->|編集<br/>※本人のみ| C2
    C2 -->|更新| A3

    A1 -->|マイページ<br/>※要ログイン| D1
    D1 -->|プロフィール編集| D2
    D1 -->|フォロー一覧| D3
    D1 -->|フォロワー一覧| D4
    D1 -->|通知| D5

    D3 -->|ユーザー選択| D1
    D4 -->|ユーザー選択| D1

    style B1 fill:#e1f5ff
    style C1 fill:#fff9c4
    style D1 fill:#c8e6c9
```

**ポイント**:
- ログイン有無での動作の違いを明記
- 権限に応じた画面遷移を記載（「※本人のみ」等）
- ソーシャル機能（フォロー、いいね）を含める

---

## 🔄 条件分岐のパターン

### ログイン状態による分岐

```mermaid
flowchart TB
    A[トップページ] --> B{ログイン状態}
    B -->|未ログイン| C[ログイン画面]
    B -->|ログイン済み| D[マイページ]

    C -->|ログイン成功| D
    C -->|新規登録| E[新規登録画面]
    E -->|登録完了| D

    style B fill:#fff9c4
```

**使い方**:
- 菱形 `{}` で条件分岐を表現
- 条件を `|条件|` で記述

---

### 権限による分岐

```mermaid
flowchart TB
    A[商談詳細] --> B{権限チェック}

    B -->|管理者| C[すべての機能]
    B -->|マネージャー| D[チーム内の商談のみ]
    B -->|営業担当者| E[自分の商談のみ]

    C --> F[編集・削除可能]
    D --> G[閲覧・コメント可能]
    E --> H[閲覧のみ]

    style B fill:#fff9c4
```

---

### エラー時の分岐

```mermaid
flowchart TB
    A[フォーム送信] --> B{バリデーション}

    B -->|成功| C[確認画面]
    B -->|エラー| D[フォーム画面<br/>エラーメッセージ表示]

    D -->|再送信| A

    C --> E{保存処理}
    E -->|成功| F[完了画面]
    E -->|エラー| G[エラー画面]

    G -->|リトライ| C
    G -->|キャンセル| A

    style B fill:#fff9c4
    style E fill:#fff9c4
    style G fill:#ffcdd2
```

**ポイント**:
- バリデーションエラーとシステムエラーを分ける
- リトライ・キャンセルの動線を明記
- エラー画面は赤系で強調

---

## ❌ Bad Example: よくある失敗パターン

### 問題1: 矢印が多すぎて読めない

```mermaid
flowchart TB
    A[画面A] --> B[画面B]
    A --> C[画面C]
    A --> D[画面D]
    B --> C
    B --> D
    B --> E[画面E]
    C --> D
    C --> E
    D --> E
    E --> A
    E --> B
    E --> C
```

**問題点**:
- 矢印が交差して複雑
- 全体の流れが不明

---

### ✅ Good Example: subgraphで整理

```mermaid
flowchart TB
    subgraph メイン
        A[ホーム]
    end

    subgraph 登録系
        B[登録画面]
        C[確認画面]
        D[完了画面]
    end

    subgraph 検索系
        E[検索画面]
        F[結果一覧]
    end

    A --> B
    B --> C
    C --> D

    A --> E
    E --> F

    D --> A
    F --> A
```

**改善点**:
- subgraphで機能をグルーピング
- 一方向の流れを意識
- 戻る動線を最小限に

---

### 問題2: 遷移条件が不明

```mermaid
flowchart TB
    A[画面A] --> B[画面B]
    B --> C[画面C]
    C --> D[画面D]
```

**問題点**:
- どのボタンを押したら遷移するのか不明
- ユーザーアクションが不明

---

### ✅ Good Example: アクションを明記

```mermaid
flowchart TB
    A[商品一覧] -->|商品をクリック| B[商品詳細]
    B -->|カートに追加ボタン| C[カート画面]
    C -->|購入ボタン| D[注文確認]
    D -->|確定ボタン| E[完了画面]
```

**改善点**:
- ボタン名・アクション名を明記
- 開発者が実装しやすい

---

## 🎨 スタイリングのベストプラクティス

### 色分けルール

```mermaid
flowchart TB
    A[開始画面]
    B[通常画面]
    C[重要画面]
    D[エラー画面]
    E[完了画面]

    A --> B --> C --> D
    C --> E

    style A fill:#e1f5ff
    style B fill:#f5f5f5
    style C fill:#fff9c4
    style D fill:#ffcdd2
    style E fill:#c8e6c9
```

**推奨色**:
- **開始画面**: 水色 `#e1f5ff`
- **通常画面**: グレー `#f5f5f5`
- **重要画面**: 黄色 `#fff9c4`
- **エラー画面**: 赤 `#ffcdd2`
- **完了画面**: 緑 `#c8e6c9`

---

## 📝 テンプレート

### 基本テンプレート

```markdown
## 画面遷移図

```mermaid
flowchart TB
    subgraph 認証
        A[ログイン画面]
    end

    subgraph メイン機能
        B[ホーム画面]
        C[一覧画面]
        D[詳細画面]
        E[登録画面]
    end

    A -->|ログイン成功| B
    B -->|一覧表示| C
    C -->|選択| D
    B -->|新規登録| E
    E -->|保存| C

    style A fill:#e1f5ff
    style E fill:#c8e6c9
```

**説明**:
- 主な画面遷移を記述
- ユーザーの主要な動線を明示
```

---

## 🔧 実装時の注意点

### 1. Mermaid図の制限

- **ブラウザバック**: 記載不要（暗黙の動作）
- **モーダル**: 別図で表現
- **タブ切り替え**: 同一画面内の動作なので記載不要

### 2. 粒度の調整

**要件定義では**:
- 画面単位で記載
- 細かい入力項目は記載不要

**詳細設計では**:
- モーダル、タブも含める
- 状態遷移も詳細に

### 3. ツールとの連携

生成したMermaid図は以下で確認:
- **Mermaid Live Editor**: https://mermaid.live/
- **VS Code拡張機能**: Mermaid Preview
- **技術標準**: Mermaid埋め込み可能

---

## 📚 次のステップ

画面遷移図を理解したら:

1. **2.2.7.2 ER図パターン.md** へ進む
2. データベース設計の可視化を学ぶ
3. 実際のプロジェクトで画面遷移図を作成

---

## 関連ドキュメント

- [2.2.2.2 画面・UI/UXヒアリング項目](./2.2.2.2_画面・UI_UXヒアリング項目.md)
- [2.2.5.2 ユースケース記述方法](./2.2.5.2_ユースケース記述方法.md)
- [2.2.7.5 シーケンス図（業務フロー）](./2.2.7.5_シーケンス図（業務フロー）.md)

---

**作成日**: 2025-10-19
**対象フェーズ**: 要件定義
**重要度**: ⭐⭐ 推奨（画面遷移の可視化）
