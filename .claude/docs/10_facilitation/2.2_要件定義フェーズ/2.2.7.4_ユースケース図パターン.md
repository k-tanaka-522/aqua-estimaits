# 2.2.7.4 ユースケース図パターン（Mermaid）

## 目的

要件定義フェーズで、**ユーザー（アクター）とシステムの相互作用**を視覚的に表現するためのMermaid図パターンを提供します。

### このドキュメントで得られること

1. すぐに使えるMermaidユースケース図のテンプレート
2. ドメインごとの具体例
3. アクターと機能の関係の描き方

---

## 📊 基本パターン

### シンプルなユースケース図

```mermaid
flowchart LR
    subgraph システム境界
        UC1[商品を検索する]
        UC2[商品をカートに追加する]
        UC3[注文する]
        UC4[注文履歴を確認する]
    end

    User([ユーザー])
    Admin([管理者])

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    Admin --> UC4

    style UC1 fill:#e1f5ff
    style UC2 fill:#e1f5ff
    style UC3 fill:#c8e6c9
    style UC4 fill:#fff9c4
```

**ポイント**:
- アクター（ユーザー、管理者）を明確に
- システム境界内にユースケースを配置
- 矢印でアクターと機能を結ぶ

---

## 🎯 ドメイン別パターン

### 1. ECサイト

```mermaid
flowchart TB
    subgraph ECサイト
        direction TB

        subgraph 商品管理
            UC1[商品を検索する]
            UC2[商品詳細を見る]
            UC3[レビューを投稿する]
        end

        subgraph 購入
            UC4[カートに追加する]
            UC5[注文する]
            UC6[決済する]
        end

        subgraph マイページ
            UC7[注文履歴を見る]
            UC8[プロフィールを編集する]
        end

        subgraph 管理機能
            UC9[商品を登録する]
            UC10[在庫を管理する]
            UC11[注文を管理する]
        end
    end

    Customer([顧客])
    Admin([管理者])
    PaymentSystem([決済システム])

    Customer --> UC1
    Customer --> UC2
    Customer --> UC3
    Customer --> UC4
    Customer --> UC5
    Customer --> UC6
    Customer --> UC7
    Customer --> UC8

    Admin --> UC9
    Admin --> UC10
    Admin --> UC11

    UC6 -.->|include| PaymentSystem

    style UC6 fill:#fff9c4
    style UC9 fill:#ffcdd2
    style UC10 fill:#ffcdd2
    style UC11 fill:#ffcdd2
```

**ポイント**:
- 機能をカテゴリ別にsubgraphでグルーピング
- 外部システム（決済）も記載
- `include`関係を点線で表現

---

### 2. 予約システム

```mermaid
flowchart TB
    subgraph 予約システム
        direction TB

        subgraph 施設管理
            UC1[施設を検索する]
            UC2[空き状況を確認する]
        end

        subgraph 予約
            UC3[予約する]
            UC4[予約を変更する]
            UC5[予約をキャンセルする]
        end

        subgraph マイページ
            UC6[予約履歴を見る]
            UC7[プロフィールを編集する]
        end

        subgraph 管理機能
            UC8[施設を登録する]
            UC9[予約を管理する]
            UC10[利用者を管理する]
        end
    end

    User([利用者])
    Admin([管理者])
    Calendar([カレンダーAPI])

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC6
    User --> UC7

    Admin --> UC8
    Admin --> UC9
    Admin --> UC10

    UC3 -.->|include| Calendar
    UC4 -.->|include| Calendar
    UC5 -.->|include| Calendar

    style UC3 fill:#c8e6c9
    style UC4 fill:#fff9c4
    style UC5 fill:#ffcdd2
```

**ポイント**:
- 予約・変更・キャンセルを色分け
- 外部APIとの連携を明記

---

### 3. 業務システム（商談管理CRM）

```mermaid
flowchart TB
    subgraph 商談管理システム
        direction TB

        subgraph 商談管理
            UC1[商談を登録する]
            UC2[商談を編集する]
            UC3[商談を検索する]
            UC4[商談詳細を見る]
        end

        subgraph 顧客管理
            UC5[顧客を登録する]
            UC6[顧客情報を編集する]
            UC7[顧客を検索する]
        end

        subgraph 活動管理
            UC8[活動を記録する]
            UC9[活動履歴を見る]
        end

        subgraph レポート
            UC10[売上レポートを見る]
            UC11[営業活動レポートを見る]
        end

        subgraph 承認フロー
            UC12[商談を承認する]
            UC13[承認依頼を送る]
        end
    end

    Sales([営業担当者])
    Manager([マネージャー])
    Admin([管理者])

    Sales --> UC1
    Sales --> UC2
    Sales --> UC3
    Sales --> UC4
    Sales --> UC5
    Sales --> UC6
    Sales --> UC7
    Sales --> UC8
    Sales --> UC9
    Sales --> UC13

    Manager --> UC3
    Manager --> UC4
    Manager --> UC9
    Manager --> UC10
    Manager --> UC11
    Manager --> UC12

    Admin --> UC1
    Admin --> UC2
    Admin --> UC3
    Admin --> UC4
    Admin --> UC10
    Admin --> UC11

    style UC12 fill:#fff9c4
    style UC13 fill:#fff9c4
```

**ポイント**:
- 役割ごとのアクセス権限を明確に
- 承認フローを強調
- レポート機能を分離

---

### 4. SNS・コミュニティサイト

```mermaid
flowchart TB
    subgraph SNS
        direction TB

        subgraph 投稿
            UC1[投稿を作成する]
            UC2[投稿を編集する]
            UC3[投稿を削除する]
            UC4[投稿を検索する]
        end

        subgraph インタラクション
            UC5[いいねする]
            UC6[コメントする]
            UC7[シェアする]
        end

        subgraph フォロー
            UC8[ユーザーをフォローする]
            UC9[フォローを解除する]
            UC10[フォロワーを見る]
        end

        subgraph マイページ
            UC11[プロフィールを編集する]
            UC12[通知を見る]
        end

        subgraph モデレーション
            UC13[投稿を削除する<br/>（不適切コンテンツ）]
            UC14[ユーザーを停止する]
        end
    end

    User([ユーザー])
    Moderator([モデレーター])

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC6
    User --> UC7
    User --> UC8
    User --> UC9
    User --> UC10
    User --> UC11
    User --> UC12

    Moderator --> UC13
    Moderator --> UC14

    style UC13 fill:#ffcdd2
    style UC14 fill:#ffcdd2
```

**ポイント**:
- ソーシャル機能（いいね、コメント、フォロー）
- モデレーション機能を分離
- 不適切コンテンツ削除を強調

---

## 🔄 関係性のパターン

### Include関係（必須の依存）

```mermaid
flowchart LR
    User([ユーザー])

    subgraph システム
        UC1[商品を購入する]
        UC2[ログインする]
        UC3[決済する]
    end

    User --> UC1
    UC1 -.->|include| UC2
    UC1 -.->|include| UC3

    style UC1 fill:#c8e6c9
    style UC2 fill:#fff9c4
    style UC3 fill:#fff9c4
```

**解説**:
- 「商品を購入する」には「ログイン」と「決済」が必須
- `include`は点線で表現

---

### Extend関係（オプションの拡張）

```mermaid
flowchart LR
    User([ユーザー])

    subgraph システム
        UC1[商品を検索する]
        UC2[詳細条件で絞り込む]
    end

    User --> UC1
    UC2 -.->|extend| UC1

    style UC1 fill:#e1f5ff
    style UC2 fill:#fff9c4
```

**解説**:
- 「詳細条件で絞り込む」は「商品を検索する」のオプション機能
- `extend`は点線で表現

---

### 汎化関係（継承）

```mermaid
flowchart TB
    Admin([管理者])
    SuperAdmin([スーパー管理者])

    subgraph システム
        UC1[ユーザーを管理する]
        UC2[システム設定を変更する]
    end

    Admin --> UC1
    SuperAdmin --> UC1
    SuperAdmin --> UC2

    SuperAdmin -.->|汎化| Admin

    style UC2 fill:#ffcdd2
```

**解説**:
- スーパー管理者は管理者の権限を継承
- 追加で「システム設定を変更する」権限も持つ

---

## ❌ Bad Example: よくある失敗パターン

### 問題1: アクターが不明確

```mermaid
flowchart LR
    subgraph システム
        UC1[データを登録する]
        UC2[データを検索する]
        UC3[データを削除する]
    end
```

**問題点**:
- アクター（誰が使うか）が不明
- 権限管理が不明確

---

### ✅ Good Example: アクターを明記

```mermaid
flowchart LR
    User([一般ユーザー])
    Admin([管理者])

    subgraph システム
        UC1[データを登録する]
        UC2[データを検索する]
        UC3[データを削除する]
    end

    User --> UC1
    User --> UC2
    Admin --> UC3

    style UC3 fill:#ffcdd2
```

**改善点**:
- 誰が何をできるかが明確
- 削除は管理者のみ

---

### 問題2: 機能が多すぎて読めない

```mermaid
flowchart TB
    User([ユーザー])

    subgraph システム
        UC1[機能A]
        UC2[機能B]
        UC3[機能C]
        UC4[機能D]
        UC5[機能E]
        UC6[機能F]
        UC7[機能G]
        UC8[機能H]
        UC9[機能I]
        UC10[機能J]
    end

    User --> UC1
    User --> UC2
    User --> UC3
    User --> UC4
    User --> UC5
    User --> UC6
    User --> UC7
    User --> UC8
    User --> UC9
    User --> UC10
```

**問題点**:
- 機能が多すぎて全体像が見えない

---

### ✅ Good Example: カテゴリ別にグルーピング

```mermaid
flowchart TB
    User([ユーザー])

    subgraph システム
        subgraph カテゴリA
            UC1[機能A]
            UC2[機能B]
            UC3[機能C]
        end

        subgraph カテゴリB
            UC4[機能D]
            UC5[機能E]
            UC6[機能F]
        end

        subgraph カテゴリC
            UC7[機能G]
            UC8[機能H]
        end
    end

    User --> UC1
    User --> UC4
    User --> UC7
```

**改善点**:
- subgraphで機能をグルーピング
- 主要な動線のみを記載

---

## 📝 テンプレート

### 基本テンプレート

```markdown
## ユースケース図

```mermaid
flowchart TB
    subgraph システム名
        direction TB

        subgraph カテゴリ1
            UC1[機能A]
            UC2[機能B]
        end

        subgraph カテゴリ2
            UC3[機能C]
            UC4[機能D]
        end
    end

    Actor1([アクター1])
    Actor2([アクター2])

    Actor1 --> UC1
    Actor1 --> UC2
    Actor2 --> UC3
    Actor2 --> UC4

    style UC1 fill:#e1f5ff
    style UC3 fill:#fff9c4
```

**説明**:
- アクターとユースケースの関係を記述
- 機能をカテゴリ別にグルーピング
```

---

## 🔧 実装時の注意点

### 1. Mermaidの制限

Mermaid flowchartでユースケース図を表現するため:
- UML標準のユースケース図（楕円形）とは異なる
- flowchartで代用
- 内容は同じ（アクターと機能の関係）

### 2. 粒度の調整

**要件定義では**:
- 主要なユースケースのみ
- 細かい機能は省略

**詳細設計では**:
- すべてのユースケースを記載
- include/extend関係も詳細に

### 3. アクターの種類

- **人間**: ユーザー、管理者、営業担当者等
- **外部システム**: 決済API、カレンダーAPI等
- **時間**: バッチ処理（夜間実行等）

---

## 📚 次のステップ

ユースケース図を理解したら:

1. **2.2.7.5 シーケンス図（業務フロー）.md** へ進む
2. 時系列での処理の流れを学ぶ
3. 実際のプロジェクトでユースケース図を作成

---

## 関連ドキュメント

- [2.2.5.2 ユースケース記述方法](./2.2.5.2_ユースケース記述方法.md)
- [2.2.7.1 画面遷移図パターン](./2.2.7.1_画面遷移図パターン.md)
- [2.2.7.5 シーケンス図（業務フロー）](./2.2.7.5_シーケンス図（業務フロー）.md)

---

**作成日**: 2025-10-19
**対象フェーズ**: 要件定義
**重要度**: ⭐⭐ 推奨（ユーザーとシステムの関係を可視化）
