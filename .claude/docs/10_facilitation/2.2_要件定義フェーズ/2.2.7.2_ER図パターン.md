# 2.2.7.2 ER図パターン（Mermaid）

## 目的

要件定義フェーズで、**データ構造とエンティティ間の関係**を視覚的に表現するためのMermaid ER図パターンを提供します。

### このドキュメントで得られること

1. すぐに使えるMermaid ER図のテンプレート
2. ドメインごとの具体例
3. カーディナリティ（1:1, 1:N, N:N）の表現方法

---

## 📊 基本パターン

### シンプルなER図

```mermaid
erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ ORDER_ITEM : contains
    PRODUCT ||--o{ ORDER_ITEM : "ordered in"

    CUSTOMER {
        int id PK
        string name
        string email UK
        datetime created_at
    }

    ORDER {
        int id PK
        int customer_id FK
        datetime order_date
        string status
    }

    ORDER_ITEM {
        int id PK
        int order_id FK
        int product_id FK
        int quantity
        decimal price
    }

    PRODUCT {
        int id PK
        string name
        decimal price
        int stock
    }
```

**記法**:
- `||--o{` : 1対多（1つの顧客が複数の注文）
- `||--|{` : 1対多必須
- `PK` : Primary Key
- `FK` : Foreign Key
- `UK` : Unique Key

---

## 🎯 カーディナリティの表現

### 1対1 (1:1)

```mermaid
erDiagram
    USER ||--|| PROFILE : has

    USER {
        int id PK
        string email UK
    }

    PROFILE {
        int id PK
        int user_id FK
        string display_name
        text bio
    }
```

**解説**: 1人のユーザーに1つのプロフィール

---

### 1対多 (1:N)

```mermaid
erDiagram
    COMPANY ||--o{ EMPLOYEE : employs

    COMPANY {
        int id PK
        string name
    }

    EMPLOYEE {
        int id PK
        int company_id FK
        string name
        string position
    }
```

**解説**: 1つの会社が複数の従業員を雇用

---

### 多対多 (N:N)

```mermaid
erDiagram
    STUDENT }o--o{ COURSE : enrolls
    STUDENT ||--o{ ENROLLMENT : ""
    COURSE ||--o{ ENROLLMENT : ""

    STUDENT {
        int id PK
        string name
    }

    COURSE {
        int id PK
        string name
    }

    ENROLLMENT {
        int id PK
        int student_id FK
        int course_id FK
        datetime enrolled_at
        int grade
    }
```

**解説**:
- 学生と授業は多対多
- 中間テーブル `ENROLLMENT` で実現
- 中間テーブルに追加情報（成績等）も保存可能

---

## 🏢 ドメイン別パターン

### 1. ECサイト

```mermaid
erDiagram
    CUSTOMER ||--o{ ORDER : places
    CUSTOMER ||--o{ CART : has
    ORDER ||--|{ ORDER_ITEM : contains
    PRODUCT ||--o{ ORDER_ITEM : "ordered in"
    PRODUCT ||--o{ CART_ITEM : "in cart"
    CART ||--|{ CART_ITEM : contains
    CATEGORY ||--o{ PRODUCT : categorizes
    PRODUCT ||--o{ REVIEW : receives

    CUSTOMER {
        int id PK
        string name
        string email UK
        string password_hash
        datetime created_at
    }

    ORDER {
        int id PK
        int customer_id FK
        datetime order_date
        string status "pending, paid, shipped, delivered"
        decimal total_amount
    }

    ORDER_ITEM {
        int id PK
        int order_id FK
        int product_id FK
        int quantity
        decimal unit_price
        decimal subtotal
    }

    PRODUCT {
        int id PK
        int category_id FK
        string name
        text description
        decimal price
        int stock
        datetime created_at
    }

    CATEGORY {
        int id PK
        string name
        int parent_id FK "自己参照"
    }

    CART {
        int id PK
        int customer_id FK
        datetime created_at
    }

    CART_ITEM {
        int id PK
        int cart_id FK
        int product_id FK
        int quantity
    }

    REVIEW {
        int id PK
        int product_id FK
        int customer_id FK
        int rating "1-5"
        text comment
        datetime created_at
    }
```

**ポイント**:
- カート機能を含める
- レビュー機能も含める
- カテゴリの階層構造（parent_id）

---

### 2. 予約システム

```mermaid
erDiagram
    USER ||--o{ RESERVATION : makes
    FACILITY ||--o{ TIME_SLOT : has
    TIME_SLOT ||--o| RESERVATION : "reserved by"
    FACILITY ||--o{ FACILITY_IMAGE : has
    FACILITY_TYPE ||--o{ FACILITY : categorizes

    USER {
        int id PK
        string name
        string email UK
        string phone
        datetime created_at
    }

    FACILITY {
        int id PK
        int facility_type_id FK
        string name
        text description
        int capacity
        decimal hourly_rate
    }

    FACILITY_TYPE {
        int id PK
        string name "会議室, スタジオ, etc"
    }

    TIME_SLOT {
        int id PK
        int facility_id FK
        date date
        time start_time
        time end_time
        boolean is_available
    }

    RESERVATION {
        int id PK
        int user_id FK
        int time_slot_id FK
        string status "pending, confirmed, cancelled"
        decimal price
        datetime created_at
    }

    FACILITY_IMAGE {
        int id PK
        int facility_id FK
        string url
        int display_order
    }
```

**ポイント**:
- TIME_SLOTで時間枠を管理
- 予約状態（pending, confirmed, cancelled）
- 施設画像の複数保存

---

### 3. 業務システム（商談管理CRM）

```mermaid
erDiagram
    USER ||--o{ DEAL : owns
    COMPANY ||--o{ DEAL : "has deals"
    COMPANY ||--o{ CONTACT : employs
    CONTACT ||--o{ DEAL : involves
    DEAL ||--o{ ACTIVITY : has
    DEAL ||--o{ NOTE : has
    USER ||--o{ ACTIVITY : performs

    USER {
        int id PK
        string name
        string email UK
        string role "admin, manager, sales"
        int team_id FK
        datetime created_at
    }

    COMPANY {
        int id PK
        string name
        string industry
        int employee_count
        string website
        datetime created_at
    }

    CONTACT {
        int id PK
        int company_id FK
        string name
        string email
        string phone
        string position
    }

    DEAL {
        int id PK
        int owner_id FK "USERのid"
        int company_id FK
        int contact_id FK
        string title
        decimal amount
        string stage "lead, proposal, negotiation, closed"
        date expected_close_date
        datetime created_at
    }

    ACTIVITY {
        int id PK
        int deal_id FK
        int user_id FK
        string type "call, email, meeting"
        text summary
        datetime activity_date
    }

    NOTE {
        int id PK
        int deal_id FK
        int user_id FK
        text content
        datetime created_at
    }
```

**ポイント**:
- 商談の進捗管理（stage）
- アクティビティ記録（電話、メール、ミーティング）
- ノート・メモ機能

---

### 4. SNS・コミュニティサイト

```mermaid
erDiagram
    USER ||--o{ POST : creates
    USER ||--o{ COMMENT : writes
    USER ||--o{ LIKE : gives
    POST ||--o{ COMMENT : has
    POST ||--o{ LIKE : receives
    USER ||--o{ FOLLOW : follows
    USER ||--o{ FOLLOW : "followed by"

    USER {
        int id PK
        string username UK
        string email UK
        string password_hash
        string avatar_url
        text bio
        datetime created_at
    }

    POST {
        int id PK
        int user_id FK
        text content
        string image_url
        int like_count
        int comment_count
        datetime created_at
    }

    COMMENT {
        int id PK
        int post_id FK
        int user_id FK
        text content
        datetime created_at
    }

    LIKE {
        int id PK
        int post_id FK
        int user_id FK
        datetime created_at
    }

    FOLLOW {
        int id PK
        int follower_id FK "フォローする人"
        int followee_id FK "フォローされる人"
        datetime created_at
    }
```

**ポイント**:
- FOLLOW は自己参照（USER → USER）
- いいね数・コメント数は非正規化（パフォーマンス重視）
- 複合ユニーク制約が必要（post_id + user_id）

---

### 5. 金融系（送金システム）

```mermaid
erDiagram
    USER ||--o{ ACCOUNT : owns
    ACCOUNT ||--o{ TRANSACTION : sends
    ACCOUNT ||--o{ TRANSACTION : receives

    USER {
        int id PK
        string name
        string email UK
        string phone
        datetime created_at
    }

    ACCOUNT {
        int id PK
        int user_id FK
        string account_number UK
        decimal balance
        string currency "JPY, USD, etc"
        string status "active, frozen, closed"
        datetime created_at
    }

    TRANSACTION {
        int id PK
        int from_account_id FK
        int to_account_id FK
        decimal amount
        string currency
        string status "pending, completed, failed"
        string type "transfer, deposit, withdrawal"
        datetime created_at
        datetime completed_at
    }
```

**ポイント**:
- 送金元・送金先の両方を記録
- トランザクション状態の管理（pending, completed, failed）
- 通貨の明示

---

## 🔄 自己参照のパターン

### カテゴリの階層構造

```mermaid
erDiagram
    CATEGORY ||--o{ CATEGORY : "parent of"

    CATEGORY {
        int id PK
        string name
        int parent_id FK "自己参照: NULL=ルート"
        int display_order
    }
```

**例**:
```
家電（parent_id=NULL）
├── テレビ（parent_id=1）
│   ├── 液晶テレビ（parent_id=2）
│   └── 有機ELテレビ（parent_id=2）
└── 冷蔵庫（parent_id=1）
```

---

### 組織の階層構造

```mermaid
erDiagram
    DEPARTMENT ||--o{ DEPARTMENT : "parent of"
    DEPARTMENT ||--o{ EMPLOYEE : employs

    DEPARTMENT {
        int id PK
        string name
        int parent_id FK "自己参照"
    }

    EMPLOYEE {
        int id PK
        int department_id FK
        string name
    }
```

---

## ❌ Bad Example: よくある失敗パターン

### 問題1: 多対多を直接結ぶ

```mermaid
erDiagram
    STUDENT }o--o{ COURSE : enrolls

    STUDENT {
        int id PK
        string name
    }

    COURSE {
        int id PK
        string name
    }
```

**問題点**:
- 中間テーブルがない
- 成績等の追加情報を保存できない
- 実装が困難

---

### ✅ Good Example: 中間テーブルを作る

```mermaid
erDiagram
    STUDENT ||--o{ ENROLLMENT : ""
    COURSE ||--o{ ENROLLMENT : ""

    STUDENT {
        int id PK
        string name
    }

    COURSE {
        int id PK
        string name
    }

    ENROLLMENT {
        int id PK
        int student_id FK
        int course_id FK
        int grade
        datetime enrolled_at
    }
```

**改善点**:
- 中間テーブル `ENROLLMENT` で多対多を実現
- 成績等の追加情報を保存可能

---

### 問題2: データ型・制約が不明

```mermaid
erDiagram
    USER {
        id
        name
        email
    }
```

**問題点**:
- データ型がない
- PK/FK/UKの指定がない
- 実装時に混乱

---

### ✅ Good Example: データ型・制約を明記

```mermaid
erDiagram
    USER {
        int id PK
        string name
        string email UK
        datetime created_at
    }
```

**改善点**:
- データ型を明記
- PK/UK/FKを明記
- 実装者が迷わない

---

## 📝 テンプレート

### 基本テンプレート

```markdown
## ER図

```mermaid
erDiagram
    ENTITY1 ||--o{ ENTITY2 : relationship

    ENTITY1 {
        int id PK
        string name
        datetime created_at
    }

    ENTITY2 {
        int id PK
        int entity1_id FK
        string name
        datetime created_at
    }
```

**説明**:
- エンティティ間の関係を記述
- データ型・制約を明記
```

---

## 🔧 実装時の注意点

### 1. 論理設計と物理設計

**要件定義（論理設計）**:
- エンティティ名は業務用語（日本語でもOK）
- 正規化を重視
- 概念的なER図

**詳細設計（物理設計）**:
- テーブル名は英語（小文字＋アンダースコア）
- インデックス・パーティションも考慮
- パフォーマンスのための非正規化も検討

### 2. Mermaid ER図の制限

Mermaidでは以下が表現できない:
- **複合主キー**: コメントで補足
- **インデックス**: 別途ドキュメント化
- **CHECK制約**: 属性の説明欄に記載

### 3. 推奨データ型

| 用途 | データ型 |
|------|---------|
| ID | `int` または `bigint` |
| 名前・タイトル | `string (varchar)` |
| 長文 | `text` |
| 日時 | `datetime` または `timestamp` |
| 日付のみ | `date` |
| 金額 | `decimal` |
| フラグ | `boolean` |

---

## 📚 次のステップ

ER図を理解したら:

1. **2.2.7.3 システム構成図（概念レベル）.md** へ進む
2. システム全体のアーキテクチャ可視化を学ぶ
3. 実際のプロジェクトでER図を作成

---

## 関連ドキュメント

- [2.2.2.3 データ要件ヒアリング項目](./2.2.2.3_データ要件ヒアリング項目.md)
- [2.2.7.1 画面遷移図パターン](./2.2.7.1_画面遷移図パターン.md)
- [2.2.7.6 Good_Bad_Example集](./2.2.7.6_Good_Bad_Example集.md)

---

**作成日**: 2025-10-19
**対象フェーズ**: 要件定義
**重要度**: ⭐⭐⭐ 必須（データ構造の可視化）
