# 2.2.7.3 システム構成図（概念レベル）

## 目的

要件定義フェーズで、**システム全体の構成を概念レベルで視覚化**するためのMermaid図パターンを提供します。

### このドキュメントで得られること

1. システム構成図の基本パターン
2. クラウド・オンプレミスの構成例
3. 外部連携を含めた全体像の描き方

---

## 📊 基本パターン

### シンプルな3層アーキテクチャ

```mermaid
flowchart TB
    subgraph クライアント層
        A[Webブラウザ]
        B[スマホアプリ]
    end

    subgraph アプリケーション層
        C[Webサーバー]
        D[APIサーバー]
    end

    subgraph データ層
        E[データベース]
        F[ファイルストレージ]
    end

    A -->|HTTPS| C
    B -->|HTTPS| D
    C --> D
    D --> E
    D --> F

    style C fill:#e1f5ff
    style D fill:#e1f5ff
    style E fill:#fff9c4
```

**ポイント**:
- 3層（プレゼンテーション・ビジネスロジック・データ）
- 通信プロトコルを明記（HTTPS等）
- 各層の役割を明確に

---

## 🏢 ドメイン別パターン

### 1. ECサイト（AWSクラウド構成）

```mermaid
flowchart TB
    subgraph ユーザー
        A[PCブラウザ]
        B[スマホアプリ]
    end

    subgraph AWS
        C[Route 53<br/>DNS]

        subgraph VPC
            D[CloudFront<br/>CDN]

            subgraph パブリックサブネット
                E[ALB<br/>ロードバランサー]
            end

            subgraph プライベートサブネット
                F[EC2 x2<br/>Webサーバー]
                G[EC2 x2<br/>APIサーバー]
            end

            subgraph データベース
                H[RDS<br/>PostgreSQL]
                I[ElastiCache<br/>Redis]
            end

            J[S3<br/>画像ストレージ]
        end
    end

    subgraph 外部サービス
        K[Stripe<br/>決済]
        L[SendGrid<br/>メール配信]
    end

    A -->|HTTPS| C
    B -->|HTTPS| C
    C --> D
    D --> E
    E --> F
    E --> G
    F --> G
    G --> H
    G --> I
    G --> J
    G -->|API| K
    G -->|API| L

    style F fill:#e1f5ff
    style G fill:#e1f5ff
    style H fill:#fff9c4
    style K fill:#ffcdd2
    style L fill:#ffcdd2
```

**ポイント**:
- VPCでネットワーク分離
- パブリック/プライベートサブネット
- 冗長構成（EC2 x2）
- 外部サービス連携を明記

---

### 2. 予約システム（シンプル構成）

```mermaid
flowchart TB
    subgraph ユーザー
        A[Webブラウザ]
    end

    subgraph サーバー
        B[Nginx<br/>Webサーバー]
        C[Node.js<br/>アプリケーション]

        subgraph データベース
            D[PostgreSQL<br/>予約データ]
        end
    end

    subgraph 外部サービス
        E[Google Calendar API<br/>カレンダー連携]
        F[Twilio<br/>SMS通知]
    end

    A -->|HTTPS| B
    B --> C
    C --> D
    C -->|API| E
    C -->|API| F

    style B fill:#e1f5ff
    style C fill:#e1f5ff
    style D fill:#fff9c4
    style E fill:#ffcdd2
    style F fill:#ffcdd2
```

**ポイント**:
- 小規模システムのシンプル構成
- 外部API連携を明記
- 通知機能（SMS）の明示

---

### 3. 業務システム（オンプレミス + クラウド）

```mermaid
flowchart TB
    subgraph オンプレミス
        A[社内PC]

        subgraph DMZ
            B[ファイアウォール]
            C[リバースプロキシ]
        end

        subgraph 社内ネットワーク
            D[Webサーバー]
            E[APサーバー]
            F[DBサーバー<br/>SQL Server]
        end
    end

    subgraph AWS
        G[S3<br/>バックアップ]
        H[CloudWatch<br/>監視]
    end

    subgraph 外部
        I[営業担当<br/>モバイル]
    end

    A --> B
    I -->|VPN| B
    B --> C
    C --> D
    D --> E
    E --> F
    F -->|バックアップ| G
    E -->|ログ送信| H

    style D fill:#e1f5ff
    style E fill:#e1f5ff
    style F fill:#fff9c4
    style G fill:#c8e6c9
```

**ポイント**:
- オンプレミスとクラウドのハイブリッド構成
- DMZ（非武装地帯）でセキュリティ強化
- VPN接続でリモートアクセス
- バックアップをクラウドに

---

### 4. マイクロサービス構成（大規模システム）

```mermaid
flowchart TB
    subgraph クライアント
        A[Webブラウザ]
        B[モバイルアプリ]
    end

    subgraph API Gateway
        C[API Gateway]
    end

    subgraph マイクロサービス
        D[ユーザーサービス]
        E[商品サービス]
        F[注文サービス]
        G[決済サービス]
        H[通知サービス]
    end

    subgraph データストア
        I[(ユーザーDB)]
        J[(商品DB)]
        K[(注文DB)]
        L[(決済DB)]
    end

    subgraph メッセージング
        M[RabbitMQ]
    end

    A -->|HTTPS| C
    B -->|HTTPS| C
    C --> D
    C --> E
    C --> F
    C --> G

    D --> I
    E --> J
    F --> K
    G --> L

    F --> M
    G --> M
    M --> H

    style D fill:#e1f5ff
    style E fill:#e1f5ff
    style F fill:#e1f5ff
    style G fill:#e1f5ff
    style H fill:#e1f5ff
    style M fill:#fff9c4
```

**ポイント**:
- サービスごとに独立したDB
- API Gatewayで統一エンドポイント
- メッセージキューで非同期処理
- 疎結合なアーキテクチャ

---

### 5. SaaS型サービス（マルチテナント）

```mermaid
flowchart TB
    subgraph テナント
        A[企業A]
        B[企業B]
        C[企業C]
    end

    subgraph アプリケーション
        D[ロードバランサー]
        E[Webサーバー x3]
        F[APサーバー x3]
    end

    subgraph データ
        G[共有DB<br/>テナント分離]
        H[共有ストレージ<br/>S3]
    end

    subgraph 管理
        I[管理コンソール]
        J[監視ツール]
    end

    A -->|HTTPS| D
    B -->|HTTPS| D
    C -->|HTTPS| D
    D --> E
    E --> F
    F --> G
    F --> H
    I --> F
    J --> F
    J --> G

    style E fill:#e1f5ff
    style F fill:#e1f5ff
    style G fill:#fff9c4
    style I fill:#c8e6c9
```

**ポイント**:
- マルチテナント（複数企業が同一システムを利用）
- テナントIDでデータ分離
- スケーラビリティ（サーバー複数台）
- 管理コンソールで運用

---

## 🔐 セキュリティ要素を含む構成図

### ファイアウォール・WAF構成

```mermaid
flowchart TB
    subgraph インターネット
        A[ユーザー]
    end

    subgraph セキュリティ層
        B[CloudFlare<br/>CDN + DDoS対策]
        C[WAF<br/>Web Application Firewall]
    end

    subgraph AWS VPC
        D[ALB]

        subgraph パブリックサブネット
            E[Bastion<br/>踏み台サーバー]
        end

        subgraph プライベートサブネット
            F[Webサーバー]
            G[APサーバー]
            H[DBサーバー]
        end
    end

    subgraph 管理者
        I[運用担当者]
    end

    A --> B
    B --> C
    C --> D
    D --> F
    F --> G
    G --> H

    I -->|SSH| E
    E -->|SSH| G

    style C fill:#ffcdd2
    style E fill:#fff9c4
    style H fill:#c8e6c9
```

**ポイント**:
- WAFで攻撃防御
- Bastion（踏み台）経由でのみサーバーアクセス
- プライベートサブネットで保護

---

## 🔄 バックアップ・DR構成

### 災害対策（Disaster Recovery）

```mermaid
flowchart TB
    subgraph 東京リージョン_本番環境
        A[ユーザー]
        B[Route 53<br/>DNS]
        C[ALB]
        D[EC2 x2<br/>Webサーバー]
        E[RDS Primary<br/>PostgreSQL]
    end

    subgraph 大阪リージョン_DR環境
        F[ALB Standby]
        G[EC2 x2<br/>Webサーバー Standby]
        H[RDS Standby<br/>レプリカ]
    end

    subgraph バックアップ
        I[S3<br/>日次バックアップ]
    end

    A --> B
    B -->|通常時| C
    B -.->|障害時| F
    C --> D
    D --> E
    E -->|レプリケーション| H
    E -->|日次バックアップ| I
    F --> G
    G --> H

    style E fill:#c8e6c9
    style H fill:#fff9c4
    style I fill:#e1f5ff
```

**ポイント**:
- マルチリージョン構成
- DBレプリケーション
- DNS切り替えで障害時対応
- 日次バックアップをS3に

---

## 🔧 データフロー図

### バッチ処理を含む構成

```mermaid
flowchart LR
    subgraph リアルタイム
        A[ユーザー] -->|リクエスト| B[Webサーバー]
        B --> C[APサーバー]
        C --> D[(本番DB)]
    end

    subgraph バッチ処理
        E[バッチサーバー]
        F[(分析DB)]
    end

    D -->|夜間レプリケーション| F
    E -->|集計処理| F
    F -->|レポート出力| G[S3]

    style D fill:#c8e6c9
    style F fill:#fff9c4
    style E fill:#e1f5ff
```

**ポイント**:
- リアルタイム処理とバッチ処理を分離
- 本番DBと分析DBを分ける
- 夜間レプリケーション

---

## ❌ Bad Example: よくある失敗パターン

### 問題1: 詳細すぎて読めない

```mermaid
flowchart TB
    A[Browser] --> B[Nginx:80]
    B --> C[Node.js:3000]
    C --> D[Redis:6379]
    C --> E[PostgreSQL:5432]
    C --> F[MongoDB:27017]
    C --> G[Elasticsearch:9200]
    C --> H[RabbitMQ:5672]
    D --> E
    E --> F
    F --> G
```

**問題点**:
- ポート番号等の詳細すぎる情報
- 要件定義フェーズには不要
- 全体像が見えない

---

### ✅ Good Example: 概念レベルで表現

```mermaid
flowchart TB
    subgraph クライアント
        A[Webブラウザ]
    end

    subgraph アプリケーション
        B[Webサーバー]
        C[キャッシュ]
    end

    subgraph データストア
        D[リレーショナルDB]
        E[NoSQL]
        F[検索エンジン]
    end

    A --> B
    B --> C
    B --> D
    B --> E
    B --> F

    style B fill:#e1f5ff
    style D fill:#c8e6c9
```

**改善点**:
- 概念レベルで表現
- 役割を明確に（「検索エンジン」等）
- 全体像が見やすい

---

### 問題2: 外部連携が不明

```mermaid
flowchart TB
    A[ユーザー] --> B[サーバー]
    B --> C[DB]
```

**問題点**:
- 外部サービス連携が不明
- 決済・メール送信等が抜けている

---

### ✅ Good Example: 外部連携を明記

```mermaid
flowchart TB
    A[ユーザー] --> B[サーバー]
    B --> C[DB]

    subgraph 外部サービス
        D[決済API]
        E[メール配信]
        F[SMS通知]
    end

    B --> D
    B --> E
    B --> F

    style D fill:#ffcdd2
    style E fill:#ffcdd2
    style F fill:#ffcdd2
```

**改善点**:
- 外部サービスを明記
- 依存関係を明確に
- 色分けで外部を強調

---

## 📝 テンプレート

### 基本テンプレート

```markdown
## システム構成図

```mermaid
flowchart TB
    subgraph クライアント
        A[...]
    end

    subgraph アプリケーション
        B[Webサーバー]
        C[APサーバー]
    end

    subgraph データ
        D[データベース]
        E[ストレージ]
    end

    subgraph 外部サービス
        F[...]
    end

    A --> B
    B --> C
    C --> D
    C --> E
    C --> F

    style B fill:#e1f5ff
    style C fill:#e1f5ff
    style D fill:#fff9c4
    style F fill:#ffcdd2
```

**説明**:
- システム全体の構成を概念レベルで記述
- 外部連携を明記
```

---

## 🔧 実装時の注意点

### 1. 要件定義 vs 詳細設計

**要件定義（このドキュメント）**:
- 概念レベル（「Webサーバー」「データベース」等）
- 全体の構成を俯瞰
- 非エンジニアにも理解できる

**詳細設計**:
- 具体的な製品名（「Nginx 1.21」「PostgreSQL 14」）
- ポート番号、ネットワーク設定
- インフラエンジニア向け

### 2. クラウド vs オンプレミス

**クラウド**:
- AWSサービス名を明記（EC2、RDS、S3等）
- マネージドサービスを活用

**オンプレミス**:
- サーバー台数を明記
- ネットワーク構成（DMZ等）を明記

### 3. スケーラビリティ

将来の拡張性を考慮:
- ロードバランサーを挟む
- サーバーを複数台構成
- キャッシュレイヤーを追加

---

## 📚 次のステップ

システム構成図を理解したら:

1. **2.2.7.4 ユースケース図パターン.md** へ進む
2. ユーザーとシステムの相互作用を学ぶ
3. 実際のプロジェクトでシステム構成図を作成

---

## 関連ドキュメント

- [2.2.2.5 外部連携要件ヒアリング項目](./2.2.2.5_外部連携要件ヒアリング項目.md)
- [2.2.6.2 可用性要件の記述方法](./2.2.6.2_可用性要件の記述方法.md)
- [2.2.6.3 セキュリティ要件の記述方法](./2.2.6.3_セキュリティ要件の記述方法.md)

---

**作成日**: 2025-10-19
**対象フェーズ**: 要件定義
**重要度**: ⭐⭐⭐ 必須（システム全体像の可視化）
