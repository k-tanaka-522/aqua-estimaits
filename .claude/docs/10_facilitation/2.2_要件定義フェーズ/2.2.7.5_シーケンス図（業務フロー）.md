# 2.2.7.5 シーケンス図（業務フロー）

## 目的

要件定義フェーズで、**時系列での処理の流れ・業務フロー**を視覚的に表現するためのMermaidシーケンス図パターンを提供します。

### このドキュメントで得られること

1. すぐに使えるMermaidシーケンス図のテンプレート
2. ドメインごとの具体例
3. 非同期処理・分岐の表現方法

---

## 📊 基本パターン

### シンプルなシーケンス図

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Web as Webサーバー
    participant API as APIサーバー
    participant DB as データベース

    User->>Web: ログインリクエスト
    Web->>API: 認証処理
    API->>DB: ユーザー情報取得
    DB-->>API: ユーザー情報
    API-->>Web: 認証成功
    Web-->>User: ホーム画面表示
```

**記法**:
- `actor` : 人間のアクター
- `participant` : システムコンポーネント
- `->>` : 同期呼び出し（矢印）
- `-->>` : 応答（点線矢印）

---

## 🎯 ドメイン別パターン

### 1. ECサイト - 商品購入フロー

```mermaid
sequenceDiagram
    actor Customer as 顧客
    participant Web as Webブラウザ
    participant API as APIサーバー
    participant DB as データベース
    participant Payment as 決済API
    participant Email as メール送信

    Customer->>Web: 商品をカートに追加
    Web->>API: カート追加リクエスト
    API->>DB: カートデータ保存
    DB-->>API: 保存完了
    API-->>Web: カート更新
    Web-->>Customer: カート画面表示

    Customer->>Web: 購入ボタンクリック
    Web->>API: 注文確認リクエスト
    API->>DB: 在庫確認
    DB-->>API: 在庫あり

    alt 在庫あり
        API->>Payment: 決済処理
        Payment-->>API: 決済成功

        API->>DB: 注文データ保存
        DB-->>API: 保存完了

        API->>DB: 在庫減算
        DB-->>API: 在庫更新完了

        par 並行処理
            API->>Email: 注文確認メール送信
            Email-->>API: 送信完了
        and
            API->>Email: 管理者通知メール
            Email-->>API: 送信完了
        end

        API-->>Web: 注文完了
        Web-->>Customer: 完了画面表示
    else 在庫なし
        API-->>Web: エラー（在庫切れ）
        Web-->>Customer: エラーメッセージ表示
    end
```

**ポイント**:
- `alt/else` で条件分岐
- `par/and` で並行処理
- 外部API（決済）との連携を明記

---

### 2. 予約システム - 予約フロー

```mermaid
sequenceDiagram
    actor User as 利用者
    participant Web as Webブラウザ
    participant API as APIサーバー
    participant DB as データベース
    participant Calendar as カレンダーAPI
    participant SMS as SMS通知

    User->>Web: 施設選択
    Web->>API: 空き状況取得
    API->>DB: 予約状況検索
    DB-->>API: 空き時間リスト
    API-->>Web: 空き時間表示
    Web-->>User: カレンダー表示

    User->>Web: 時間選択 + 予約ボタン
    Web->>API: 予約リクエスト

    critical 排他制御（同時予約防止）
        API->>DB: 空き状況再確認（FOR UPDATE）
        DB-->>API: 空きあり

        API->>DB: 予約データ保存
        DB-->>API: 保存完了

        API->>Calendar: カレンダー登録
        Calendar-->>API: 登録完了
    option 予約済み
        API-->>Web: エラー（予約済み）
        Web-->>User: エラーメッセージ
    end

    API->>SMS: 予約確認SMS送信
    SMS-->>API: 送信完了

    API-->>Web: 予約完了
    Web-->>User: 完了画面表示
```

**ポイント**:
- `critical/option` で排他制御を表現
- 同時予約の防止処理を明記
- 外部API連携（カレンダー、SMS）

---

### 3. 業務システム - 商談登録フロー

```mermaid
sequenceDiagram
    actor Sales as 営業担当者
    participant Web as Webブラウザ
    participant API as APIサーバー
    participant DB as データベース
    participant Notification as 通知サービス
    participant Manager as マネージャー

    Sales->>Web: 商談登録画面を開く
    Web->>API: 顧客リスト取得
    API->>DB: 顧客データ取得
    DB-->>API: 顧客リスト
    API-->>Web: 顧客リスト表示
    Web-->>Sales: フォーム表示

    Sales->>Web: 商談情報入力 + 保存
    Web->>API: 商談登録リクエスト

    API->>DB: バリデーション
    alt バリデーションOK
        API->>DB: 商談データ保存
        DB-->>API: 保存完了

        opt 金額が1000万円以上
            API->>Notification: マネージャーに通知
            Notification->>Manager: 大型商談通知
        end

        API-->>Web: 登録完了
        Web-->>Sales: 完了メッセージ
    else バリデーションNG
        API-->>Web: エラー
        Web-->>Sales: エラーメッセージ表示
    end
```

**ポイント**:
- `opt` で条件付き処理（金額が大きい場合のみ通知）
- バリデーション処理を明記
- マネージャーへの通知フロー

---

### 4. SNS - 投稿フロー

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant App as アプリ
    participant API as APIサーバー
    participant Storage as 画像ストレージ
    participant DB as データベース
    participant Cache as キャッシュ
    participant Notification as 通知サービス

    User->>App: 投稿作成 + 画像選択
    App->>API: 画像アップロード
    API->>Storage: 画像保存
    Storage-->>API: 画像URL
    API-->>App: アップロード完了

    User->>App: 投稿ボタン
    App->>API: 投稿リクエスト

    API->>DB: 投稿データ保存
    DB-->>API: 保存完了

    par 並行処理
        API->>Cache: タイムラインキャッシュ更新
        Cache-->>API: 更新完了
    and
        API->>DB: フォロワーリスト取得
        DB-->>API: フォロワーリスト
        API->>Notification: プッシュ通知送信
        Notification-->>API: 送信完了
    end

    API-->>App: 投稿完了
    App-->>User: 投稿表示
```

**ポイント**:
- 画像アップロードの流れ
- キャッシュ更新とプッシュ通知を並行処理
- フォロワーへの通知

---

### 5. 金融系 - 送金フロー

```mermaid
sequenceDiagram
    actor User as 利用者
    participant App as アプリ
    participant API as APIサーバー
    participant DB as データベース
    participant Fraud as 不正検知
    participant Ledger as 台帳サービス
    participant SMS as SMS通知

    User->>App: 送金金額 + 送金先入力
    App->>API: 送金リクエスト

    API->>Fraud: 不正検知チェック
    Fraud-->>API: 問題なし

    critical トランザクション
        API->>DB: 送金元残高確認
        DB-->>API: 残高十分

        API->>DB: 送金元残高減算
        DB-->>API: 更新完了

        API->>DB: 送金先残高加算
        DB-->>API: 更新完了

        API->>Ledger: 取引ログ記録
        Ledger-->>API: 記録完了
    option エラー発生
        API->>DB: ロールバック
        DB-->>API: ロールバック完了
        API-->>App: エラー
    end

    par 並行処理
        API->>SMS: 送金元にSMS通知
        SMS-->>API: 送信完了
    and
        API->>SMS: 送金先にSMS通知
        SMS-->>API: 送信完了
    end

    API-->>App: 送金完了
    App-->>User: 完了画面表示
```

**ポイント**:
- `critical` でトランザクション処理を表現
- 不正検知チェック
- 送金元・送金先への通知
- エラー時のロールバック

---

## 🔄 高度なパターン

### ループ処理

```mermaid
sequenceDiagram
    actor Admin as 管理者
    participant API as APIサーバー
    participant DB as データベース
    participant Email as メール送信

    Admin->>API: 一括メール送信リクエスト
    API->>DB: ユーザーリスト取得
    DB-->>API: ユーザーリスト

    loop 各ユーザー
        API->>Email: メール送信
        Email-->>API: 送信完了
    end

    API-->>Admin: 全送信完了
```

**使い方**: `loop` で繰り返し処理を表現

---

### 非同期処理（バックグラウンド）

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant Web as Webブラウザ
    participant API as APIサーバー
    participant Queue as メッセージキュー
    participant Worker as バックグラウンドワーカー
    participant Storage as ストレージ

    User->>Web: レポート生成リクエスト
    Web->>API: レポート生成
    API->>Queue: ジョブ登録
    Queue-->>API: 登録完了
    API-->>Web: 処理開始（非同期）
    Web-->>User: 「処理中」メッセージ

    Note over Worker: バックグラウンドで実行
    Queue->>Worker: ジョブ取得
    Worker->>API: データ取得
    API-->>Worker: データ
    Worker->>Storage: レポートファイル生成
    Storage-->>Worker: 保存完了
    Worker->>API: 完了通知
    API->>User: メールで通知
```

**ポイント**:
- メッセージキューで非同期処理
- `Note` でコメント追加

---

## ❌ Bad Example: よくある失敗パターン

### 問題1: 応答が書かれていない

```mermaid
sequenceDiagram
    actor User
    participant API
    participant DB

    User->>API: リクエスト
    API->>DB: データ取得
```

**問題点**:
- 応答（戻り矢印）がない
- 処理の完了が不明

---

### ✅ Good Example: 応答を明記

```mermaid
sequenceDiagram
    actor User
    participant API
    participant DB

    User->>API: リクエスト
    API->>DB: データ取得
    DB-->>API: データ
    API-->>User: レスポンス
```

**改善点**:
- `-->>` で応答を明記
- 処理の完了が明確

---

### 問題2: 参加者が多すぎて読めない

```mermaid
sequenceDiagram
    participant A
    participant B
    participant C
    participant D
    participant E
    participant F
    participant G

    A->>B: 処理1
    B->>C: 処理2
    C->>D: 処理3
    D->>E: 処理4
    E->>F: 処理5
    F->>G: 処理6
```

**問題点**:
- 参加者が多すぎる
- 全体の流れが見えない

---

### ✅ Good Example: 重要な部分のみ記載

```mermaid
sequenceDiagram
    actor User
    participant Frontend as フロントエンド
    participant Backend as バックエンド
    participant ExternalAPI as 外部API

    User->>Frontend: リクエスト
    Frontend->>Backend: データ処理
    Backend->>ExternalAPI: API呼び出し
    ExternalAPI-->>Backend: レスポンス
    Backend-->>Frontend: 処理結果
    Frontend-->>User: 画面表示
```

**改善点**:
- レイヤーごとにまとめる
- 詳細な内部処理は省略

---

## 📝 テンプレート

### 基本テンプレート

```markdown
## シーケンス図

```mermaid
sequenceDiagram
    actor User as ユーザー
    participant System as システム
    participant DB as データベース

    User->>System: リクエスト
    System->>DB: データ取得
    DB-->>System: データ
    System-->>User: レスポンス
```

**説明**:
- 時系列での処理の流れを記述
- 応答を必ず記載
```

---

## 🔧 実装時の注意点

### 1. 粒度の調整

**要件定義では**:
- 業務フローレベル（ユーザー視点）
- 主要な処理のみ

**詳細設計では**:
- メソッドレベル
- すべての分岐・エラー処理

### 2. alt/opt/par/loopの使い分け

| 記法 | 用途 | 例 |
|------|------|-----|
| `alt/else` | 条件分岐 | 在庫あり/なし |
| `opt` | 条件付き実行 | 大型商談のみ通知 |
| `par/and` | 並行処理 | メール送信と通知 |
| `loop` | 繰り返し | 各ユーザーに送信 |
| `critical` | 排他制御 | トランザクション処理 |

### 3. 非同期処理の表現

- メッセージキューを明記
- `Note` でバックグラウンド処理を説明
- 通知方法を明示（メール、プッシュ通知等）

---

## 📚 次のステップ

シーケンス図を理解したら:

1. **2.2.7.6 Good_Bad_Example集.md** へ進む
2. Mermaid図のベストプラクティスを学ぶ
3. 実際のプロジェクトでシーケンス図を作成

---

## 関連ドキュメント

- [2.2.5.2 ユースケース記述方法](./2.2.5.2_ユースケース記述方法.md)
- [2.2.7.1 画面遷移図パターン](./2.2.7.1_画面遷移図パターン.md)
- [2.2.7.3 システム構成図（概念レベル）](./2.2.7.3_システム構成図（概念レベル）.md)

---

**作成日**: 2025-10-19
**対象フェーズ**: 要件定義
**重要度**: ⭐⭐⭐ 必須（業務フローの可視化）
