# 2.5.8.1 脆弱性スキャン

## 目的

アプリケーションの脆弱性を自動検出し、修正します。

---

## 🔍 OWASP Top 10 対策

### 1. SQLインジェクション

#### ❌ 脆弱なコード（Python）

```python
# ❌ Bad: SQL文字列結合
def get_user(user_id):
    query = f"SELECT * FROM users WHERE id = {user_id}"  # ❌ SQLインジェクション脆弱性
    cursor.execute(query)
```

#### ✅ 安全なコード

```python
# ✅ Good: パラメータ化クエリ
def get_user(user_id):
    query = "SELECT * FROM users WHERE id = %s"
    cursor.execute(query, (user_id,))  # プレースホルダー使用
```

---

### 2. XSS (クロスサイトスクリプティング)

#### ❌ 脆弱なコード（JavaScript）

```javascript
// ❌ Bad: エスケープなし
const userInput = req.query.name;
res.send(`<h1>Welcome ${userInput}</h1>`);  // ❌ XSS脆弱性
```

#### ✅ 安全なコード

```javascript
// ✅ Good: エスケープ処理
const escapeHtml = (str) =>
  str.replace(/[&<>"']/g, (match) => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[match]));

const userInput = escapeHtml(req.query.name);
res.send(`<h1>Welcome ${userInput}</h1>`);
```

---

### 3. 認証の不備

#### ❌ 脆弱なコード

```python
# ❌ Bad: パスワードを平文で保存
def create_user(username, password):
    db.execute("INSERT INTO users (username, password) VALUES (%s, %s)",
               (username, password))  # ❌ 平文保存
```

#### ✅ 安全なコード

```python
# ✅ Good: bcryptでハッシュ化
import bcrypt

def create_user(username, password):
    hashed = bcrypt.hashpw(password.encode('utf-8'), bcrypt.gensalt())
    db.execute("INSERT INTO users (username, password_hash) VALUES (%s, %s)",
               (username, hashed))

def verify_password(username, password):
    user = db.fetchone("SELECT password_hash FROM users WHERE username = %s", (username,))
    return bcrypt.checkpw(password.encode('utf-8'), user['password_hash'])
```

---

### 4. センシティブデータの露出

#### ❌ 脆弱なコード

```javascript
// ❌ Bad: シークレット情報をログ出力
console.log(`API Key: ${process.env.API_KEY}`);  // ❌ ログに露出
```

#### ✅ 安全なコード

```javascript
// ✅ Good: シークレット情報をログ出力しない
const apiKey = process.env.API_KEY;
// ログにはマスクした情報のみ
console.log(`API Key: ${apiKey.substring(0, 4)}****`);
```

---

## 🛠️ 脆弱性スキャンツール

### OWASP ZAP

```bash
# OWASP ZAPをDockerで実行
docker run -t owasp/zap2docker-stable zap-baseline.py \
  -t https://your-app.example.com

# フルスキャン
docker run -t owasp/zap2docker-stable zap-full-scan.py \
  -t https://your-app.example.com \
  -r zap-report.html
```

**検出項目**:
- SQL Injection
- XSS (Cross-Site Scripting)
- CSRF (Cross-Site Request Forgery)
- Security Headers (X-Frame-Options, CSP等)

---

### Snyk（依存関係スキャン）

```bash
# インストール
npm install -g snyk

# 認証
snyk auth

# プロジェクトスキャン
snyk test

# 出力例:
# ✗ High severity vulnerability found in lodash
#   Vulnerable versions: < 4.17.21
#   Fixed in: 4.17.21
```

**修正**:

```bash
# 自動修正
snyk fix

# または手動で
npm install lodash@4.17.21
```

---

### Trivy（コンテナイメージスキャン）

```bash
# Trivyインストール
brew install aquasecurity/trivy/trivy

# コンテナイメージスキャン
trivy image myapp:latest

# 出力例:
myapp:latest (debian 11.5)
Total: 150 (CRITICAL: 5, HIGH: 20, MEDIUM: 75, LOW: 50)

CRITICAL: CVE-2023-1234 (openssl 1.1.1)
HIGH: CVE-2023-5678 (curl 7.74)
```

**修正**:

```dockerfile
# Dockerfile
FROM debian:11-slim  # ❌ 脆弱性多数

# ✅ 最新のベースイメージ
FROM debian:12-slim

# パッケージ更新
RUN apt-get update && apt-get upgrade -y && apt-get clean
```

---

## 📋 CI/CDでの自動スキャン

### GitHub Actions

```yaml
name: Security Scan
on: [push, pull_request]

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # Snyk依存関係スキャン
      - name: Run Snyk
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high

      # Trivyコンテナスキャン
      - name: Run Trivy
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'myapp:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'

      # OWASP ZAP
      - name: ZAP Scan
        uses: zaproxy/action-baseline@v0.7.0
        with:
          target: 'https://staging.example.com'
```

---

## 🎯 脆弱性対応の優先度

| 重要度 | 対応期限 | 例 |
|--------|---------|-----|
| **Critical** | 即座（24時間以内） | SQLインジェクション、RCE |
| **High** | 1週間以内 | XSS、認証の不備 |
| **Medium** | 2週間以内 | セキュリティヘッダー不足 |
| **Low** | 次回リリース時 | 古いライブラリ（脆弱性なし） |

---

## ✅ セキュリティチェックリスト

- ✅ パスワードのハッシュ化（bcrypt、Argon2）
- ✅ SQLインジェクション対策（パラメータ化クエリ）
- ✅ XSS対策（エスケープ処理）
- ✅ CSRF対策（トークン検証）
- ✅ HTTPS強制（HTTP→HTTPSリダイレクト）
- ✅ セキュリティヘッダー設定
  - `X-Frame-Options: DENY`
  - `X-Content-Type-Options: nosniff`
  - `Content-Security-Policy`
  - `Strict-Transport-Security`
- ✅ 依存関係の脆弱性チェック（Snyk、npm audit）
- ✅ シークレット情報の環境変数化
- ✅ ログからのシークレット情報除外

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
