# 2.5.8.3 ペネトレーションテスト

## 目的

実際の攻撃を模したテストで、システムのセキュリティ強度を検証します。

---

## ⚠️ 重要な注意事項

### 実施環境

- ✅ **ステージング環境のみで実施**
- ❌ **本番環境では絶対に実施しない**
- ✅ 事前に関係者全員に通知
- ✅ テスト範囲を明確に定義
- ✅ スコープ外へのアクセスを禁止

---

## 🎯 ペネトレーションテストの種類

### 1. ブラックボックステスト

**特徴**: システム内部情報なし（外部攻撃者視点）

**実施内容**:
- ポートスキャン
- ディレクトリ探索
- 公開情報からの情報収集

---

### 2. ホワイトボックステスト

**特徴**: システム内部情報あり（内部脅威視点）

**実施内容**:
- ソースコードレビュー
- 設定ファイルのチェック
- 権限昇格テスト

---

### 3. グレーボックステスト

**特徴**: 部分的な内部情報あり（現実的なシナリオ）

---

## 🔍 ペネトレーションテスト項目

### 1. 認証・認可テスト

#### テストケース

```bash
# 1. ブルートフォース攻撃
hydra -l admin -P /usr/share/wordlists/rockyou.txt \
  https://staging.example.com http-post-form "/login:username=^USER^&password=^PASS^:F=incorrect"

# 期待結果: レート制限により攻撃が阻止される
```

**対策**:

```python
# ✅ レート制限の実装
from flask_limiter import Limiter

limiter = Limiter(app, key_func=lambda: request.remote_addr)

@app.route('/login', methods=['POST'])
@limiter.limit("5 per minute")  # 1分間に5回まで
def login():
    # ログイン処理
    pass
```

---

#### セッション管理テスト

```bash
# 2. セッション固定攻撃
# ログイン前後でセッションIDが変わるか確認

curl -c cookies.txt https://staging.example.com/login
# Set-Cookie: session_id=abc123

curl -b cookies.txt -X POST https://staging.example.com/login \
  -d "username=test&password=test"
# Set-Cookie: session_id=xyz789  # ✅ 変更されるべき
```

**対策**:

```python
# ✅ ログイン時にセッションを再生成
from flask import session

@app.route('/login', methods=['POST'])
def login():
    if authenticate(username, password):
        session.clear()  # 古いセッションをクリア
        session['user_id'] = user.id
        session.permanent = True
```

---

### 2. 入力検証テスト

#### SQLインジェクション

```bash
# SQLインジェクション攻撃
curl "https://staging.example.com/api/users?id=1' OR '1'='1"

# 期待結果: エラーまたは空のレスポンス（全ユーザー情報が返されない）
```

#### XSS（クロスサイトスクリプティング）

```bash
# XSS攻撃
curl -X POST https://staging.example.com/api/comments \
  -d '{"text": "<script>alert(\"XSS\")</script>"}'

# 期待結果: エスケープされた文字列が保存される
# <: &lt;, >: &gt;
```

---

### 3. 認可テスト（権限昇格）

```bash
# 一般ユーザーで管理者APIにアクセス
curl -H "Authorization: Bearer USER_TOKEN" \
  https://staging.example.com/api/admin/users

# 期待結果: HTTP 403 Forbidden
```

**対策**:

```python
# ✅ ロールベースのアクセス制御
from functools import wraps

def require_role(role):
    def decorator(f):
        @wraps(f)
        def decorated_function(*args, **kwargs):
            if not current_user.has_role(role):
                abort(403)
            return f(*args, **kwargs)
        return decorated_function
    return decorator

@app.route('/api/admin/users')
@require_role('admin')  # 管理者のみアクセス可能
def admin_users():
    return jsonify(users)
```

---

### 4. IDOR（Insecure Direct Object Reference）

```bash
# 他のユーザーのデータにアクセス
curl -H "Authorization: Bearer USER1_TOKEN" \
  https://staging.example.com/api/users/2/profile

# 期待結果: HTTP 403 Forbidden（自分以外のデータにアクセスできない）
```

**対策**:

```python
# ✅ 所有者チェック
@app.route('/api/users/<int:user_id>/profile')
@login_required
def get_profile(user_id):
    if current_user.id != user_id:
        abort(403)  # 自分以外のプロフィールにアクセス禁止
    return jsonify(get_user_profile(user_id))
```

---

## 🛠️ ペネトレーションテストツール

### OWASP ZAP（自動化）

```bash
# ZAPでアクティブスキャン
docker run -t owasp/zap2docker-stable zap-full-scan.py \
  -t https://staging.example.com \
  -r zap-pentest-report.html
```

---

### Burp Suite（手動テスト）

**使用方法**:
1. Burp Suiteのプロキシを起動
2. ブラウザのプロキシ設定を変更
3. アプリケーションを操作
4. リクエストをインターセプト・改ざん

**テストシナリオ**:
- パラメータ改ざん
- HTTPヘッダー改ざん
- セッショントークンの検証

---

### Metasploit（高度なテスト）

```bash
# Metasploit起動
msfconsole

# 脆弱性スキャン
use auxiliary/scanner/http/http_version
set RHOSTS staging.example.com
run
```

---

## 📊 ペネトレーションテスト報告書

### レポート構成

```markdown
# ペネトレーションテスト報告書

## 1. テスト概要
- テスト期間: 2025-10-15 ~ 2025-10-19
- テスト環境: ステージング環境
- テスト範囲: Webアプリケーション全体

## 2. 発見した脆弱性

### 2.1 Critical
なし

### 2.2 High
#### H-001: セッション固定攻撃
- **説明**: ログイン前後でセッションIDが変更されない
- **影響**: セッションハイジャックのリスク
- **再現手順**:
  1. ログイン前にCookieを取得
  2. ログイン後も同じCookieが有効
- **推奨対策**: ログイン時にsession.clear()を実行

### 2.3 Medium
#### M-001: セキュリティヘッダー不足
- **説明**: X-Frame-Options ヘッダーが設定されていない
- **影響**: クリックジャッキング攻撃のリスク
- **推奨対策**: X-Frame-Options: DENY を設定

### 2.4 Low
なし

## 3. 修正推奨事項
- High: 1週間以内に修正
- Medium: 2週間以内に修正
```

---

## 🎯 ペネトレーションテスト チェックリスト

- ✅ 認証・認可
  - [ ] ブルートフォース攻撃対策
  - [ ] セッション管理
  - [ ] 多要素認証
- ✅ 入力検証
  - [ ] SQLインジェクション対策
  - [ ] XSS対策
  - [ ] CSRF対策
- ✅ アクセス制御
  - [ ] IDOR対策
  - [ ] 権限昇格対策
  - [ ] API認可
- ✅ セキュリティヘッダー
  - [ ] X-Frame-Options
  - [ ] Content-Security-Policy
  - [ ] Strict-Transport-Security
- ✅ エラーハンドリング
  - [ ] エラーメッセージの適切な処理
  - [ ] スタックトレースの非表示

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
