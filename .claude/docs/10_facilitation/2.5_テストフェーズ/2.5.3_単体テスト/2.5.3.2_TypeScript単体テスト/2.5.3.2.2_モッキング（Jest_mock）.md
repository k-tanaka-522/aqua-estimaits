# 2.5.3.2.2 モッキング（Jest mock）

## 目的

外部依存をモックして、ユニットテストを高速化・独立化します。

---

## 🔄 モッキングパターン

### jest.fn() - 関数モック

```typescript
import { jest } from '@jest/globals';

describe('UserService', () => {
  it('should call repository with correct arguments', async () => {
    // Arrange
    const mockFind = jest.fn().mockResolvedValue({ id: 1, name: 'Test' });
    const mockRepo = { findById: mockFind };
    const service = new UserService(mockRepo);

    // Act
    const result = await service.getUser(1);

    // Assert
    expect(mockFind).toHaveBeenCalledWith(1);
    expect(mockFind).toHaveBeenCalledTimes(1);
    expect(result.name).toBe('Test');
  });
});
```

### jest.mock() - モジュールモック

```typescript
// ファイル全体をモック
jest.mock('../repositories/userRepository');

import { UserRepository } from '../repositories/userRepository';
import { UserService } from './userService';

describe('UserService', () => {
  it('should get user from repository', async () => {
    // Arrange
    const mockUser = { id: 1, name: 'Test' };
    (UserRepository.prototype.findById as jest.Mock).mockResolvedValue(mockUser);

    const service = new UserService(new UserRepository());

    // Act
    const result = await service.getUser(1);

    // Assert
    expect(result).toEqual(mockUser);
  });
});
```

### jest.spyOn() - スパイ

```typescript
describe('UserService', () => {
  it('should log when user not found', async () => {
    // Arrange
    const consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation();
    const mockRepo = { findById: jest.fn().mockResolvedValue(null) };
    const service = new UserService(mockRepo);

    // Act
    await service.getUser(999);

    // Assert
    expect(consoleErrorSpy).toHaveBeenCalledWith('User not found: 999');

    // Cleanup
    consoleErrorSpy.mockRestore();
  });
});
```

### モックのリセット

```typescript
describe('UserService', () => {
  let mockRepo: jest.Mocked<UserRepository>;

  beforeEach(() => {
    mockRepo = {
      findById: jest.fn(),
      save: jest.fn(),
    } as any;
  });

  afterEach(() => {
    jest.clearAllMocks(); // モックの呼び出し履歴をクリア
  });

  it('test 1', async () => { /* ... */ });
  it('test 2', async () => { /* ... */ });
});
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
