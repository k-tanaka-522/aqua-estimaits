# 2.5.3.3.4 C#単体テストGood_Bad_Example集

## 目的

C#テストのよくある間違いと推奨パターンを示します。

---

## ❌ Bad Example

```csharp
// ❌ AAAパターンなし
[Fact]
public async Task GetUser()
{
    var result = await _service.GetUserAsync(1);
    Assert.NotNull(result);
}

// ❌ モックなし（実DB接続）
[Fact]
public async Task GetUser_ReturnsUser()
{
    var service = new UserService(new UserRepository()); // ❌ 実DB
    var result = await service.GetUserAsync(1);
}

// ❌ 検証不足
[Fact]
public async Task CreateUser_Succeeds()
{
    var result = await _service.CreateUserAsync(new User());
    Assert.NotNull(result); // これだけ？ ❌
}

// ❌ テストメソッド名が不明確
[Fact]
public async Task Test1() // ❌ 何をテストしているか不明
{
    var result = await _service.GetUserAsync(1);
    Assert.NotNull(result);
}
```

---

## ✅ Good Example

```csharp
// ✅ AAAパターン + モック + 明確な命名 + 完全な検証
public class UserServiceTests : IDisposable
{
    private readonly Mock<IUserRepository> _mockRepo;
    private readonly Mock<ILogger<UserService>> _mockLogger;
    private readonly UserService _service;

    public UserServiceTests()
    {
        _mockRepo = new Mock<IUserRepository>();
        _mockLogger = new Mock<ILogger<UserService>>();
        _service = new UserService(_mockRepo.Object, _mockLogger.Object);
    }

    [Fact]
    public async Task GetUserAsync_WhenUserExists_ReturnsUser()
    {
        // Arrange
        var userId = 1;
        var expectedUser = new User
        {
            Id = userId,
            Name = "Test User",
            Email = "test@example.com",
            CreatedAt = DateTime.UtcNow
        };

        _mockRepo
            .Setup(repo => repo.FindByIdAsync(userId))
            .ReturnsAsync(expectedUser);

        // Act
        var result = await _service.GetUserAsync(userId);

        // Assert
        Assert.NotNull(result);
        Assert.Equal(expectedUser.Id, result.Id);
        Assert.Equal(expectedUser.Name, result.Name);
        Assert.Equal(expectedUser.Email, result.Email);

        _mockRepo.Verify(
            repo => repo.FindByIdAsync(userId),
            Times.Once
        );
    }

    [Fact]
    public async Task GetUserAsync_WhenUserNotFound_ThrowsNotFoundException()
    {
        // Arrange
        var userId = 999;
        _mockRepo
            .Setup(repo => repo.FindByIdAsync(userId))
            .ReturnsAsync((User?)null);

        // Act & Assert
        var exception = await Assert.ThrowsAsync<NotFoundException>(
            () => _service.GetUserAsync(userId)
        );

        Assert.Equal($"User with ID {userId} not found", exception.Message);
        _mockRepo.Verify(repo => repo.FindByIdAsync(userId), Times.Once);
    }

    [Fact]
    public async Task GetUserAsync_WhenRepositoryThrows_PropagatesException()
    {
        // Arrange
        var userId = 1;
        var dbException = new DatabaseException("Connection timeout");

        _mockRepo
            .Setup(repo => repo.FindByIdAsync(userId))
            .ThrowsAsync(dbException);

        // Act & Assert
        var exception = await Assert.ThrowsAsync<DatabaseException>(
            () => _service.GetUserAsync(userId)
        );

        Assert.Equal("Connection timeout", exception.Message);

        _mockLogger.Verify(
            logger => logger.Log(
                LogLevel.Error,
                It.IsAny<EventId>(),
                It.IsAny<It.IsAnyType>(),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()
            ),
            Times.Once
        );
    }

    [Theory]
    [InlineData(null, false)]
    [InlineData("", false)]
    [InlineData("Test", true)]
    public async Task CreateUserAsync_WithVariousNames_ReturnsExpectedResult(
        string? name,
        bool shouldSucceed)
    {
        // Arrange
        var user = new User { Name = name, Email = "test@example.com" };

        if (shouldSucceed)
        {
            _mockRepo
                .Setup(repo => repo.SaveAsync(It.IsAny<User>()))
                .ReturnsAsync(user);
        }

        // Act & Assert
        if (shouldSucceed)
        {
            var result = await _service.CreateUserAsync(user);
            Assert.NotNull(result);
            Assert.Equal(name, result.Name);
        }
        else
        {
            await Assert.ThrowsAsync<ValidationException>(
                () => _service.CreateUserAsync(user)
            );
        }
    }

    public void Dispose()
    {
        // クリーンアップ処理
        _mockRepo.Reset();
        _mockLogger.Reset();
    }
}
```

### ✅ テストの構成管理

```csharp
// ✅ IClassFixture - テストクラス間でセットアップを共有
public class DatabaseFixture : IDisposable
{
    public DbContext Context { get; }

    public DatabaseFixture()
    {
        Context = CreateInMemoryDatabase();
    }

    public void Dispose()
    {
        Context.Dispose();
    }
}

public class UserServiceIntegrationTests : IClassFixture<DatabaseFixture>
{
    private readonly DatabaseFixture _fixture;

    public UserServiceIntegrationTests(DatabaseFixture fixture)
    {
        _fixture = fixture;
    }

    [Fact]
    public async Task Test1() { /* ... */ }
}
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
