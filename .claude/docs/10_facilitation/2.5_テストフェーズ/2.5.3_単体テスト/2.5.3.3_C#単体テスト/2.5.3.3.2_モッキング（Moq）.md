# 2.5.3.3.2 モッキング（Moq）

## 目的

外部依存をMoqでモックして、ユニットテストを独立化します。

---

## 🔄 Moqモッキングパターン

### 基本的なモック

```csharp
using Moq;
using Xunit;

public class UserServiceTests
{
    [Fact]
    public async Task GetUser_WhenUserExists_ReturnsUser()
    {
        // Arrange
        var mockRepo = new Mock<IUserRepository>();
        var expectedUser = new User { Id = 1, Name = "Test User" };

        mockRepo
            .Setup(repo => repo.FindByIdAsync(1))
            .ReturnsAsync(expectedUser);

        var service = new UserService(mockRepo.Object);

        // Act
        var result = await service.GetUserAsync(1);

        // Assert
        Assert.Equal(expectedUser.Id, result.Id);
        mockRepo.Verify(repo => repo.FindByIdAsync(1), Times.Once);
    }
}
```

### It.IsAny - 引数の柔軟なマッチング

```csharp
[Fact]
public async Task CreateUser_WithValidUser_SavesUser()
{
    // Arrange
    var mockRepo = new Mock<IUserRepository>();
    mockRepo
        .Setup(repo => repo.SaveAsync(It.IsAny<User>()))
        .ReturnsAsync((User user) => user);

    var service = new UserService(mockRepo.Object);
    var newUser = new User { Name = "New User", Email = "new@example.com" };

    // Act
    var result = await service.CreateUserAsync(newUser);

    // Assert
    Assert.NotNull(result);
    mockRepo.Verify(
        repo => repo.SaveAsync(It.Is<User>(u => u.Name == "New User")),
        Times.Once
    );
}
```

### 例外のモック

```csharp
[Fact]
public async Task GetUser_WhenRepositoryFails_ThrowsException()
{
    // Arrange
    var mockRepo = new Mock<IUserRepository>();
    mockRepo
        .Setup(repo => repo.FindByIdAsync(It.IsAny<int>()))
        .ThrowsAsync(new DatabaseException("Connection failed"));

    var service = new UserService(mockRepo.Object);

    // Act & Assert
    await Assert.ThrowsAsync<DatabaseException>(
        () => service.GetUserAsync(1)
    );
}
```

### 複数メソッドのモック

```csharp
[Fact]
public async Task UpdateUser_WhenUserExists_UpdatesAndSaves()
{
    // Arrange
    var mockRepo = new Mock<IUserRepository>();
    var existingUser = new User { Id = 1, Name = "Old Name" };

    mockRepo.Setup(repo => repo.FindByIdAsync(1))
            .ReturnsAsync(existingUser);
    mockRepo.Setup(repo => repo.SaveAsync(It.IsAny<User>()))
            .ReturnsAsync((User user) => user);

    var service = new UserService(mockRepo.Object);

    // Act
    var result = await service.UpdateUserAsync(1, "New Name");

    // Assert
    Assert.Equal("New Name", result.Name);
    mockRepo.Verify(repo => repo.FindByIdAsync(1), Times.Once);
    mockRepo.Verify(repo => repo.SaveAsync(It.IsAny<User>()), Times.Once);
}
```

### コールバックの検証

```csharp
[Fact]
public async Task DeleteUser_WhenCalled_PassesCorrectId()
{
    // Arrange
    var mockRepo = new Mock<IUserRepository>();
    int capturedId = 0;

    mockRepo
        .Setup(repo => repo.DeleteAsync(It.IsAny<int>()))
        .Callback<int>(id => capturedId = id)
        .ReturnsAsync(true);

    var service = new UserService(mockRepo.Object);

    // Act
    await service.DeleteUserAsync(123);

    // Assert
    Assert.Equal(123, capturedId);
}
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
