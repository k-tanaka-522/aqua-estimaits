# 2.5.3.4.2 モッキング（testify）

## 目的

testify/mockを使って外部依存をモックします。

---

## 🔄 testifyモッキングパターン

### testifyインストール

```bash
go get github.com/stretchr/testify/mock
go get github.com/stretchr/testify/assert
```

### モックインターフェース定義

```go
package mocks

import (
    "github.com/stretchr/testify/mock"
    "myapp/domain"
)

// UserRepository モックの定義
type MockUserRepository struct {
    mock.Mock
}

func (m *MockUserRepository) FindByID(id int) (*domain.User, error) {
    args := m.Called(id)
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*domain.User), args.Error(1)
}

func (m *MockUserRepository) Save(user *domain.User) error {
    args := m.Called(user)
    return args.Error(0)
}
```

### モックの使用

```go
package service

import (
    "testing"
    "myapp/mocks"
    "myapp/domain"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
)

func TestGetUser_WhenUserExists_ReturnsUser(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)
    expectedUser := &domain.User{ID: 1, Name: "Test User"}

    mockRepo.On("FindByID", 1).Return(expectedUser, nil)

    service := NewUserService(mockRepo)

    // Act
    result, err := service.GetUser(1)

    // Assert
    assert.NoError(t, err)
    assert.Equal(t, expectedUser.ID, result.ID)
    assert.Equal(t, expectedUser.Name, result.Name)

    mockRepo.AssertExpectations(t)
    mockRepo.AssertCalled(t, "FindByID", 1)
}
```

### エラーケースのモック

```go
func TestGetUser_WhenUserNotFound_ReturnsError(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)
    mockRepo.On("FindByID", 999).Return(nil, domain.ErrNotFound)

    service := NewUserService(mockRepo)

    // Act
    result, err := service.GetUser(999)

    // Assert
    assert.Error(t, err)
    assert.Nil(t, result)
    assert.Equal(t, domain.ErrNotFound, err)

    mockRepo.AssertExpectations(t)
}
```

### 引数のマッチング

```go
func TestCreateUser_WithValidUser_SavesUser(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)

    // 任意のUserオブジェクトでマッチング
    mockRepo.On("Save", mock.AnythingOfType("*domain.User")).Return(nil)

    service := NewUserService(mockRepo)
    newUser := &domain.User{Name: "New User", Email: "new@example.com"}

    // Act
    err := service.CreateUser(newUser)

    // Assert
    assert.NoError(t, err)
    mockRepo.AssertExpectations(t)

    // 特定の条件でマッチング
    mockRepo.AssertCalled(t, "Save", mock.MatchedBy(func(u *domain.User) bool {
        return u.Name == "New User"
    }))
}
```

### 複数回呼び出しのモック

```go
func TestGetUsers_WhenMultipleCalls_ReturnsUsers(t *testing.T) {
    // Arrange
    mockRepo := new(mocks.MockUserRepository)

    user1 := &domain.User{ID: 1, Name: "User1"}
    user2 := &domain.User{ID: 2, Name: "User2"}

    mockRepo.On("FindByID", 1).Return(user1, nil).Once()
    mockRepo.On("FindByID", 2).Return(user2, nil).Once()

    service := NewUserService(mockRepo)

    // Act
    result1, _ := service.GetUser(1)
    result2, _ := service.GetUser(2)

    // Assert
    assert.Equal(t, "User1", result1.Name)
    assert.Equal(t, "User2", result2.Name)

    mockRepo.AssertNumberOfCalls(t, "FindByID", 2)
}
```

### モックのリセット

```go
func TestUserService_MultipleTests(t *testing.T) {
    mockRepo := new(mocks.MockUserRepository)

    t.Run("test 1", func(t *testing.T) {
        mockRepo.On("FindByID", 1).Return(&domain.User{ID: 1}, nil).Once()
        // ... テスト実行
        mockRepo.AssertExpectations(t)
    })

    // テスト間でモックをリセット
    mockRepo.ExpectedCalls = nil
    mockRepo.Calls = nil

    t.Run("test 2", func(t *testing.T) {
        mockRepo.On("FindByID", 2).Return(&domain.User{ID: 2}, nil).Once()
        // ... テスト実行
        mockRepo.AssertExpectations(t)
    })
}
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
