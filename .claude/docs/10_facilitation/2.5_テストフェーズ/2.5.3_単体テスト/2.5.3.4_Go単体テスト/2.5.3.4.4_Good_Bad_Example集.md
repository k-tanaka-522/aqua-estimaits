# 2.5.3.4.4 Go単体テストGood_Bad_Example集

## 目的

Goテストのよくある間違いと推奨パターンを示します。

---

## ❌ Bad Example

```go
// ❌ AAAパターンなし
func TestGetUser(t *testing.T) {
    result, _ := GetUser(1)
    if result.Name != "Test" {
        t.Fail()
    }
}

// ❌ エラーチェックなし
func TestGetUser(t *testing.T) {
    result, _ := GetUser(1) // ❌ エラー無視
    if result.Name != "Test" {
        t.Fail()
    }
}

// ❌ モックなし（実DB接続）
func TestGetUser(t *testing.T) {
    repo := NewUserRepository() // ❌ 実DB
    service := NewUserService(repo)
    result, _ := service.GetUser(1)
}

// ❌ テーブルドリブンテストの誤用
func TestValidateEmail(t *testing.T) {
    tests := []struct {
        email string
        valid bool
    }{
        {"test@example.com", true},
        {"invalid", false},
    }

    for _, tt := range tests {
        // ❌ t.Runがない
        if ValidateEmail(tt.email) != tt.valid {
            t.Fail()
        }
    }
}

// ❌ 不明確なエラーメッセージ
func TestGetUser(t *testing.T) {
    result, err := GetUser(1)
    if err != nil {
        t.Error("error") // ❌ 何のエラーか不明
    }
}
```

---

## ✅ Good Example

```go
package service

import (
    "testing"
    "myapp/domain"
    "myapp/mocks"
    "github.com/stretchr/testify/assert"
    "github.com/stretchr/testify/mock"
)

// ✅ AAAパターン + モック + 明確な命名 + 完全な検証
func TestUserService_GetUser(t *testing.T) {
    t.Run("success - user exists", func(t *testing.T) {
        // Arrange
        mockRepo := new(mocks.MockUserRepository)
        expectedUser := &domain.User{
            ID:    1,
            Name:  "Test User",
            Email: "test@example.com",
        }

        mockRepo.On("FindByID", 1).Return(expectedUser, nil)
        service := NewUserService(mockRepo)

        // Act
        result, err := service.GetUser(1)

        // Assert
        assert.NoError(t, err)
        assert.NotNil(t, result)
        assert.Equal(t, expectedUser.ID, result.ID)
        assert.Equal(t, expectedUser.Name, result.Name)
        assert.Equal(t, expectedUser.Email, result.Email)

        mockRepo.AssertExpectations(t)
        mockRepo.AssertCalled(t, "FindByID", 1)
    })

    t.Run("error - user not found", func(t *testing.T) {
        // Arrange
        mockRepo := new(mocks.MockUserRepository)
        mockRepo.On("FindByID", 999).Return(nil, domain.ErrNotFound)

        service := NewUserService(mockRepo)

        // Act
        result, err := service.GetUser(999)

        // Assert
        assert.Error(t, err)
        assert.Nil(t, result)
        assert.Equal(t, domain.ErrNotFound, err)

        mockRepo.AssertExpectations(t)
    })

    t.Run("error - repository failure", func(t *testing.T) {
        // Arrange
        mockRepo := new(mocks.MockUserRepository)
        dbError := domain.NewDatabaseError("connection timeout")

        mockRepo.On("FindByID", 1).Return(nil, dbError)
        service := NewUserService(mockRepo)

        // Act
        result, err := service.GetUser(1)

        // Assert
        assert.Error(t, err)
        assert.Nil(t, result)
        assert.Contains(t, err.Error(), "connection timeout")

        mockRepo.AssertExpectations(t)
    })
}

// ✅ テーブルドリブンテスト（正しい実装）
func TestValidateEmail(t *testing.T) {
    tests := []struct {
        name     string
        email    string
        expected bool
        errMsg   string
    }{
        {
            name:     "valid email",
            email:    "test@example.com",
            expected: true,
            errMsg:   "",
        },
        {
            name:     "invalid - missing @",
            email:    "invalid",
            expected: false,
            errMsg:   "should be rejected",
        },
        {
            name:     "invalid - empty",
            email:    "",
            expected: false,
            errMsg:   "should be rejected",
        },
        {
            name:     "invalid - incomplete domain",
            email:    "test@",
            expected: false,
            errMsg:   "should be rejected",
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Act
            result := ValidateEmail(tt.email)

            // Assert
            assert.Equal(t, tt.expected, result,
                "ValidateEmail(%q) = %v, want %v. %s",
                tt.email, result, tt.expected, tt.errMsg)
        })
    }
}

// ✅ Helper関数の活用
func TestUserService_CreateUser(t *testing.T) {
    tests := []struct {
        name      string
        user      *domain.User
        setupMock func(*mocks.MockUserRepository)
        wantErr   bool
        errType   error
    }{
        {
            name: "success",
            user: &domain.User{Name: "New User", Email: "new@example.com"},
            setupMock: func(m *mocks.MockUserRepository) {
                m.On("Save", mock.AnythingOfType("*domain.User")).Return(nil)
            },
            wantErr: false,
        },
        {
            name: "error - empty name",
            user: &domain.User{Name: "", Email: "test@example.com"},
            setupMock: func(m *mocks.MockUserRepository) {
                // モック不要（バリデーションで失敗）
            },
            wantErr: true,
            errType: domain.ErrValidation,
        },
        {
            name: "error - repository failure",
            user: &domain.User{Name: "Test", Email: "test@example.com"},
            setupMock: func(m *mocks.MockUserRepository) {
                m.On("Save", mock.AnythingOfType("*domain.User")).
                    Return(domain.NewDatabaseError("save failed"))
            },
            wantErr: true,
        },
    }

    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            // Arrange
            mockRepo := new(mocks.MockUserRepository)
            tt.setupMock(mockRepo)

            service := NewUserService(mockRepo)

            // Act
            err := service.CreateUser(tt.user)

            // Assert
            if tt.wantErr {
                assert.Error(t, err)
                if tt.errType != nil {
                    assert.ErrorIs(t, err, tt.errType)
                }
            } else {
                assert.NoError(t, err)
            }

            mockRepo.AssertExpectations(t)
        })
    }
}

// ✅ セットアップとクリーンアップ
func TestUserService_Integration(t *testing.T) {
    // テスト全体のセットアップ
    mockRepo := new(mocks.MockUserRepository)
    service := NewUserService(mockRepo)

    // クリーンアップを確実に実行
    t.Cleanup(func() {
        mockRepo.AssertExpectations(t)
    })

    t.Run("multiple operations", func(t *testing.T) {
        mockRepo.On("FindByID", 1).Return(&domain.User{ID: 1}, nil).Once()
        mockRepo.On("Save", mock.Anything).Return(nil).Once()

        user, _ := service.GetUser(1)
        user.Name = "Updated"
        _ = service.UpdateUser(user)
    })
}
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
