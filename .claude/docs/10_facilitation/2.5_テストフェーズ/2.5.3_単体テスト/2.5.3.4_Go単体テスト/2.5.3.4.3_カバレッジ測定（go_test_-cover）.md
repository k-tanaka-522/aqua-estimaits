# 2.5.3.4.3 カバレッジ測定（go test -cover）

## 目的

テストカバレッジを測定し、80%以上を達成します。

---

## 📊 カバレッジ測定

### 基本的なカバレッジ測定

```bash
# カバレッジ付きでテスト実行
go test -cover ./...

# 出力例
ok      myapp/service   0.123s  coverage: 85.7% of statements
```

### カバレッジレポート生成

```bash
# カバレッジプロファイルを生成
go test -coverprofile=coverage.out ./...

# カバレッジをHTML形式で表示
go tool cover -html=coverage.out -o coverage.html

# ブラウザで開く
open coverage.html  # macOS
start coverage.html # Windows
```

### 詳細なカバレッジ情報

```bash
# 関数ごとのカバレッジを表示
go tool cover -func=coverage.out

# 出力例
myapp/service/user.go:15:  GetUser         85.7%
myapp/service/user.go:30:  CreateUser      90.0%
myapp/service/user.go:45:  UpdateUser      75.0%
total:                     (statements)    85.7%
```

### パッケージごとのカバレッジ

```bash
# すべてのパッケージのカバレッジ
go test -cover ./...

# 特定のパッケージのみ
go test -cover ./service/...
```

### カバレッジモード

```bash
# set: 行がカバーされたかどうか（デフォルト）
go test -covermode=set -coverprofile=coverage.out ./...

# count: 行が何回実行されたか
go test -covermode=count -coverprofile=coverage.out ./...

# atomic: 並行処理に対応したcount
go test -covermode=atomic -coverprofile=coverage.out ./...
```

### Makefileでの自動化

```makefile
.PHONY: test coverage

test:
	go test -v ./...

coverage:
	go test -coverprofile=coverage.out ./...
	go tool cover -html=coverage.out -o coverage.html
	@echo "Coverage report generated: coverage.html"

coverage-check:
	@go test -coverprofile=coverage.out ./... > /dev/null
	@go tool cover -func=coverage.out | grep total | \
	awk '{print $$3}' | sed 's/%//' | \
	awk '{if ($$1 < 80) {print "Coverage " $$1 "% is below 80%"; exit 1} else {print "Coverage " $$1 "% OK"}}'
```

### CIでのカバレッジチェック

```yaml
# GitHub Actions
name: Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Run tests with coverage
        run: go test -coverprofile=coverage.out ./...

      - name: Check coverage threshold
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          if (( $(echo "$coverage < 80" | bc -l) )); then
            echo "Coverage $coverage% is below 80%"
            exit 1
          fi
          echo "Coverage $coverage% OK"
```

### 目標

- ✅ **カバレッジ80%以上**
- ✅ 重要な業務ロジック: 90%以上
- ✅ エラーハンドリング分岐も網羅

### カバレッジ除外

```go
// テストファイルやmainファイルを除外
go test -coverprofile=coverage.out -coverpkg=./... $(go list ./... | grep -v /mocks | grep -v /cmd)
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
