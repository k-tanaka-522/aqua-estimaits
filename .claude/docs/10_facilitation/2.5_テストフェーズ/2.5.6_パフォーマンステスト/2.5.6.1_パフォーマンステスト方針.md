# 2.5.6.1 パフォーマンステスト方針

## 目的

システムの性能要件を満たすことを検証します。

---

## 📊 パフォーマンステストの種類

### 1. ロードテスト（Load Testing）

**目的**: 通常の負荷下でのシステム動作確認

**実施内容**:
- 想定される同時ユーザー数でのテスト
- レスポンスタイム測定
- スループット測定

**目標値例**:
- 同時ユーザー数: 1,000人
- レスポンスタイム: 95%ile < 500ms
- エラー率: < 0.1%

---

### 2. ストレステスト（Stress Testing）

**目的**: システムの限界を把握

**実施内容**:
- 負荷を段階的に増加
- システムが破綻する点を特定
- 破綻後の回復を確認

**シナリオ**:
```
ユーザー数: 100 → 500 → 1,000 → 2,000 → 5,000
```

---

### 3. スパイクテスト（Spike Testing）

**目的**: 急激な負荷増加への対応確認

**実施内容**:
- 短時間で大量のリクエスト
- オートスケーリングの動作確認
- キューイング機能の確認

**シナリオ**:
```
0→1,000users（10秒） → 0（10秒） → 1,000users（10秒）
```

---

### 4. 耐久テスト（Endurance Testing / Soak Testing）

**目的**: 長時間稼働時の安定性確認

**実施内容**:
- 24時間以上の連続実行
- メモリリーク検出
- リソース枯渇の確認

---

## 🔧 使用ツール

### k6（推奨）

**メリット**:
- ✅ JavaScriptでシナリオ記述
- ✅ CLI実行、CI統合が容易
- ✅ 詳細なメトリクス出力

```javascript
// k6-load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '2m', target: 100 },  // Ramp-up
    { duration: '5m', target: 100 },  // Stay at 100
    { duration: '2m', target: 0 },    // Ramp-down
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],  // 95%のリクエストが500ms以内
    http_req_failed: ['rate<0.01'],    // エラー率1%未満
  },
};

export default function () {
  const res = http.get('http://test.example.com/api/users');
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  sleep(1);
}
```

実行:
```bash
k6 run k6-load-test.js
```

---

### Locust（代替）

**メリット**:
- ✅ Pythonでシナリオ記述
- ✅ Web UIで結果確認
- ✅ 分散実行対応

```python
# locustfile.py
from locust import HttpUser, task, between

class WebsiteUser(HttpUser):
    wait_time = between(1, 3)

    @task(3)
    def get_users(self):
        self.client.get("/api/users")

    @task(1)
    def get_user_detail(self):
        self.client.get("/api/users/123")
```

実行:
```bash
locust -f locustfile.py --host=http://test.example.com
```

---

### JMeter（代替）

**メリット**:
- ✅ GUI付き
- ✅ 豊富なプラグイン
- ✅ レポート機能

---

## 📋 実施項目

### 1. APIロードテスト

```javascript
// k6 example: GET /api/users
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  vus: 1000,  // 1,000 virtual users
  duration: '5m',
};

export default function () {
  const res = http.get('http://api.example.com/users');
  check(res, {
    'is status 200': (r) => r.status === 200,
  });
}
```

### 2. DBクエリパフォーマンス

```python
# Locust example: DB-heavy endpoint
from locust import HttpUser, task

class DatabaseUser(HttpUser):
    @task
    def search_users(self):
        self.client.get("/api/users/search?q=test")  # DB検索
```

### 3. ファイルアップロード負荷テスト

```javascript
// k6 example: File upload
import http from 'k6/http';

export default function () {
  const binFile = open('test-image.jpg', 'b');
  const data = {
    file: http.file(binFile, 'test-image.jpg'),
  };
  http.post('http://api.example.com/upload', data);
}
```

---

## 🎯 目標品質基準

| 項目 | 目標値 |
|------|--------|
| レスポンスタイム（95%ile） | < 500ms |
| レスポンスタイム（99%ile） | < 1,000ms |
| スループット | > 1,000 req/sec |
| エラー率 | < 0.1% |
| CPU使用率 | < 70% |
| メモリ使用率 | < 80% |

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
