# 2.5.6.5 スケーラビリティテスト

## 目的

システムのスケールアウト能力を検証します。

---

## 📈 スケーラビリティテストの種類

### 1. 垂直スケーリング（Scale Up）

**内容**: サーバーのスペックアップ

```
t3.medium (2vCPU, 4GB) → t3.large (2vCPU, 8GB) → t3.xlarge (4vCPU, 16GB)
```

**検証項目**:
- ✅ CPU/メモリ増加に応じたスループット向上
- ✅ リソース使用効率

---

### 2. 水平スケーリング（Scale Out）

**内容**: サーバー台数の増加

```
1台 → 2台 → 4台 → 8台
```

**検証項目**:
- ✅ インスタンス数増加に応じたスループット向上（線形性）
- ✅ ロードバランサーの動作
- ✅ セッション管理（ステートレス性）

---

## 🧪 水平スケーリングテスト

### シナリオ

```javascript
// k6 スケールアウトテスト
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  scenarios: {
    scale_test: {
      executor: 'ramping-vus',
      stages: [
        { duration: '5m', target: 1000 },   // 1,000 users
        { duration: '10m', target: 1000 },  // 維持
        { duration: '5m', target: 2000 },   // 2,000 users
        { duration: '10m', target: 2000 },  // 維持
        { duration: '5m', target: 0 },
      ],
    },
  },
  thresholds: {
    http_req_duration: ['p(95)<500'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('https://api.example.com/users');
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

### 期待される結果

| インスタンス数 | スループット | レスポンスタイム（p95） |
|----------------|--------------|-------------------------|
| 1台            | 500 req/s    | 200ms                   |
| 2台            | 1,000 req/s  | 200ms（✅ 線形）        |
| 4台            | 2,000 req/s  | 200ms（✅ 線形）        |
| 8台            | 4,000 req/s  | 200ms（✅ 線形）        |

**理想**: インスタンス数に比例してスループットが向上

---

## ⚙️ オートスケーリングテスト

### AWS ECS Auto Scaling

```yaml
# ecs-task-definition.yml
AutoScalingTarget:
  Type: AWS::ApplicationAutoScaling::ScalableTarget
  Properties:
    MaxCapacity: 10
    MinCapacity: 2
    ResourceId: !Sub service/${ECSCluster}/myapp-service
    ScalableDimension: ecs:service:DesiredCount
    ServiceNamespace: ecs

AutoScalingPolicy:
  Type: AWS::ApplicationAutoScaling::ScalingPolicy
  Properties:
    PolicyName: cpu-scaling-policy
    PolicyType: TargetTrackingScaling
    TargetTrackingScalingPolicyConfiguration:
      TargetValue: 70.0  # CPU 70%でスケールアウト
      PredefinedMetricSpecification:
        PredefinedMetricType: ECSServiceAverageCPUUtilization
```

### テストシナリオ

1. **負荷なし**: タスク数 2
2. **負荷増加**: CPU 70%超過 → タスク数増加（2 → 4 → 6）
3. **負荷維持**: タスク数維持
4. **負荷減少**: CPU 70%未満 → タスク数減少（6 → 4 → 2）

### 検証項目

```javascript
// k6: オートスケーリングテスト
export let options = {
  stages: [
    { duration: '5m', target: 100 },   // 低負荷（タスク2台）
    { duration: '2m', target: 500 },   // 急増（スケールアウト開始）
    { duration: '10m', target: 500 },  // 維持（タスク増加完了）
    { duration: '2m', target: 100 },   // 急減（スケールイン開始）
    { duration: '5m', target: 100 },   // 低負荷（タスク2台に戻る）
  ],
};
```

**確認事項**:
- ✅ スケールアウト時にエラーが発生しないか
- ✅ スケールアウト完了までの時間（目標: 3分以内）
- ✅ スケールイン時に既存リクエストが中断されないか

---

## 🗄️ データベーススケーラビリティ

### リードレプリカのスケールアウト

```
Primary DB (Write) → Read Replica 1 (Read)
                   → Read Replica 2 (Read)
                   → Read Replica 3 (Read)
```

#### テスト

```python
# Python: リードレプリカ分散テスト
from sqlalchemy import create_engine
from random import choice

primary_engine = create_engine('postgresql://primary:5432/db')
replica_engines = [
    create_engine('postgresql://replica1:5432/db'),
    create_engine('postgresql://replica2:5432/db'),
    create_engine('postgresql://replica3:5432/db'),
]

def read_query():
    # リードレプリカをランダム選択
    engine = choice(replica_engines)
    with engine.connect() as conn:
        result = conn.execute("SELECT * FROM users LIMIT 100")
        return result.fetchall()

def write_query(user_data):
    # プライマリDBに書き込み
    with primary_engine.connect() as conn:
        conn.execute("INSERT INTO users (name, email) VALUES (:name, :email)", user_data)
```

**検証項目**:
- ✅ リードレプリカ数増加に応じた読み取りスループット向上
- ✅ レプリケーション遅延（目標: 1秒以内）

---

## 📊 スケーラビリティ指標

### スピードアップ比

```
スピードアップ比 = 1台のスループット × インスタンス数 / N台のスループット

理想: 1.0（完全に線形）
現実: 0.8-0.9（オーバーヘッドあり）
```

### スケーラビリティ効率

```
効率 = (N台のスループット / 1台のスループット) / N × 100%

理想: 100%
現実: 80-90%
```

---

## 🎯 目標値

| 項目 | 目標 |
|------|------|
| スケールアウト効率 | 80%以上 |
| オートスケール発動時間 | 3分以内 |
| スケールイン時のエラー率 | 0% |
| リードレプリカのレプリケーション遅延 | 1秒以内 |

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
