# 2.5.6.2 k6負荷テスト

## 目的

k6を使ってAPIの負荷テストを実施します。

---

## 🚀 k6セットアップ

### インストール

```bash
# macOS
brew install k6

# Windows
choco install k6

# Linux
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update
sudo apt-get install k6
```

---

## 📋 k6テストシナリオ

### 1. シンプルなロードテスト

```javascript
// tests/load/simple-load.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export let options = {
  vus: 100,        // 100 virtual users
  duration: '5m',  // 5分間実行
};

export default function () {
  const res = http.get('https://api.example.com/users');

  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });

  sleep(1);  // 1秒待機
}
```

実行:
```bash
k6 run tests/load/simple-load.js
```

---

### 2. ステージベースのロードテスト

```javascript
// tests/load/staged-load.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  stages: [
    { duration: '1m', target: 50 },   // Ramp-up: 0→50 users (1分)
    { duration: '3m', target: 50 },   // Stay: 50 users (3分)
    { duration: '1m', target: 100 },  // Ramp-up: 50→100 users (1分)
    { duration: '3m', target: 100 },  // Stay: 100 users (3分)
    { duration: '1m', target: 0 },    // Ramp-down: 100→0 users (1分)
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.01'],
  },
};

export default function () {
  const res = http.get('https://api.example.com/users');
  check(res, { 'status is 200': (r) => r.status === 200 });
}
```

---

### 3. ストレステスト

```javascript
// tests/load/stress-test.js
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '2m', target: 100 },   // 通常負荷
    { duration: '5m', target: 100 },
    { duration: '2m', target: 200 },   // 2倍の負荷
    { duration: '5m', target: 200 },
    { duration: '2m', target: 300 },   // 3倍の負荷
    { duration: '5m', target: 300 },
    { duration: '2m', target: 400 },   // 4倍の負荷（破綻ポイント探索）
    { duration: '5m', target: 400 },
    { duration: '5m', target: 0 },     // 回復確認
  ],
};

export default function () {
  http.get('https://api.example.com/users');
}
```

---

### 4. スパイクテスト

```javascript
// tests/load/spike-test.js
import http from 'k6/http';

export let options = {
  stages: [
    { duration: '10s', target: 1000 },  // 急激な増加
    { duration: '1m', target: 1000 },   // 維持
    { duration: '10s', target: 0 },     // 急激な減少
    { duration: '1m', target: 0 },      // 休止
    { duration: '10s', target: 1000 },  // 再度スパイク
    { duration: '1m', target: 1000 },
    { duration: '10s', target: 0 },
  ],
};

export default function () {
  http.get('https://api.example.com/users');
}
```

---

### 5. 複数エンドポイントのテスト

```javascript
// tests/load/multi-endpoint.js
import http from 'k6/http';
import { check, group } from 'k6';

export let options = {
  vus: 100,
  duration: '5m',
};

export default function () {
  group('User APIs', function () {
    // GET /users
    let res1 = http.get('https://api.example.com/users');
    check(res1, { 'GET /users status 200': (r) => r.status === 200 });

    // GET /users/:id
    let res2 = http.get('https://api.example.com/users/123');
    check(res2, { 'GET /users/:id status 200': (r) => r.status === 200 });

    // POST /users
    let payload = JSON.stringify({ name: 'Test User', email: 'test@example.com' });
    let params = { headers: { 'Content-Type': 'application/json' } };
    let res3 = http.post('https://api.example.com/users', payload, params);
    check(res3, { 'POST /users status 201': (r) => r.status === 201 });
  });
}
```

---

### 6. 認証付きAPIテスト

```javascript
// tests/load/auth-test.js
import http from 'k6/http';
import { check } from 'k6';

export let options = {
  vus: 50,
  duration: '3m',
};

export function setup() {
  // セットアップ: ログインしてトークン取得
  const loginRes = http.post('https://api.example.com/auth/login', {
    email: 'test@example.com',
    password: 'password123',
  });
  return { token: loginRes.json('token') };
}

export default function (data) {
  const params = {
    headers: {
      'Authorization': `Bearer ${data.token}`,
      'Content-Type': 'application/json',
    },
  };

  const res = http.get('https://api.example.com/users/me', params);
  check(res, { 'authenticated request OK': (r) => r.status === 200 });
}
```

---

## 📊 結果の確認

### コンソール出力

```bash
k6 run tests/load/simple-load.js

# 出力例:
     data_received..................: 8.2 MB  136 kB/s
     data_sent......................: 1.1 MB  18 kB/s
     http_req_blocked...............: avg=1.2ms    min=0s       med=0s      max=234ms
     http_req_duration..............: avg=145.3ms  min=102.3ms  med=142ms   max=987ms
     http_req_failed................: 0.00%   ✓ 0        ✗ 6000
     http_reqs......................: 6000    100/s
     vus............................: 100     min=100    max=100
```

### JSON出力

```bash
k6 run --out json=results.json tests/load/simple-load.js
```

### HTML レポート

```bash
# k6-reporter を使用
npm install -g k6-reporter
k6 run --out json=results.json tests/load/simple-load.js
k6-reporter results.json
```

---

## 🎯 閾値の設定

```javascript
export let options = {
  thresholds: {
    // 95%のリクエストが500ms以内
    http_req_duration: ['p(95)<500'],

    // 99%のリクエストが1秒以内
    'http_req_duration{expected_response:true}': ['p(99)<1000'],

    // エラー率1%未満
    http_req_failed: ['rate<0.01'],

    // 1秒あたり100リクエスト以上
    http_reqs: ['rate>100'],
  },
};
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
