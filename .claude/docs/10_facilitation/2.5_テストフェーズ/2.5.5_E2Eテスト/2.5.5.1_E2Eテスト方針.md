# 2.5.5.1 E2Eテスト方針

## 目的

エンドユーザー視点で、システム全体の動作を検証します。

---

## 🎭 E2Eテストの範囲

### テスト対象

1. **Webアプリケーション**
   - ブラウザ操作（Playwright、Cypress）
   - ユーザーシナリオ
   - クロスブラウザテスト

2. **APIエンドポイント**
   - 複数API呼び出しのシーケンス
   - エンドツーエンドのデータフロー

3. **モバイルアプリ**
   - Appium等を使用したモバイルテスト（該当する場合）

---

## 📋 E2Eテスト戦略

### 1. テストピラミッドにおける位置づけ

```
        🔺 E2E (少ない)
       /   \
      /     \  統合テスト (中程度)
     /       \
    /_________\ 単体テスト (多い)
```

**E2Eテストは最小限に**:
- 実行コストが高い（時間、リソース）
- メンテナンスコストが高い
- 重要なユーザーシナリオのみを対象

### 2. 対象シナリオの選定

✅ **テストすべきシナリオ**:
- クリティカルパス（ユーザー登録、ログイン、決済等）
- 複数画面をまたがる業務フロー
- 主要なユースケース

❌ **テストしないシナリオ**:
- 細かいバリデーション（単体テストで対応）
- エッジケース（統合テストで対応）
- すべての組み合わせ（組み合わせ爆発を避ける）

---

## 🔧 使用ツール

### Playwright（推奨）

**メリット**:
- ✅ 複数ブラウザ対応（Chromium、Firefox、WebKit）
- ✅ 自動待機機能
- ✅ スクリーンショット・動画記録
- ✅ TypeScript完全サポート

```typescript
// playwright.config.ts
import { defineConfig } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  use: {
    baseURL: 'http://localhost:3000',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    { name: 'chromium', use: { browserName: 'chromium' } },
    { name: 'firefox', use: { browserName: 'firefox' } },
  ],
});
```

### Cypress（代替）

**メリット**:
- ✅ リアルタイムリロード
- ✅ タイムトラベルデバッグ
- ✅ 直感的なAPI

```javascript
// cypress.config.js
module.exports = {
  e2e: {
    baseUrl: 'http://localhost:3000',
    video: true,
    screenshotOnRunFailure: true,
  },
};
```

---

## 📊 実施項目

### 1. 主要ユーザーシナリオ

```typescript
// Playwright example
test('ユーザー登録からログインまでのフロー', async ({ page }) => {
  // 1. ユーザー登録
  await page.goto('/signup');
  await page.fill('[name="email"]', 'test@example.com');
  await page.fill('[name="password"]', 'SecurePass123');
  await page.click('button[type="submit"]');

  // 2. 登録完了確認
  await expect(page.locator('.success-message')).toContainText('登録が完了しました');

  // 3. ログイン
  await page.goto('/login');
  await page.fill('[name="email"]', 'test@example.com');
  await page.fill('[name="password"]', 'SecurePass123');
  await page.click('button[type="submit"]');

  // 4. ダッシュボード表示確認
  await expect(page).toHaveURL('/dashboard');
  await expect(page.locator('h1')).toContainText('ダッシュボード');
});
```

### 2. データフローの検証

```typescript
test('商品購入フロー', async ({ page }) => {
  // ログイン → 商品選択 → カート追加 → チェックアウト → 決済 → 完了
  await page.goto('/login');
  await login(page);

  await page.goto('/products/123');
  await page.click('button:has-text("カートに追加")');

  await page.goto('/cart');
  await expect(page.locator('.cart-item')).toHaveCount(1);

  await page.click('button:has-text("チェックアウト")');
  await fillPaymentInfo(page);
  await page.click('button:has-text("購入確定")');

  await expect(page.locator('.order-complete')).toBeVisible();
});
```

---

## 🎯 目標品質基準

- ✅ クリティカルパス: 100%カバー
- ✅ 主要ユースケース: 80%以上カバー
- ✅ クロスブラウザテスト（Chrome、Firefox、Safari）
- ✅ E2Eテスト実行時間: 10分以内（CI実行時）

---

## 🔄 CI/CD統合

```yaml
# GitHub Actions
name: E2E Tests
on: [push, pull_request]
jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npm run test:e2e

      - uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: playwright-screenshots
          path: test-results/
```

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
