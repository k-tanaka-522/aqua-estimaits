# 2.5.4.2 API-DB結合テスト

## 目的

APIエンドポイントからデータベースまでの一連の処理を検証します。

---

## 🔗 API-DB結合テストパターン

### Python (FastAPI + pytest)

```python
import pytest
from httpx import AsyncClient
from sqlalchemy.ext.asyncio import AsyncSession
from myapp.main import app
from myapp.models import User
from myapp.database import get_db, async_engine
from sqlalchemy import select

@pytest.fixture
async def client():
    async with AsyncClient(app=app, base_url="http://test") as client:
        yield client

@pytest.fixture
async def db_session():
    # テスト用DBセッション
    async with AsyncSession(async_engine) as session:
        yield session
        await session.rollback()  # テスト後にロールバック

@pytest.mark.asyncio
async def test_create_user_endpoint_integration(client, db_session):
    # Arrange
    payload = {
        "name": "Integration Test User",
        "email": "integration@example.com"
    }

    # Act - APIリクエスト
    response = await client.post("/api/users", json=payload)

    # Assert - APIレスポンス
    assert response.status_code == 201
    data = response.json()
    assert data["name"] == "Integration Test User"
    assert "id" in data

    # Assert - DB検証
    stmt = select(User).where(User.email == "integration@example.com")
    result = await db_session.execute(stmt)
    user = result.scalar_one_or_none()

    assert user is not None
    assert user.name == "Integration Test User"
    assert user.email == "integration@example.com"

@pytest.mark.asyncio
async def test_get_user_endpoint_integration(client, db_session):
    # Arrange - DBに事前データ投入
    user = User(name="Existing User", email="existing@example.com")
    db_session.add(user)
    await db_session.commit()
    await db_session.refresh(user)

    # Act
    response = await client.get(f"/api/users/{user.id}")

    # Assert
    assert response.status_code == 200
    data = response.json()
    assert data["id"] == user.id
    assert data["name"] == "Existing User"
```

---

### TypeScript (Express + Jest + TypeORM)

```typescript
import request from 'supertest';
import { DataSource } from 'typeorm';
import { app } from '../src/app';
import { User } from '../src/entities/User';
import { createTestConnection } from './testUtils';

describe('User API Integration Tests', () => {
  let connection: DataSource;

  beforeAll(async () => {
    connection = await createTestConnection();
  });

  afterAll(async () => {
    await connection.destroy();
  });

  beforeEach(async () => {
    // 各テスト前にテーブルクリア
    await connection.getRepository(User).clear();
  });

  it('POST /api/users - should create user in database', async () => {
    // Arrange
    const payload = {
      name: 'Integration Test User',
      email: 'integration@example.com',
    };

    // Act
    const response = await request(app)
      .post('/api/users')
      .send(payload)
      .expect(201);

    // Assert - APIレスポンス
    expect(response.body.name).toBe('Integration Test User');
    expect(response.body.id).toBeDefined();

    // Assert - DB検証
    const userRepo = connection.getRepository(User);
    const user = await userRepo.findOne({
      where: { email: 'integration@example.com' },
    });

    expect(user).toBeDefined();
    expect(user!.name).toBe('Integration Test User');
  });

  it('GET /api/users/:id - should retrieve user from database', async () => {
    // Arrange - DBに事前データ投入
    const userRepo = connection.getRepository(User);
    const user = userRepo.create({
      name: 'Existing User',
      email: 'existing@example.com',
    });
    await userRepo.save(user);

    // Act
    const response = await request(app)
      .get(`/api/users/${user.id}`)
      .expect(200);

    // Assert
    expect(response.body.id).toBe(user.id);
    expect(response.body.name).toBe('Existing User');
  });

  it('PUT /api/users/:id - should update user in database', async () => {
    // Arrange
    const userRepo = connection.getRepository(User);
    const user = await userRepo.save({
      name: 'Old Name',
      email: 'old@example.com',
    });

    // Act
    const response = await request(app)
      .put(`/api/users/${user.id}`)
      .send({ name: 'New Name' })
      .expect(200);

    // Assert - APIレスポンス
    expect(response.body.name).toBe('New Name');

    // Assert - DB検証
    const updated = await userRepo.findOneBy({ id: user.id });
    expect(updated!.name).toBe('New Name');
  });

  it('DELETE /api/users/:id - should delete user from database', async () => {
    // Arrange
    const userRepo = connection.getRepository(User);
    const user = await userRepo.save({
      name: 'To Delete',
      email: 'delete@example.com',
    });

    // Act
    await request(app)
      .delete(`/api/users/${user.id}`)
      .expect(204);

    // Assert - DB検証（削除されていること）
    const deleted = await userRepo.findOneBy({ id: user.id });
    expect(deleted).toBeNull();
  });
});
```

---

### C# (ASP.NET Core + xUnit + EF Core)

```csharp
using Microsoft.AspNetCore.Mvc.Testing;
using Microsoft.EntityFrameworkCore;
using Xunit;

public class UserApiIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    private readonly WebApplicationFactory<Program> _factory;
    private readonly HttpClient _client;
    private readonly AppDbContext _dbContext;

    public UserApiIntegrationTests(WebApplicationFactory<Program> factory)
    {
        _factory = factory.WithWebHostBuilder(builder =>
        {
            builder.ConfigureServices(services =>
            {
                // テスト用のInMemory DBを使用
                services.AddDbContext<AppDbContext>(options =>
                    options.UseInMemoryDatabase("TestDb"));
            });
        });

        _client = _factory.CreateClient();
        _dbContext = _factory.Services.GetRequiredService<AppDbContext>();
    }

    [Fact]
    public async Task CreateUser_ShouldSaveToDatabase()
    {
        // Arrange
        var payload = new { Name = "Integration Test", Email = "integration@example.com" };

        // Act
        var response = await _client.PostAsJsonAsync("/api/users", payload);

        // Assert - APIレスポンス
        response.EnsureSuccessStatusCode();
        var user = await response.Content.ReadFromJsonAsync<UserDto>();
        Assert.NotNull(user);
        Assert.Equal("Integration Test", user.Name);

        // Assert - DB検証
        var dbUser = await _dbContext.Users
            .FirstOrDefaultAsync(u => u.Email == "integration@example.com");
        Assert.NotNull(dbUser);
        Assert.Equal("Integration Test", dbUser.Name);
    }
}
```

---

## 🎯 検証項目

- ✅ APIリクエスト → ビジネスロジック → DB保存の一連の流れ
- ✅ DBからの取得 → ビジネスロジック → APIレスポンスの流れ
- ✅ トランザクション管理
- ✅ エラーハンドリング（DB接続エラー等）

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
