# 2.5.4.3 外部システム連携テスト

## 目的

外部API、AWSサービス、メッセージキュー等との連携を検証します。

---

## 🌐 外部システム連携テスト戦略

### 1. 外部API連携テスト

**方針**: Wiremock、nock等でモック化

#### Python (httpx + respx)

```python
import pytest
import respx
from httpx import AsyncClient
from myapp.services.external_api import WeatherService

@pytest.mark.asyncio
@respx.mock
async def test_get_weather_from_external_api():
    # Arrange
    mock_response = {
        "city": "Tokyo",
        "temperature": 25.5,
        "condition": "Sunny"
    }

    # 外部APIをモック
    respx.get("https://api.weather.example.com/forecast?city=Tokyo").mock(
        return_value=Response(200, json=mock_response)
    )

    service = WeatherService()

    # Act
    result = await service.get_weather("Tokyo")

    # Assert
    assert result["city"] == "Tokyo"
    assert result["temperature"] == 25.5
```

#### TypeScript (nock)

```typescript
import nock from 'nock';
import { WeatherService } from '../src/services/weatherService';

describe('External API Integration Tests', () => {
  afterEach(() => {
    nock.cleanAll();
  });

  it('should fetch weather data from external API', async () => {
    // Arrange
    nock('https://api.weather.example.com')
      .get('/forecast')
      .query({ city: 'Tokyo' })
      .reply(200, {
        city: 'Tokyo',
        temperature: 25.5,
        condition: 'Sunny',
      });

    const service = new WeatherService();

    // Act
    const result = await service.getWeather('Tokyo');

    // Assert
    expect(result.city).toBe('Tokyo');
    expect(result.temperature).toBe(25.5);
  });

  it('should handle external API errors', async () => {
    // Arrange
    nock('https://api.weather.example.com')
      .get('/forecast')
      .query({ city: 'InvalidCity' })
      .reply(404, { error: 'City not found' });

    const service = new WeatherService();

    // Act & Assert
    await expect(service.getWeather('InvalidCity')).rejects.toThrow(
      'City not found'
    );
  });
});
```

---

### 2. AWS連携テスト（LocalStack使用）

#### LocalStack セットアップ

```yaml
# docker-compose.test.yml
version: '3.8'
services:
  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"
    environment:
      SERVICES: s3,sqs,sns,dynamodb
      DEFAULT_REGION: ap-northeast-1
      DATA_DIR: /tmp/localstack/data
    volumes:
      - ./localstack-init:/docker-entrypoint-initaws.d
```

#### S3連携テスト（Python）

```python
import pytest
import boto3
from moto import mock_s3
from myapp.services.s3_service import S3Service

@pytest.fixture
def s3_client():
    with mock_s3():
        s3 = boto3.client('s3', region_name='ap-northeast-1')
        s3.create_bucket(
            Bucket='test-bucket',
            CreateBucketConfiguration={'LocationConstraint': 'ap-northeast-1'}
        )
        yield s3

@pytest.mark.integration
def test_upload_file_to_s3(s3_client):
    # Arrange
    service = S3Service(s3_client)
    file_content = b"Test file content"
    file_key = "test/file.txt"

    # Act
    service.upload_file("test-bucket", file_key, file_content)

    # Assert
    response = s3_client.get_object(Bucket="test-bucket", Key=file_key)
    assert response['Body'].read() == file_content
```

#### SQS連携テスト（TypeScript）

```typescript
import { SQSClient, SendMessageCommand, ReceiveMessageCommand } from '@aws-sdk/client-sqs';
import { SQSService } from '../src/services/sqsService';

describe('SQS Integration Tests', () => {
  let sqsClient: SQSClient;
  let queueUrl: string;

  beforeAll(async () => {
    // LocalStackに接続
    sqsClient = new SQSClient({
      endpoint: 'http://localhost:4566',
      region: 'ap-northeast-1',
    });

    // テスト用キューを作成
    const createQueueCommand = new CreateQueueCommand({
      QueueName: 'test-queue',
    });
    const response = await sqsClient.send(createQueueCommand);
    queueUrl = response.QueueUrl!;
  });

  it('should send and receive message from SQS', async () => {
    // Arrange
    const service = new SQSService(sqsClient);
    const message = { userId: 123, action: 'CREATE' };

    // Act - メッセージ送信
    await service.sendMessage(queueUrl, message);

    // Assert - メッセージ受信
    const received = await service.receiveMessage(queueUrl);
    expect(received).toBeDefined();
    expect(JSON.parse(received!.Body!)).toEqual(message);
  });
});
```

---

### 3. メッセージキュー連携テスト（Redis）

```python
import pytest
import redis.asyncio as redis
from myapp.services.queue_service import QueueService

@pytest.fixture
async def redis_client():
    client = await redis.from_url("redis://localhost:6380")
    yield client
    await client.flushdb()
    await client.close()

@pytest.mark.asyncio
async def test_publish_and_consume_message(redis_client):
    # Arrange
    service = QueueService(redis_client)
    channel = "test-channel"
    message = {"event": "user.created", "userId": 123}

    # Act - メッセージ発行
    await service.publish(channel, message)

    # Assert - メッセージ受信
    pubsub = redis_client.pubsub()
    await pubsub.subscribe(channel)

    async for msg in pubsub.listen():
        if msg['type'] == 'message':
            data = json.loads(msg['data'])
            assert data["event"] == "user.created"
            assert data["userId"] == 123
            break
```

---

## 🎯 検証項目

- ✅ 外部API呼び出しとレスポンス処理
- ✅ 外部APIエラー時のリトライ・フォールバック
- ✅ AWSサービス（S3、SQS、SNS）との連携
- ✅ メッセージキューの送受信
- ✅ タイムアウト・リトライ処理

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
