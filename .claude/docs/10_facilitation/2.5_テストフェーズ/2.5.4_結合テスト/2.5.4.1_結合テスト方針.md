# 2.5.4.1 結合テスト方針

## 目的

複数コンポーネント間の連携を検証する結合テストの方針を定義します。

---

## 🔗 結合テストの範囲

### 対象とする連携

1. **API ⇔ ビジネスロジック**
   - APIエンドポイントからサービス層までの通信
   - リクエスト/レスポンスの変換
   - エラーハンドリング

2. **ビジネスロジック ⇔ データベース**
   - リポジトリ層のDB操作
   - トランザクション管理
   - データの永続化と取得

3. **外部システム連携**
   - 外部API呼び出し
   - メッセージキュー
   - S3、SNS、SQS等のAWSサービス

---

## 📋 テスト戦略

### 1. テスト環境

```yaml
# docker-compose.test.yml
version: '3.8'
services:
  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: testdb
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
    ports:
      - "5433:5432"

  redis:
    image: redis:7
    ports:
      - "6380:6379"

  localstack:  # AWSサービスモック
    image: localstack/localstack
    environment:
      SERVICES: s3,sqs,sns
    ports:
      - "4566:4566"
```

### 2. テストデータ管理

- **FixtureベースのDBシード**
- **トランザクションロールバック**（テスト間の独立性）
- **テストデータビルダー**パターン

### 3. モックの使い分け

| 対象 | 方針 | 理由 |
|------|------|------|
| DB | **実DB使用**（テストコンテナ） | 実際のSQL実行を検証 |
| 外部API | **モック使用** | 外部依存を排除、レスポンスを制御 |
| AWSサービス | **LocalStack使用** | 実環境に近い形で検証 |

---

## ✅ 実施項目

### API結合テスト

```python
# FastAPI example
@pytest.mark.integration
async def test_create_user_endpoint():
    # Arrange
    async with AsyncClient(app=app, base_url="http://test") as client:
        payload = {"name": "Test User", "email": "test@example.com"}

        # Act
        response = await client.post("/users", json=payload)

        # Assert
        assert response.status_code == 201
        data = response.json()
        assert data["name"] == "Test User"

        # DB確認
        user = await db.query(User).filter_by(email="test@example.com").first()
        assert user is not None
```

### DB結合テスト

```typescript
// TypeScript example
describe('UserRepository Integration Tests', () => {
  let connection: DataSource;

  beforeAll(async () => {
    connection = await createTestConnection();
  });

  afterAll(async () => {
    await connection.destroy();
  });

  it('should save and retrieve user from database', async () => {
    // Arrange
    const repo = connection.getRepository(User);
    const user = new User({ name: 'Test', email: 'test@example.com' });

    // Act
    await repo.save(user);
    const found = await repo.findOne({ where: { email: 'test@example.com' } });

    // Assert
    expect(found).toBeDefined();
    expect(found!.name).toBe('Test');
  });
});
```

---

## 🎯 目標品質基準

- ✅ 主要なAPI-DB連携パスを網羅
- ✅ エラーケース（DB接続失敗、トランザクション失敗）を検証
- ✅ 結合テストカバレッジ: 主要フロー80%以上

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
