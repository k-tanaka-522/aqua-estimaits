# 2.5.7.4 災害復旧テスト

## 目的

バックアップからの復旧手順を検証し、RPO/RTOを達成します。

---

## 📋 災害復旧の目標

### RPO (Recovery Point Objective)

**定義**: データ損失許容時間

**目標例**:
- クリティカルシステム: **RPO 5分** → 5分前の状態まで復旧
- 通常システム: **RPO 1時間**
- バッチ処理: **RPO 24時間**

---

### RTO (Recovery Time Objective)

**定義**: システム復旧目標時間

**目標例**:
- クリティカルシステム: **RTO 1時間**
- 通常システム: **RTO 4時間**
- バッチ処理: **RTO 24時間**

---

## 🗄️ データベース復旧テスト

### 1. RDSスナップショットからの復旧

#### バックアップ戦略

```yaml
# 自動バックアップ設定
BackupRetentionPeriod: 7  # 7日間保持
PreferredBackupWindow: "03:00-04:00"  # 深夜3-4時
```

#### 復旧手順

```bash
# 1. 最新のスナップショット確認
aws rds describe-db-snapshots \
  --db-instance-identifier myapp-db \
  --snapshot-type automated \
  --query 'DBSnapshots[0].{ID:DBSnapshotIdentifier,Time:SnapshotCreateTime}'

# 2. スナップショットから復元
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier myapp-db-restored \
  --db-snapshot-identifier rds:myapp-db-2025-10-19-03-00

# 3. 復元状況確認
aws rds describe-db-instances \
  --db-instance-identifier myapp-db-restored \
  --query 'DBInstances[0].DBInstanceStatus'

# 4. データ整合性確認
psql -h myapp-db-restored.xxxx.rds.amazonaws.com -U admin -d myapp -c "SELECT COUNT(*) FROM users;"
```

**検証項目**:
- ✅ 復元時間: 30分以内（目標RTO）
- ✅ データ整合性: レコード数、重要データの確認
- ✅ アプリケーション接続確認

---

### 2. ポイントインタイムリカバリ（PITR）

```bash
# 特定時刻（10:30）の状態に復元
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier myapp-db \
  --target-db-instance-identifier myapp-db-pitr \
  --restore-time 2025-10-19T10:30:00Z

# または、最新の復元可能時刻
aws rds restore-db-instance-to-point-in-time \
  --source-db-instance-identifier myapp-db \
  --target-db-instance-identifier myapp-db-pitr \
  --use-latest-restorable-time
```

**検証**:

```sql
-- 復元されたデータの確認
SELECT * FROM users WHERE created_at < '2025-10-19 10:30:00';

-- 10:30以降のデータがないことを確認
SELECT COUNT(*) FROM users WHERE created_at >= '2025-10-19 10:30:00';
-- 期待結果: 0
```

---

### 3. クロスリージョンバックアップからの復旧

```bash
# バックアップを別リージョン（us-west-2）にコピー
aws rds copy-db-snapshot \
  --source-db-snapshot-identifier arn:aws:rds:ap-northeast-1:123456789012:snapshot:myapp-snapshot \
  --target-db-snapshot-identifier myapp-snapshot-us-west-2 \
  --region us-west-2

# 別リージョンで復元
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier myapp-db-dr \
  --db-snapshot-identifier myapp-snapshot-us-west-2 \
  --region us-west-2
```

---

## 📦 S3データ復旧テスト

### バージョニング有効化

```bash
# S3バージョニング有効化
aws s3api put-bucket-versioning \
  --bucket myapp-data \
  --versioning-configuration Status=Enabled
```

### 削除データの復旧

```bash
# 削除されたオブジェクトのバージョン確認
aws s3api list-object-versions \
  --bucket myapp-data \
  --prefix important-file.csv

# 特定バージョンを復元
aws s3api copy-object \
  --bucket myapp-data \
  --copy-source myapp-data/important-file.csv?versionId=abc123 \
  --key important-file-restored.csv
```

---

## 🔄 完全復旧テスト

### シナリオ: リージョン全体の障害

**前提**:
- プライマリリージョン: ap-northeast-1（東京）
- DRリージョン: ap-northeast-3（大阪）

**復旧手順**:

```bash
# 1. DRリージョンのRDSを起動（スナップショットから）
aws rds restore-db-instance-from-db-snapshot \
  --db-instance-identifier myapp-db-dr \
  --db-snapshot-identifier myapp-snapshot-dr \
  --region ap-northeast-3

# 2. DRリージョンのECSサービスを起動
aws ecs update-service \
  --cluster myapp-cluster-dr \
  --service myapp-service-dr \
  --desired-count 3 \
  --region ap-northeast-3

# 3. Route53のフェイルオーバー
aws route53 change-resource-record-sets \
  --hosted-zone-id Z1234567890ABC \
  --change-batch file://failover-dns.json

# failover-dns.json
{
  "Changes": [{
    "Action": "UPSERT",
    "ResourceRecordSet": {
      "Name": "api.example.com",
      "Type": "A",
      "AliasTarget": {
        "HostedZoneId": "Z1234567890XYZ",
        "DNSName": "myapp-alb-dr.ap-northeast-3.elb.amazonaws.com",
        "EvaluateTargetHealth": true
      }
    }
  }]
}
```

**検証項目**:
- ✅ 総復旧時間: 1時間以内（RTO目標）
- ✅ データロス: 5分以内（RPO目標）
- ✅ アプリケーション動作確認
- ✅ エンドツーエンドテスト

---

## 🧪 復旧テスト自動化

### 復旧テストスクリプト（Python）

```python
import boto3
import time
from datetime import datetime

class DisasterRecoveryTest:
    def __init__(self, region='ap-northeast-1', dr_region='ap-northeast-3'):
        self.rds = boto3.client('rds', region_name=region)
        self.rds_dr = boto3.client('rds', region_name=dr_region)
        self.start_time = None

    def run_recovery_test(self):
        print("=== 災害復旧テスト開始 ===")
        self.start_time = datetime.now()

        # 1. スナップショット作成
        snapshot_id = self.create_snapshot()

        # 2. DRリージョンにコピー
        dr_snapshot_id = self.copy_snapshot_to_dr(snapshot_id)

        # 3. DRリージョンで復元
        db_instance = self.restore_db_in_dr(dr_snapshot_id)

        # 4. データ整合性確認
        self.verify_data(db_instance)

        # 5. 結果レポート
        self.generate_report()

    def create_snapshot(self):
        print("1. スナップショット作成中...")
        response = self.rds.create_db_snapshot(
            DBSnapshotIdentifier=f'dr-test-{int(time.time())}',
            DBInstanceIdentifier='myapp-db'
        )
        snapshot_id = response['DBSnapshot']['DBSnapshotIdentifier']

        # 完了まで待機
        waiter = self.rds.get_waiter('db_snapshot_completed')
        waiter.wait(DBSnapshotIdentifier=snapshot_id)
        print(f"✅ スナップショット作成完了: {snapshot_id}")
        return snapshot_id

    def copy_snapshot_to_dr(self, snapshot_id):
        print("2. DRリージョンにコピー中...")
        response = self.rds_dr.copy_db_snapshot(
            SourceDBSnapshotIdentifier=f'arn:aws:rds:ap-northeast-1:123456789012:snapshot:{snapshot_id}',
            TargetDBSnapshotIdentifier=f'{snapshot_id}-dr'
        )
        dr_snapshot_id = response['DBSnapshot']['DBSnapshotIdentifier']

        waiter = self.rds_dr.get_waiter('db_snapshot_completed')
        waiter.wait(DBSnapshotIdentifier=dr_snapshot_id)
        print(f"✅ コピー完了: {dr_snapshot_id}")
        return dr_snapshot_id

    def restore_db_in_dr(self, snapshot_id):
        print("3. DRリージョンでDB復元中...")
        response = self.rds_dr.restore_db_instance_from_db_snapshot(
            DBInstanceIdentifier=f'myapp-db-dr-test-{int(time.time())}',
            DBSnapshotIdentifier=snapshot_id
        )
        db_instance = response['DBInstance']['DBInstanceIdentifier']

        waiter = self.rds_dr.get_waiter('db_instance_available')
        waiter.wait(DBInstanceIdentifier=db_instance)
        print(f"✅ DB復元完了: {db_instance}")
        return db_instance

    def verify_data(self, db_instance):
        print("4. データ整合性確認...")
        # 実際にはpsycopg2等でDB接続して確認
        print("✅ データ整合性OK")

    def generate_report(self):
        end_time = datetime.now()
        duration = (end_time - self.start_time).total_seconds() / 60

        print("\n=== 災害復旧テスト結果 ===")
        print(f"総復旧時間: {duration:.2f}分")
        print(f"RTO目標: 60分 → {'✅ 達成' if duration < 60 else '❌ 未達成'}")
        print(f"データロス: 0件 → ✅ 達成")

# 実行
test = DisasterRecoveryTest()
test.run_recovery_test()
```

---

## 🎯 復旧テスト目標

| 項目 | 目標 | 検証方法 |
|------|------|----------|
| RTO | 1時間以内 | 復旧手順の実測 |
| RPO | 5分以内 | データタイムスタンプ確認 |
| データ整合性 | 100% | レコード数・重要データ確認 |
| 復旧テスト頻度 | 四半期に1回 | 定期実施 |

---

**作成日**: 2025-10-19
**重要度**: ⭐⭐⭐
